<!DOCTYPE html>
<html lang="en" data-required-role="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard — TheSafetyVerse</title>
    <!-- Auth Guard -->
    <style>body { visibility: hidden; opacity: 0; transition: opacity 0.3s; }</style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../auth/supabase-config.js"></script>
    <script src="../auth/auth-guard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #FFD700;
            --primary-dark: #E6C200;
            --primary-light: #FFF3B0;
            --secondary: #FF8C00;
            --secondary-dark: #E67A00;
            --bg-clay: #F5E6D3;
            --bg-clay-dark: #E8D5C0;
            --bg-clay-light: #FAF0E6;
            --text-dark: #1A1A1A;
            --text-medium: #444444;
            --text-light: #777777;
            --accent-black: #1A1A1A;
            --white: #FFFFFF;
            --success: #4CAF50;
            --success-dark: #388E3C;
            --error: #E53935;
            --info: #2196F3;
            --warning: #FF9800;
            --shadow-soft: 0 4px 15px rgba(0,0,0,0.08);
            --shadow-medium: 0 6px 25px rgba(0,0,0,0.12);
            --shadow-hard: 0 8px 35px rgba(0,0,0,0.18);
            --shadow-clay: 4px 4px 0px rgba(0,0,0,0.12), inset 0 2px 4px rgba(255,255,255,0.3);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-heading: 'Segoe UI', 'Arial Black', sans-serif;
            --font-body: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --sidebar-width: 260px;
        }

        /* ===== RESET ===== */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-body);
            background: var(--bg-clay);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Clay texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(139,90,43,0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139,90,43,0.02) 0%, transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(139,90,43,0.03) 0%, transparent 50%);
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--accent-black), #2A2A2A);
            border-bottom: 4px solid var(--primary);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            color: var(--white);
            font-family: var(--font-heading);
            font-size: 20px;
            font-weight: 900;
            text-decoration: none;
        }

        .header-logo em {
            color: var(--primary-dark);
            font-style: normal;
        }

        .admin-badge {
            background: var(--primary);
            color: var(--accent-black);
            font-size: 11px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-user {
            color: var(--white);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--accent-black);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .header-link {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 13px;
            transition: var(--transition);
        }

        .header-link:hover { color: var(--primary); }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--white);
            padding: 6px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: var(--error);
            border-color: var(--error);
        }

        /* ===== LAYOUT ===== */
        .app-layout {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 64px);
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--white);
            border-right: 1px solid var(--bg-clay-dark);
            box-shadow: 2px 0 15px rgba(0,0,0,0.05);
            padding: 24px 0;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .sidebar-section-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-light);
            padding: 0 24px;
            margin-bottom: 8px;
            margin-top: 16px;
        }

        .sidebar-section-label:first-child { margin-top: 0; }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            text-decoration: none;
            color: var(--text-medium);
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .sidebar-nav li a:hover {
            background: var(--bg-clay-light);
            color: var(--text-dark);
        }

        .sidebar-nav li a.active {
            background: var(--primary-light);
            color: var(--accent-black);
            border-left-color: var(--primary);
            font-weight: 700;
        }

        .sidebar-nav li a .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar-katie {
            padding: 20px 24px;
            margin-top: 24px;
            border-top: 1px solid var(--bg-clay-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-katie img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            object-position: center 20%;
            border: 2px solid var(--primary);
        }

        .sidebar-katie-text {
            font-size: 12px;
            color: var(--text-light);
            line-height: 1.4;
        }

        .sidebar-katie-text strong {
            color: var(--text-dark);
            display: block;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            max-width: 1200px;
        }

        .section { display: none; }
        .section.active { display: block; }

        .section-header {
            margin-bottom: 28px;
        }

        .section-header h1 {
            font-family: var(--font-heading);
            font-size: 26px;
            font-weight: 900;
            color: var(--accent-black);
            margin-bottom: 6px;
        }

        .section-header p {
            font-size: 14px;
            color: var(--text-light);
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            padding: 24px;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
        }

        .card-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        /* ===== CIPHER OVERVIEW GRID ===== */
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            text-align: center;
        }

        .stat-value {
            font-family: var(--font-heading);
            font-size: 42px;
            font-weight: 900;
            color: var(--accent-black);
            line-height: 1;
        }

        .stat-value.good { color: var(--success); }
        .stat-value.caution { color: var(--warning); }
        .stat-value.danger { color: var(--error); }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 6px;
            padding: 2px 10px;
            border-radius: 20px;
        }

        .stat-change.positive { background: #E8F5E9; color: var(--success-dark); }
        .stat-change.negative { background: #FFEBEE; color: var(--error); }
        .stat-change.neutral { background: #E3F2FD; color: var(--info); }

        .overview-charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .overview-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .chart-container {
            position: relative;
            width: 100%;
        }

        .chart-container.trend-chart { height: 280px; }
        .chart-container.bar-chart { height: 250px; }

        .compliance-ring-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 0;
        }

        .compliance-ring {
            position: relative;
            width: 180px;
            height: 180px;
        }

        .compliance-ring canvas { width: 180px !important; height: 180px !important; }

        .compliance-center-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .compliance-center-label .pct {
            font-family: var(--font-heading);
            font-size: 36px;
            font-weight: 900;
            color: var(--accent-black);
        }

        .compliance-center-label .label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== TABLES ===== */
        .table-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .table-toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 10px 16px;
            border: 2px solid var(--bg-clay-dark);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: var(--font-body);
            background: var(--white);
            transition: var(--transition);
            width: 260px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,215,0,0.15);
        }

        .filter-select {
            padding: 10px 14px;
            border: 2px solid var(--bg-clay-dark);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: var(--font-body);
            background: var(--white);
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--accent-black);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.15);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 4px 6px 0px rgba(0,0,0,0.18);
        }

        .btn-secondary {
            background: var(--bg-clay-light);
            color: var(--text-dark);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .btn-secondary:hover {
            background: var(--bg-clay-dark);
        }

        .btn-danger {
            background: var(--error);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #C62828;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 12px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table thead th {
            text-align: left;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            background: var(--bg-clay-light);
            border-bottom: 2px solid var(--bg-clay-dark);
        }

        .data-table thead th:first-child { border-radius: var(--radius-sm) 0 0 0; }
        .data-table thead th:last-child { border-radius: 0 var(--radius-sm) 0 0; }

        .data-table tbody tr {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: var(--transition);
        }

        .data-table tbody tr:hover { background: var(--bg-clay-light); }

        .data-table tbody td {
            padding: 14px 16px;
            vertical-align: middle;
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active { background: #E8F5E9; color: var(--success-dark); }
        .badge-inactive { background: #FFEBEE; color: var(--error); }
        .badge-admin { background: #E3F2FD; color: #1565C0; }
        .badge-user { background: var(--bg-clay-light); color: var(--text-medium); }
        .badge-open { background: #FFEBEE; color: var(--error); }
        .badge-in-progress { background: #FFF3E0; color: #E65100; }
        .badge-closed { background: #E8F5E9; color: var(--success-dark); }
        .badge-critical { background: #FFEBEE; color: var(--error); }
        .badge-major { background: #FFF3E0; color: #E65100; }
        .badge-minor { background: #E3F2FD; color: #1565C0; }
        .badge-on-track { background: #E8F5E9; color: var(--success-dark); }
        .badge-at-risk { background: #FFF3E0; color: #E65100; }
        .badge-overdue { background: #FFEBEE; color: var(--error); }

        /* ===== PROGRESS BARS ===== */
        .progress-bar-wrap {
            width: 100%;
            height: 8px;
            background: var(--bg-clay);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.6s ease;
        }

        .progress-bar-fill.complete {
            background: linear-gradient(90deg, var(--success), var(--success-dark));
        }

        /* ===== CERTIFICATION ALERTS ===== */
        .cert-alert-group {
            margin-bottom: 24px;
        }

        .cert-alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .cert-alert-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .cert-alert-dot.red { background: var(--error); }
        .cert-alert-dot.orange { background: var(--warning); }
        .cert-alert-dot.yellow { background: #FDD835; }

        .cert-alert-header h3 {
            font-size: 15px;
            font-weight: 700;
        }

        .cert-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
            margin-bottom: 10px;
            border-left: 4px solid transparent;
            transition: var(--transition);
        }

        .cert-card:hover { box-shadow: var(--shadow-medium); }
        .cert-card.urgent { border-left-color: var(--error); }
        .cert-card.warning { border-left-color: var(--warning); }
        .cert-card.caution { border-left-color: #FDD835; }

        .cert-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .cert-info .name { font-weight: 600; font-size: 14px; }
        .cert-info .type { font-size: 13px; color: var(--text-light); }

        .cert-expiry {
            text-align: right;
        }

        .cert-expiry .date { font-size: 13px; color: var(--text-medium); }
        .cert-expiry .days {
            font-size: 12px;
            font-weight: 700;
            margin-top: 2px;
        }

        .cert-expiry .days.red { color: var(--error); }
        .cert-expiry .days.orange { color: var(--warning); }
        .cert-expiry .days.yellow { color: #F9A825; }

        /* ===== ACTION BUTTONS IN TABLE ===== */
        .action-btns {
            display: flex;
            gap: 6px;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open { display: flex; }

        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-hard);
            width: 90%;
            max-width: 520px;
            padding: 32px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            font-family: var(--font-heading);
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--bg-clay-dark);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: var(--font-body);
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,215,0,0.15);
        }

        .form-group textarea { resize: vertical; min-height: 80px; }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 24px;
        }

        /* ===== LOADING & TOAST ===== */
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .loading-spinner::before {
            content: '';
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-clay-dark);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 80px;
            right: 24px;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            color: var(--white);
            font-size: 14px;
            font-weight: 600;
            z-index: 300;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .toast.success { background: var(--success-dark); }
        .toast.error { background: var(--error); }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-light);
            font-size: 14px;
        }

        .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .overview-stats { grid-template-columns: 1fr 1fr 1fr; }
            .overview-charts { grid-template-columns: 1fr; }
            .overview-bottom { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
                position: fixed;
                top: 64px;
                left: 0;
                width: 100%;
                height: calc(100vh - 64px);
                z-index: 150;
                box-shadow: var(--shadow-hard);
            }

            .sidebar.open { display: block; }

            .mobile-menu-btn { display: block; }

            .main-content { padding: 20px 16px; }

            .overview-stats { grid-template-columns: 1fr; }

            .header-user span { display: none; }

            .header-link { display: none; }

            .table-toolbar { flex-direction: column; align-items: stretch; }
            .table-toolbar-left { flex-direction: column; }
            .search-input { width: 100%; }

            .data-table { font-size: 13px; }
            .data-table thead th,
            .data-table tbody td { padding: 10px 10px; }

            /* Hide less critical columns on mobile */
            .hide-mobile { display: none; }
        }

        @media (max-width: 480px) {
            .header-logo { font-size: 17px; }
            .admin-badge { font-size: 10px; padding: 2px 8px; }
            .section-header h1 { font-size: 22px; }
            .stat-value { font-size: 32px; }
        }

        /* ===== MOBILE BOTTOM NAV ===== */
        .mobile-bottom-nav {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--white);
                border-top: 2px solid var(--bg-clay-dark);
                box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
                z-index: 100;
            }

            .mobile-bottom-nav a {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
                padding: 8px 4px;
                text-decoration: none;
                color: var(--text-light);
                font-size: 10px;
                font-weight: 600;
                transition: var(--transition);
            }

            .mobile-bottom-nav a .nav-icon { font-size: 20px; }

            .mobile-bottom-nav a.active {
                color: var(--accent-black);
                background: var(--primary-light);
            }

            .sidebar { display: none !important; }

            .main-content { padding-bottom: 80px; }
        }
    </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="header">
    <div class="header-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()" aria-label="Menu">&#9776;</button>
        <a href="#" class="header-logo"><em>The</em>Safety<em>Verse</em></a>
        <span class="admin-badge">Admin</span>
    </div>
    <div class="header-right">
        <a href="../user-dashboard/index.html" class="header-link">User Dashboard</a>
        <div class="header-user">
            <div class="header-user-avatar" id="adminAvatar">KM</div>
            <span id="adminUserName">Katie Mead</span>
        </div>
        <a href="#" class="logout-btn" onclick="event.preventDefault();getSafetyVerseSupabase().auth.signOut().then(function(){localStorage.clear();window.location.href='../login.html';});">Logout</a>
    </div>
</header>

<!-- ===== APP LAYOUT ===== -->
<div class="app-layout">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <p class="sidebar-section-label">Main Menu</p>
        <ul class="sidebar-nav">
            <li><a href="#" class="active" data-tab="overview"><span class="nav-icon">&#128202;</span> CIPHER Overview</a></li>
            <li><a href="#" data-tab="users"><span class="nav-icon">&#128101;</span> User Management</a></li>
            <li><a href="#" data-tab="modules"><span class="nav-icon">&#128218;</span> Module Tracking</a></li>
            <li><a href="#" data-tab="corrective"><span class="nav-icon">&#128221;</span> Corrective Actions</a></li>
            <li><a href="#" data-tab="certs"><span class="nav-icon">&#128276;</span> Cert Expiry Alerts</a></li>
        </ul>
        <p class="sidebar-section-label">Links</p>
        <ul class="sidebar-nav">
            <li><a href="../user-dashboard/index.html"><span class="nav-icon">&#127968;</span> User Dashboard</a></li>
            <li><a href="../lessons/index.html"><span class="nav-icon">&#128218;</span> Lessons Hub</a></li>
        </ul>
        <div class="sidebar-katie">
            <img src="../user-dashboard/katie.png" alt="Katie" onerror="this.style.display='none'">
            <div class="sidebar-katie-text">
                <strong>Katie — AI Safety Coach</strong>
                Keeping your team safe, every day.
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">

        <!-- ===== 1. CIPHER OVERVIEW ===== -->
        <section class="section active" id="section-overview">
            <div class="section-header">
                <h1>CIPHER Overview</h1>
                <p>Key safety metrics at a glance — powered by your incident data.</p>
            </div>

            <div class="overview-stats">
                <div class="card stat-card">
                    <div class="card-title">TRIR</div>
                    <div class="stat-value" id="trir-value">—</div>
                    <div id="trir-subtitle" style="font-size:11px;color:var(--text-light);margin-top:6px;">(Recordable Incidents &times; 200,000) / Hours Worked</div>
                </div>
                <div class="card stat-card">
                    <div class="card-title">Incidents This Month</div>
                    <div class="stat-value" id="incident-count">—</div>
                    <div class="stat-change neutral" id="incident-change">Loading...</div>
                </div>
                <div class="card stat-card">
                    <div class="card-title">Compliance Posture</div>
                    <div class="compliance-ring-wrap">
                        <div class="compliance-ring">
                            <canvas id="complianceChart"></canvas>
                            <div class="compliance-center-label">
                                <div class="pct">87%</div>
                                <div class="label">Compliant</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="overview-charts">
                <div class="card">
                    <div class="card-title">Trend Movement — Incidents (Last 12 Months)</div>
                    <div class="chart-container trend-chart">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Root Cause Patterns</div>
                    <div class="chart-container bar-chart">
                        <canvas id="rootCauseChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== 2. USER MANAGEMENT ===== -->
        <section class="section" id="section-users">
            <div class="section-header">
                <h1>User Management</h1>
                <p>Manage employee accounts, roles, and access.</p>
            </div>

            <div class="card">
                <div class="table-toolbar">
                    <div class="table-toolbar-left">
                        <input type="text" class="search-input" id="userSearch" placeholder="Search employees..." oninput="filterUsers()">
                        <select class="filter-select" id="userRoleFilter" onchange="filterUsers()">
                            <option value="">All Roles</option>
                            <option value="Admin">Admin</option>
                            <option value="Manager">Manager</option>
                            <option value="User">User</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('inviteUserModal')">+ Invite User</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="data-table" id="userTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Site</th>
                                <th>Status</th>
                                <th class="hide-mobile">Date Added</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ===== 3. MODULE COMPLETION TRACKING ===== -->
        <section class="section" id="section-modules">
            <div class="section-header">
                <h1>Module Completion Tracking</h1>
                <p>Track employee progress across all 20 SafetyVerse training modules.</p>
            </div>

            <div class="card">
                <div class="table-toolbar">
                    <div class="table-toolbar-left">
                        <input type="text" class="search-input" id="moduleSearch" placeholder="Search employees..." oninput="filterModules()">
                        <select class="filter-select" id="moduleStatusFilter" onchange="filterModules()">
                            <option value="">All Statuses</option>
                            <option value="On Track">On Track</option>
                            <option value="At Risk">At Risk</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                        <select class="filter-select" id="moduleDeptFilter" onchange="filterModules()">
                            <option value="">All Departments</option>
                            <option value="Operations">Operations</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Warehouse">Warehouse</option>
                            <option value="Office">Office</option>
                            <option value="Field">Field</option>
                        </select>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table class="data-table" id="moduleTable">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th class="hide-mobile">Department</th>
                                <th>Progress</th>
                                <th>Completed</th>
                                <th class="hide-mobile">Last Activity</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="moduleTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ===== 4. CORRECTIVE ACTION LOG ===== -->
        <section class="section" id="section-corrective">
            <div class="section-header">
                <h1>Corrective Action Log (SQMS)</h1>
                <p>Track safety deviations, assign corrective actions, and monitor resolution.</p>
            </div>

            <div class="card">
                <div class="table-toolbar">
                    <div class="table-toolbar-left">
                        <select class="filter-select" id="caStatusFilter" onchange="filterCAs()">
                            <option value="">All Statuses</option>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Closed">Closed</option>
                        </select>
                        <select class="filter-select" id="caSeverityFilter" onchange="filterCAs()">
                            <option value="">All Severities</option>
                            <option value="Critical">Critical</option>
                            <option value="Major">Major</option>
                            <option value="Minor">Minor</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('addCAModal')">+ Add Corrective Action</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="data-table" id="caTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Description</th>
                                <th>Severity</th>
                                <th class="hide-mobile">Assigned To</th>
                                <th class="hide-mobile">Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="caTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ===== 5. CERTIFICATION EXPIRY ALERTS ===== -->
        <section class="section" id="section-certs">
            <div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
                <div>
                    <h1>Certification Expiry Alerts</h1>
                    <p>Monitor upcoming certification expirations to stay compliant.</p>
                </div>
                <button class="btn btn-primary" onclick="openModal('addCertModal')">+ Add Certification</button>
            </div>

            <div id="certAlerts"></div>
        </section>

    </main>
</div>

<!-- ===== MOBILE BOTTOM NAV ===== -->
<nav class="mobile-bottom-nav">
    <a href="#" class="active" data-tab="overview"><span class="nav-icon">&#128202;</span>Overview</a>
    <a href="#" data-tab="users"><span class="nav-icon">&#128101;</span>Users</a>
    <a href="#" data-tab="modules"><span class="nav-icon">&#128218;</span>Modules</a>
    <a href="#" data-tab="corrective"><span class="nav-icon">&#128221;</span>Actions</a>
    <a href="#" data-tab="certs"><span class="nav-icon">&#128276;</span>Certs</a>
</nav>

<!-- ===== MODALS ===== -->

<!-- Invite User Modal -->
<div class="modal-overlay" id="inviteUserModal">
    <div class="modal">
        <h2>Invite User</h2>
        <p style="font-size:13px;color:var(--text-light);margin-bottom:18px;">They'll receive an email to set their password and access TheSafetyVerse.</p>
        <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="inviteEmail" placeholder="e.g. john@company.com">
        </div>
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="inviteName" placeholder="e.g. John Smith">
        </div>
        <div class="form-group">
            <label>Role</label>
            <select id="inviteRole">
                <option value="user">User</option>
                <option value="manager">Manager</option>
            </select>
        </div>
        <div class="form-group">
            <label>Site</label>
            <select id="inviteSite">
                <option value="All Sites">Loading sites...</option>
            </select>
        </div>
        <div id="inviteResult" style="display:none;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px;"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('inviteUserModal')">Cancel</button>
            <button class="btn btn-primary" id="inviteBtn" onclick="inviteUser()">Send Invite</button>
        </div>
    </div>
</div>

<!-- Add Corrective Action Modal -->
<div class="modal-overlay" id="addCAModal">
    <div class="modal">
        <h2>Add Corrective Action</h2>
        <div class="form-group">
            <label>Description</label>
            <textarea id="caDesc" placeholder="Describe the safety deviation..."></textarea>
        </div>
        <div class="form-group">
            <label>Severity</label>
            <select id="caSeverity">
                <option value="Minor">Minor</option>
                <option value="Major">Major</option>
                <option value="Critical">Critical</option>
            </select>
        </div>
        <div class="form-group">
            <label>Assigned To</label>
            <input type="text" id="caAssigned" placeholder="e.g. John Smith">
        </div>
        <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="caDue">
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('addCAModal')">Cancel</button>
            <button class="btn btn-primary" id="addCABtn" onclick="addCorrectiveAction()">Add Action</button>
        </div>
    </div>
</div>

<!-- Edit Corrective Action Modal -->
<div class="modal-overlay" id="editCAModal">
    <div class="modal">
        <h2>Edit Corrective Action</h2>
        <input type="hidden" id="editCAId">
        <div class="form-group">
            <label>Description</label>
            <textarea id="editCADesc"></textarea>
        </div>
        <div class="form-group">
            <label>Severity</label>
            <select id="editCASeverity">
                <option value="Minor">Minor</option>
                <option value="Major">Major</option>
                <option value="Critical">Critical</option>
            </select>
        </div>
        <div class="form-group">
            <label>Assigned To</label>
            <input type="text" id="editCAAssigned">
        </div>
        <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="editCADue">
        </div>
        <div class="form-group">
            <label>Status</label>
            <select id="editCAStatus">
                <option value="Open">Open</option>
                <option value="In Progress">In Progress</option>
                <option value="Closed">Closed</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('editCAModal')">Cancel</button>
            <button class="btn btn-primary" id="saveCABtn" onclick="saveCorrectiveAction()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<!-- Add Certification Modal -->
<div class="modal-overlay" id="addCertModal">
    <div class="modal">
        <h2>Add Certification</h2>
        <div class="form-group">
            <label>Employee Name</label>
            <input type="text" id="certEmpName" placeholder="e.g. John Smith">
        </div>
        <div class="form-group">
            <label>Certification Type</label>
            <input type="text" id="certType" placeholder="e.g. Forklift Operator License">
        </div>
        <div class="form-group">
            <label>Expiry Date</label>
            <input type="date" id="certExpiry">
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('addCertModal')">Cancel</button>
            <button class="btn btn-primary" id="addCertBtn" onclick="addCertification()">Add Certification</button>
        </div>
    </div>
</div>

<script>
// =========================================================
// ACCESS GUARD — handled by auth-guard.js (data-required-role="admin")
// Personalize admin header when auth is ready
// =========================================================
document.addEventListener('svAuthReady', function(e) {
    var user = e.detail;
    var nameEl = document.getElementById('adminUserName');
    var avatarEl = document.getElementById('adminAvatar');
    if (nameEl) nameEl.textContent = user.full_name;
    if (avatarEl) {
        var parts = user.full_name.split(' ');
        avatarEl.textContent = (parts[0] ? parts[0][0] : '') + (parts[1] ? parts[1][0] : '');
    }
});

// =========================================================
// SUPABASE INIT — uses shared auth/supabase-config.js
// =========================================================
const sb = getSafetyVerseSupabase();

// =========================================================
// STATE — live data cached locally after fetch
// =========================================================
let employeesData = [];
let correctiveActionsData = [];
let certificationsData = [];
let moduleProgressData = [];  // aggregated per-employee
let incidentsData = [];
let companySettings = null;
let chartInstances = {};

const TOTAL_MODULES = 20;

// =========================================================
// HELPERS
// =========================================================
function esc(str) {
    if (str == null) return '';
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
}

function formatDate(dateStr) {
    if (!dateStr || dateStr === 'TBD') return dateStr || '\u2014';
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + type + ' show';
    setTimeout(() => t.classList.remove('show'), 3000);
}

function daysBetween(dateStr) {
    const now = new Date(); now.setHours(0,0,0,0);
    const exp = new Date(dateStr + 'T00:00:00');
    return Math.ceil((exp - now) / (1000 * 60 * 60 * 24));
}


// =========================================================
// TAB NAVIGATION
// =========================================================
function switchTab(tabName) {
    document.querySelectorAll('.sidebar-nav a[data-tab]').forEach(a => a.classList.remove('active'));
    document.querySelectorAll('.sidebar-nav a[data-tab="' + tabName + '"]').forEach(a => a.classList.add('active'));
    document.querySelectorAll('.mobile-bottom-nav a').forEach(a => a.classList.remove('active'));
    document.querySelectorAll('.mobile-bottom-nav a[data-tab="' + tabName + '"]').forEach(a => a.classList.add('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + tabName).classList.add('active');
    document.getElementById('sidebar').classList.remove('open');
}

document.querySelectorAll('.sidebar-nav a[data-tab], .mobile-bottom-nav a[data-tab]').forEach(a => {
    a.addEventListener('click', function(e) { e.preventDefault(); switchTab(this.dataset.tab); });
});

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }


// =========================================================
// MODALS
// =========================================================
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('open'); });
});


// =========================================================
// 1. CIPHER OVERVIEW — computed from live incident + settings data
// =========================================================
async function loadOverview() {
    // Fetch incidents & company settings in parallel
    const [incRes, setRes] = await Promise.all([
        sb.from('incidents').select('*').order('incident_date', { ascending: false }),
        sb.from('company_settings').select('*').limit(1)
    ]);

    incidentsData = incRes.data || [];
    companySettings = (setRes.data && setRes.data[0]) ? setRes.data[0] : null;

    // TRIR
    const totalHours = (companySettings && companySettings.total_hours_worked) ? companySettings.total_hours_worked : 0;
    const recordable = incidentsData.filter(i => i.osha_outcome && i.osha_outcome !== 'first_aid' && i.osha_outcome !== 'na_pending').length;
    const trirVal = totalHours > 0 ? ((recordable * 200000) / totalHours).toFixed(2) : '0.00';
    const trirEl = document.getElementById('trir-value');
    trirEl.textContent = trirVal;
    trirEl.className = 'stat-value ' + (parseFloat(trirVal) < 2 ? 'good' : parseFloat(trirVal) < 4 ? 'caution' : 'danger');

    // Incidents this month vs last month
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear = now.getFullYear();
    let thisMonthCount = 0, lastMonthCount = 0;
    incidentsData.forEach(inc => {
        if (!inc.incident_date) return;
        const d = new Date(inc.incident_date);
        if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) thisMonthCount++;
        const lm = thisMonth === 0 ? 11 : thisMonth - 1;
        const ly = thisMonth === 0 ? thisYear - 1 : thisYear;
        if (d.getMonth() === lm && d.getFullYear() === ly) lastMonthCount++;
    });
    document.getElementById('incident-count').textContent = thisMonthCount;
    const changeEl = document.getElementById('incident-change');
    if (lastMonthCount > 0) {
        const pctChange = Math.round(((thisMonthCount - lastMonthCount) / lastMonthCount) * 100);
        const isUp = pctChange > 0;
        changeEl.className = 'stat-change ' + (isUp ? 'negative' : pctChange < 0 ? 'positive' : 'neutral');
        changeEl.innerHTML = (isUp ? '&#9650; ' : pctChange < 0 ? '&#9660; ' : '') + Math.abs(pctChange) + '% vs last month';
    } else {
        changeEl.className = 'stat-change neutral';
        changeEl.textContent = thisMonthCount + ' this month (no prior data)';
    }

    // Build 12-month trend
    const monthLabels = [];
    const monthCounts = [];
    for (let i = 11; i >= 0; i--) {
        const d = new Date(thisYear, thisMonth - i, 1);
        monthLabels.push(d.toLocaleString('en-US', { month: 'short' }));
        const m = d.getMonth(), y = d.getFullYear();
        monthCounts.push(incidentsData.filter(inc => {
            if (!inc.incident_date) return false;
            const id = new Date(inc.incident_date);
            return id.getMonth() === m && id.getFullYear() === y;
        }).length);
    }

    // Root cause tallies from incidents
    const rcMap = { 'Human Error': 0, 'Equipment Failure': 0, 'Environmental': 0, 'Procedural Gap': 0, 'Training Deficiency': 0 };
    incidentsData.forEach(inc => {
        (inc.root_cause_unsafe_acts || []).forEach(() => rcMap['Human Error']++);
        (inc.root_cause_unsafe_conditions || []).forEach(c => {
            if (['defective_equipment','equipment_not_guarded'].includes(c)) rcMap['Equipment Failure']++;
            else if (['slippery_surface','inadequate_lighting','poor_ventilation','extreme_temperature'].includes(c)) rcMap['Environmental']++;
            else rcMap['Procedural Gap']++;
        });
        (inc.root_cause_management || []).forEach(c => {
            if (['inadequate_training','lack_of_orientation'].includes(c)) rcMap['Training Deficiency']++;
            else rcMap['Procedural Gap']++;
        });
    });

    // Compliance posture = % of closed corrective actions + % module completion, averaged
    const caTotal = correctiveActionsData.length || 1;
    const caClosed = correctiveActionsData.filter(c => c.status === 'Closed').length;
    const caScore = (caClosed / caTotal) * 100;

    let modScore = 0;
    if (moduleProgressData.length > 0) {
        const totalCompl = moduleProgressData.reduce((s, m) => s + m.completed, 0);
        modScore = (totalCompl / (moduleProgressData.length * TOTAL_MODULES)) * 100;
    }
    const compliance = Math.round((caScore + modScore) / 2);
    document.querySelector('.compliance-center-label .pct').textContent = compliance + '%';

    // Render charts (destroy old ones first)
    if (chartInstances.trend) chartInstances.trend.destroy();
    if (chartInstances.rootCause) chartInstances.rootCause.destroy();
    if (chartInstances.compliance) chartInstances.compliance.destroy();

    chartInstances.trend = new Chart(document.getElementById('trendChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [{ label: 'Incidents', data: monthCounts, borderColor: '#FF8C00', backgroundColor: 'rgba(255,140,0,0.1)', fill: true, tension: 0.4, pointBackgroundColor: '#FF8C00', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 5, pointHoverRadius: 7 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 12 } }, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { ticks: { font: { size: 12 } }, grid: { display: false } } } }
    });

    const rcLabels = Object.keys(rcMap);
    const rcData = Object.values(rcMap);
    chartInstances.rootCause = new Chart(document.getElementById('rootCauseChart').getContext('2d'), {
        type: 'bar',
        data: { labels: rcLabels, datasets: [{ label: 'Count', data: rcData, backgroundColor: ['#E53935','#FF9800','#2196F3','#FFD700','#4CAF50'], borderRadius: 6, barThickness: 24 }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { font: { size: 12 } }, grid: { color: 'rgba(0,0,0,0.05)' } }, y: { ticks: { font: { size: 12 } }, grid: { display: false } } } }
    });

    chartInstances.compliance = new Chart(document.getElementById('complianceChart').getContext('2d'), {
        type: 'doughnut',
        data: { labels: ['Compliant','Non-Compliant'], datasets: [{ data: [compliance, 100 - compliance], backgroundColor: ['#4CAF50','#E0E0E0'], borderWidth: 0, cutout: '78%' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
    });
}


// =========================================================
// 2. USER MANAGEMENT — full CRUD
// =========================================================
async function loadEmployees() {
    const { data, error } = await sb.from('employees').select('*').order('date_added', { ascending: false });
    if (error) { console.error(error); showToast('Failed to load employees', 'error'); return; }
    employeesData = data || [];
    filterUsers();
}

function renderUsers(data) {
    const tbody = document.getElementById('userTableBody');
    if (!data.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-icon">&#128101;</div>No employees found.</td></tr>'; return; }
    tbody.innerHTML = data.map(emp => {
        const dateStr = emp.date_added ? emp.date_added.split('T')[0] : '';
        return `<tr>
            <td><strong>${esc(emp.name)}</strong></td>
            <td>${esc(emp.email)}</td>
            <td><span class="badge badge-${emp.role.toLowerCase()}">${emp.role}</span></td>
            <td><span class="badge badge-${emp.status.toLowerCase()}">${emp.status}</span></td>
            <td class="hide-mobile">${formatDate(dateStr)}</td>
            <td><div class="action-btns">
                <button class="btn btn-secondary btn-sm" onclick="toggleRole('${emp.id}')">${emp.role === 'Admin' ? 'Make User' : 'Make Admin'}</button>
                <button class="btn ${emp.status === 'Active' ? 'btn-danger' : 'btn-primary'} btn-sm" onclick="toggleStatus('${emp.id}')">${emp.status === 'Active' ? 'Deactivate' : 'Activate'}</button>
            </div></td>
        </tr>`;
    }).join('');
}

function filterUsers() {
    const search = document.getElementById('userSearch').value.toLowerCase();
    const role = document.getElementById('userRoleFilter').value;
    const filtered = employeesData.filter(emp => {
        const matchSearch = (emp.name || '').toLowerCase().includes(search) || (emp.email || '').toLowerCase().includes(search);
        const matchRole = !role || emp.role === role;
        return matchSearch && matchRole;
    });
    renderUsers(filtered);
}

async function toggleRole(id) {
    const emp = employeesData.find(e => e.id === id);
    if (!emp) return;
    const newRole = emp.role === 'Admin' ? 'User' : 'Admin';
    const { error } = await sb.from('employees').update({ role: newRole, updated_at: new Date().toISOString() }).eq('id', id);
    if (error) { showToast('Failed to update role', 'error'); return; }
    emp.role = newRole;
    filterUsers();
    showToast(emp.name + ' is now ' + newRole, 'success');
}

async function toggleStatus(id) {
    const emp = employeesData.find(e => e.id === id);
    if (!emp) return;
    const newStatus = emp.status === 'Active' ? 'Inactive' : 'Active';
    const { error } = await sb.from('employees').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', id);
    if (error) { showToast('Failed to update status', 'error'); return; }
    emp.status = newStatus;
    filterUsers();
    showToast(emp.name + ' ' + (newStatus === 'Active' ? 'activated' : 'deactivated'), 'success');
}

// ─── Invite User (creates Supabase Auth account + sends password reset email) ───
async function inviteUser() {
    const email = document.getElementById('inviteEmail').value.trim();
    const name = document.getElementById('inviteName').value.trim();
    const role = document.getElementById('inviteRole').value;
    const site = document.getElementById('inviteSite').value;
    const resultEl = document.getElementById('inviteResult');
    resultEl.style.display = 'none';

    if (!email || !name) {
        resultEl.textContent = 'Email and name are required.';
        resultEl.style.display = 'block';
        resultEl.style.background = '#fef2f2';
        resultEl.style.color = '#dc2626';
        resultEl.style.border = '1px solid #fecaca';
        return;
    }

    const btn = document.getElementById('inviteBtn');
    btn.disabled = true;
    btn.textContent = 'Sending invite...';

    try {
        // Step 1: Create the auth account with a random temp password
        const tempPassword = 'Temp-' + crypto.randomUUID();
        const { data: signUpData, error: signUpError } = await sb.auth.signUp({
            email: email,
            password: tempPassword,
            options: {
                data: {
                    full_name: name,
                    role: role,
                    site: site
                }
            }
        });

        if (signUpError) throw signUpError;

        // Step 2: Also add to employees table for backward compat with admin dashboard
        await sb.from('employees').insert([{
            name: name,
            email: email,
            role: role.charAt(0).toUpperCase() + role.slice(1),
            department: site,
            status: 'Active'
        }]);

        // Step 3: Send password reset email so user can set their own password
        const siteUrl = window.location.origin + window.location.pathname.replace('/admin-dashboard/index.html', '/set-password.html');
        const { error: resetError } = await sb.auth.resetPasswordForEmail(email, {
            redirectTo: siteUrl
        });

        if (resetError) {
            console.warn('Password reset email failed:', resetError.message);
            // Account was still created — show partial success
            resultEl.textContent = 'Account created for ' + name + ', but the email could not be sent. They can use "Forgot password" on the login page.';
            resultEl.style.display = 'block';
            resultEl.style.background = '#fefce8';
            resultEl.style.color = '#a16207';
            resultEl.style.border = '1px solid #fde68a';
        } else {
            resultEl.textContent = 'Invite sent to ' + email + '! They will receive an email to set their password.';
            resultEl.style.display = 'block';
            resultEl.style.background = '#f0fdf4';
            resultEl.style.color = '#166534';
            resultEl.style.border = '1px solid #bbf7d0';
        }

        // Refresh the employee list
        await loadEmployees();
        filterUsers();

        // Clear the form
        document.getElementById('inviteEmail').value = '';
        document.getElementById('inviteName').value = '';
        document.getElementById('inviteRole').value = 'user';
        document.getElementById('inviteSite').value = 'All Sites';

        showToast(name + ' invited!', 'success');

    } catch (err) {
        resultEl.textContent = 'Error: ' + (err.message || 'Could not create account');
        resultEl.style.display = 'block';
        resultEl.style.background = '#fef2f2';
        resultEl.style.color = '#dc2626';
        resultEl.style.border = '1px solid #fecaca';
    }

    btn.disabled = false;
    btn.textContent = 'Send Invite';
}

// ─── Load site locations into invite dropdown ───
async function loadSiteOptions() {
    try {
        const { data, error } = await sb.from('site_locations').select('name').order('name');
        if (error || !data) return;
        const sel = document.getElementById('inviteSite');
        sel.innerHTML = '';
        // "All Sites" always first — for managers who oversee everything
        var allOpt = document.createElement('option');
        allOpt.value = 'All Sites';
        allOpt.textContent = 'All Sites';
        sel.appendChild(allOpt);
        data.forEach(function(s) {
            var opt = document.createElement('option');
            opt.value = s.name;
            opt.textContent = s.name;
            sel.appendChild(opt);
        });
    } catch (e) { console.warn('Failed to load sites:', e); }
}

// Load site options when page loads
loadSiteOptions();


// =========================================================
// 3. MODULE COMPLETION TRACKING — from Supabase
// =========================================================
async function loadModuleProgress() {
    const { data, error } = await sb.from('module_progress').select('*').order('last_activity', { ascending: false });
    if (error) { console.error(error); showToast('Failed to load module progress', 'error'); return; }

    // Aggregate per employee
    const empMap = {};
    (data || []).forEach(row => {
        if (!empMap[row.employee_name]) {
            empMap[row.employee_name] = { name: row.employee_name, department: row.department || 'Unassigned', completed: 0, lastActivity: null };
        }
        if (row.completed) empMap[row.employee_name].completed++;
        const la = row.last_activity || row.updated_at;
        if (la && (!empMap[row.employee_name].lastActivity || la > empMap[row.employee_name].lastActivity)) {
            empMap[row.employee_name].lastActivity = la;
        }
    });

    // Compute status
    const now = new Date();
    moduleProgressData = Object.values(empMap).map(m => {
        let status = 'On Track';
        if (m.completed >= TOTAL_MODULES) {
            status = 'On Track';
        } else if (m.lastActivity) {
            const daysSince = Math.floor((now - new Date(m.lastActivity)) / (1000 * 60 * 60 * 24));
            if (daysSince > 30) status = 'Overdue';
            else if (daysSince > 14 || m.completed < TOTAL_MODULES / 2) status = 'At Risk';
        }
        return { ...m, status };
    });

    // Sort: overdue first, then at risk, then on track
    const order = { 'Overdue': 0, 'At Risk': 1, 'On Track': 2 };
    moduleProgressData.sort((a, b) => order[a.status] - order[b.status]);

    filterModules();
}

function renderModules(data) {
    const tbody = document.getElementById('moduleTableBody');
    if (!data.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-icon">&#128218;</div>No module progress data yet.</td></tr>'; return; }
    tbody.innerHTML = data.map(m => {
        const pct = Math.round((m.completed / TOTAL_MODULES) * 100);
        const barClass = pct === 100 ? 'complete' : '';
        const badgeClass = m.status === 'On Track' ? 'on-track' : m.status === 'At Risk' ? 'at-risk' : 'overdue';
        const laDate = m.lastActivity ? m.lastActivity.split('T')[0] : '';
        return `<tr>
            <td><strong>${esc(m.name)}</strong></td>
            <td class="hide-mobile">${esc(m.department)}</td>
            <td style="min-width:140px"><div class="progress-bar-wrap"><div class="progress-bar-fill ${barClass}" style="width:${pct}%"></div></div><div style="font-size:11px;color:var(--text-light);margin-top:4px;">${pct}%</div></td>
            <td>${m.completed} / ${TOTAL_MODULES}</td>
            <td class="hide-mobile">${formatDate(laDate)}</td>
            <td><span class="badge badge-${badgeClass}">${m.status}</span></td>
        </tr>`;
    }).join('');
}

function filterModules() {
    const search = document.getElementById('moduleSearch').value.toLowerCase();
    const status = document.getElementById('moduleStatusFilter').value;
    const dept = document.getElementById('moduleDeptFilter').value;
    const filtered = moduleProgressData.filter(m => {
        return (!search || m.name.toLowerCase().includes(search))
            && (!status || m.status === status)
            && (!dept || m.department === dept);
    });
    renderModules(filtered);
}


// =========================================================
// 4. CORRECTIVE ACTIONS — full CRUD
// =========================================================
async function loadCorrectiveActions() {
    const { data, error } = await sb.from('corrective_actions').select('*').order('created_at', { ascending: false });
    if (error) { console.error(error); showToast('Failed to load corrective actions', 'error'); return; }
    correctiveActionsData = data || [];
    filterCAs();
}

function renderCAs(data) {
    const tbody = document.getElementById('caTableBody');
    if (!data.length) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-icon">&#128221;</div>No corrective actions found.</td></tr>'; return; }
    tbody.innerHTML = data.map(ca => {
        const statusClass = ca.status === 'Open' ? 'open' : ca.status === 'In Progress' ? 'in-progress' : 'closed';
        const sevClass = (ca.severity || 'minor').toLowerCase();
        const dueStr = ca.due_date || '';
        return `<tr>
            <td><strong>${esc(ca.action_id)}</strong></td>
            <td style="max-width:300px">${esc(ca.description)}</td>
            <td><span class="badge badge-${sevClass}">${ca.severity}</span></td>
            <td class="hide-mobile">${esc(ca.assigned_to)}</td>
            <td class="hide-mobile">${formatDate(dueStr)}</td>
            <td><span class="badge badge-${statusClass}">${ca.status}</span></td>
            <td><button class="btn btn-secondary btn-sm" onclick="editCA('${ca.id}')">Edit</button></td>
        </tr>`;
    }).join('');
}

function filterCAs() {
    const status = document.getElementById('caStatusFilter').value;
    const severity = document.getElementById('caSeverityFilter').value;
    const filtered = correctiveActionsData.filter(ca => {
        return (!status || ca.status === status) && (!severity || ca.severity === severity);
    });
    renderCAs(filtered);
}

async function addCorrectiveAction() {
    const desc = document.getElementById('caDesc').value.trim();
    const severity = document.getElementById('caSeverity').value;
    const assigned = document.getElementById('caAssigned').value.trim();
    const due = document.getElementById('caDue').value;
    if (!desc) { showToast('Description is required', 'error'); return; }

    const btn = document.getElementById('addCABtn');
    btn.disabled = true; btn.textContent = 'Adding...';

    const row = { description: desc, severity, assigned_to: assigned || null, due_date: due || null, status: 'Open' };
    const { data, error } = await sb.from('corrective_actions').insert([row]).select();
    btn.disabled = false; btn.textContent = 'Add Action';
    if (error) { showToast('Error: ' + error.message, 'error'); return; }

    correctiveActionsData.unshift(data[0]);
    closeModal('addCAModal');
    document.getElementById('caDesc').value = '';
    document.getElementById('caAssigned').value = '';
    document.getElementById('caDue').value = '';
    filterCAs();
    showToast('Corrective action added!', 'success');
}

function editCA(id) {
    const ca = correctiveActionsData.find(c => c.id === id);
    if (!ca) return;
    document.getElementById('editCAId').value = id;
    document.getElementById('editCADesc').value = ca.description || '';
    document.getElementById('editCASeverity').value = ca.severity || 'Minor';
    document.getElementById('editCAAssigned').value = ca.assigned_to || '';
    document.getElementById('editCADue').value = ca.due_date || '';
    document.getElementById('editCAStatus').value = ca.status || 'Open';
    openModal('editCAModal');
}

async function saveCorrectiveAction() {
    const id = document.getElementById('editCAId').value;
    const btn = document.getElementById('saveCABtn');
    btn.disabled = true; btn.textContent = 'Saving...';

    const updates = {
        description: document.getElementById('editCADesc').value.trim(),
        severity: document.getElementById('editCASeverity').value,
        assigned_to: document.getElementById('editCAAssigned').value.trim() || null,
        due_date: document.getElementById('editCADue').value || null,
        status: document.getElementById('editCAStatus').value,
        updated_at: new Date().toISOString()
    };

    const { data, error } = await sb.from('corrective_actions').update(updates).eq('id', id).select();
    btn.disabled = false; btn.textContent = 'Save Changes';
    if (error) { showToast('Error: ' + error.message, 'error'); return; }

    // Update local cache
    const idx = correctiveActionsData.findIndex(c => c.id === id);
    if (idx !== -1 && data && data[0]) correctiveActionsData[idx] = data[0];

    closeModal('editCAModal');
    filterCAs();
    showToast('Corrective action updated!', 'success');
    loadOverview(); // refresh compliance
}


// =========================================================
// 5. CERTIFICATION EXPIRY ALERTS — full CRUD
// =========================================================
async function loadCertifications() {
    const { data, error } = await sb.from('certifications').select('*').order('expiry_date', { ascending: true });
    if (error) { console.error(error); showToast('Failed to load certifications', 'error'); return; }
    certificationsData = (data || []).map(c => ({
        ...c,
        daysRemaining: daysBetween(c.expiry_date)
    }));
    renderCertAlerts();
}

function renderCertAlerts() {
    const container = document.getElementById('certAlerts');
    // Filter to only certs expiring within 90 days
    const upcoming = certificationsData.filter(c => c.daysRemaining >= 0 && c.daysRemaining <= 90);
    const groups = [
        { label: 'Expiring Within 30 Days', dotClass: 'red', daysClass: 'red', min: 0, max: 30, cardClass: 'urgent' },
        { label: 'Expiring Within 60 Days', dotClass: 'orange', daysClass: 'orange', min: 31, max: 60, cardClass: 'warning' },
        { label: 'Expiring Within 90 Days', dotClass: 'yellow', daysClass: 'yellow', min: 61, max: 90, cardClass: 'caution' }
    ];

    if (!upcoming.length) {
        container.innerHTML = '<div class="card empty-state"><div class="empty-icon">&#9989;</div><p>No certifications expiring in the next 90 days. All clear!</p></div>';
        return;
    }

    container.innerHTML = groups.map(g => {
        const certs = upcoming.filter(c => c.daysRemaining >= g.min && c.daysRemaining <= g.max);
        if (!certs.length) return '';
        return `<div class="cert-alert-group">
            <div class="cert-alert-header">
                <div class="cert-alert-dot ${g.dotClass}"></div>
                <h3>${g.label}</h3>
                <span style="font-size:13px;color:var(--text-light);margin-left:auto;">${certs.length} certification${certs.length > 1 ? 's' : ''}</span>
            </div>
            ${certs.map(c => `<div class="cert-card ${g.cardClass}">
                <div class="cert-info">
                    <span class="name">${esc(c.employee_name)}</span>
                    <span class="type">${esc(c.cert_type)}</span>
                </div>
                <div class="cert-expiry">
                    <div class="date">${formatDate(c.expiry_date)}</div>
                    <div class="days ${g.daysClass}">${c.daysRemaining} day${c.daysRemaining !== 1 ? 's' : ''} remaining</div>
                </div>
            </div>`).join('')}
        </div>`;
    }).join('');
}

async function addCertification() {
    const empName = document.getElementById('certEmpName').value.trim();
    const certType = document.getElementById('certType').value.trim();
    const expiry = document.getElementById('certExpiry').value;
    if (!empName || !certType || !expiry) { showToast('All fields are required', 'error'); return; }

    const btn = document.getElementById('addCertBtn');
    btn.disabled = true; btn.textContent = 'Adding...';

    const { data, error } = await sb.from('certifications').insert([{ employee_name: empName, cert_type: certType, expiry_date: expiry }]).select();
    btn.disabled = false; btn.textContent = 'Add Certification';
    if (error) { showToast('Error: ' + error.message, 'error'); return; }

    const newCert = { ...data[0], daysRemaining: daysBetween(data[0].expiry_date) };
    certificationsData.push(newCert);
    certificationsData.sort((a, b) => new Date(a.expiry_date) - new Date(b.expiry_date));

    closeModal('addCertModal');
    document.getElementById('certEmpName').value = '';
    document.getElementById('certType').value = '';
    document.getElementById('certExpiry').value = '';
    renderCertAlerts();
    showToast('Certification added!', 'success');
}


// =========================================================
// INIT — load all live data
// =========================================================
async function init() {
    try {
        // Load tables in parallel (non-dependent sections)
        await Promise.all([
            loadEmployees(),
            loadCorrectiveActions(),
            loadCertifications(),
            loadModuleProgress()
        ]);
        // Overview depends on corrective actions + module progress for compliance score
        await loadOverview();
    } catch (err) {
        console.error('Init error:', err);
        showToast('Some data failed to load. Check console.', 'error');
    }
}

init();
</script>
</body>
</html>
