<!DOCTYPE html>
<html lang="en" data-required-role="manager">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Incident Report - TheSafetyVerse</title>
<link rel="icon" type="image/png" href="logo.png?v=2">
<style>body { visibility: hidden; opacity: 0; transition: opacity 0.3s; }</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../auth/supabase-config.js"></script>
<script src="../auth/auth-guard.js"></script>
<link rel="stylesheet" href="../shared/header.css">
<script src="../shared/header.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}

.hero{background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border-bottom:3px solid #2563eb;padding:2rem 1.5rem 1.5rem;text-align:center}
.hero h1{font-size:1.6rem;font-weight:800;color:#fff;margin-bottom:.4rem}
.hero h1 em{font-style:normal;color:#f59e0b}
.hero p{color:#94a3b8;font-size:.82rem;max-width:580px;margin:0 auto;line-height:1.5}

.wizard-progress{display:flex;justify-content:space-between;padding:.75rem 1rem;background:#1e293b;border-bottom:1px solid #334155;position:sticky;top:0;z-index:100;overflow-x:auto;gap:2px}
.wsi{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:48px;cursor:default}
.wsc{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;border:2px solid #334155;color:#64748b;background:transparent;transition:all .3s}
.wsc.active{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,0.1)}
.wsc.done{border-color:#22c55e;color:#fff;background:#22c55e}
.wsl{font-size:.48rem;color:#64748b;text-align:center;text-transform:uppercase;letter-spacing:.03em;font-weight:600;white-space:nowrap}
.wsl.active{color:#f59e0b}
.wsl.done{color:#22c55e}

.content{max-width:760px;margin:0 auto;padding:1.5rem 1rem 3rem}
.wizard-step{display:none;animation:fadeIn .3s ease}
.wizard-step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.card{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:2rem;margin-bottom:1rem}
.step-title{font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:#f59e0b;margin-bottom:.5rem}
.step-heading{font-size:1.08rem;font-weight:700;color:#f1f5f9;line-height:1.45;margin-bottom:1.25rem}

.sv-field{margin-bottom:1.25rem}
.sv-label{display:block;font-size:.72rem;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.4rem}
.sv-required::after{content:' *';color:#ef4444}
.sv-input,.sv-select{width:100%;padding:.75rem 1rem;background:#0f172a;border:2px solid #334155;border-radius:10px;color:#e2e8f0;font-family:'Inter',sans-serif;font-size:.85rem;transition:border-color .2s}
.sv-input:focus,.sv-select:focus{outline:none;border-color:#f59e0b}
.sv-textarea{min-height:100px;resize:vertical}
.sv-textarea.lg{min-height:150px}
.sv-select{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.sv-select option{background:#1e293b;color:#e2e8f0}
.sv-helper{font-size:.72rem;color:#64748b;margin-top:.3rem}
.sv-error{border-color:#ef4444!important}
.sv-error-msg{font-size:.72rem;color:#ef4444;margin-top:.3rem;display:none}
.sv-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.sv-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}

.sv-radio-group{display:flex;flex-wrap:wrap;gap:.5rem}
.sv-radio-card{flex:1;min-width:120px;padding:.8rem;text-align:center;border:2px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-size:.82rem;font-weight:600;color:#94a3b8;transition:all .2s}
.sv-radio-card:hover{border-color:#475569}
.sv-radio-card input{display:none}
.sv-radio-card.selected{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,0.08)}

.osha-card{display:block;width:100%;padding:1rem 1.25rem;text-align:left;border:2px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;transition:all .2s;margin-bottom:.5rem}
.osha-card:hover{border-color:#475569}
.osha-card input{display:none}
.osha-card .oc-title{font-size:.88rem;font-weight:700;color:#cbd5e1}
.osha-card .oc-desc{font-size:.72rem;color:#64748b;margin-top:.15rem}
.osha-card.selected{border-color:#f59e0b;background:rgba(245,158,11,0.06)}
.osha-card.selected .oc-title{color:#f59e0b}
.osha-card.sel-red{border-color:#ef4444;background:rgba(239,68,68,0.06)}
.osha-card.sel-red .oc-title{color:#f87171}
.osha-card.sel-green{border-color:#22c55e;background:rgba(34,197,94,0.06)}

.cb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem}
.cb-item{display:flex;align-items:center;gap:.45rem;padding:.5rem .6rem;background:#0f172a;border:1px solid #334155;border-radius:8px;cursor:pointer;transition:all .2s;font-size:.75rem;color:#cbd5e1}
.cb-item:hover{border-color:#475569}
.cb-item:has(input:checked){border-color:#f59e0b;background:rgba(245,158,11,0.06)}
.cb-item input[type="checkbox"]{accent-color:#f59e0b;flex-shrink:0}

.rc-section{margin-bottom:1.5rem}
.rc-title{font-size:.75rem;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;padding-bottom:.35rem;border-bottom:1px solid #334155}
.rc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.35rem}

.witness-block{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:1.25rem;margin-bottom:.75rem;position:relative}
.witness-block .remove-btn{position:absolute;top:10px;right:10px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#f87171;font-size:.7rem;padding:4px 10px;border-radius:6px;cursor:pointer}
.witness-block .remove-btn:hover{background:rgba(239,68,68,0.3)}

.toggle-group{display:flex;gap:.5rem;margin-bottom:1.25rem}
.toggle-btn{flex:1;padding:.85rem;text-align:center;border:2px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-family:inherit;font-size:.88rem;font-weight:700;color:#94a3b8;transition:all .2s}
.toggle-btn.yes.selected{border-color:#22c55e;color:#22c55e;background:rgba(34,197,94,0.08)}
.toggle-btn.no.selected{border-color:#ef4444;color:#f87171;background:rgba(239,68,68,0.08)}

.add-btn{display:inline-flex;align-items:center;gap:6px;padding:.6rem 1.2rem;border-radius:8px;border:2px solid #334155;background:transparent;color:#94a3b8;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s}
.add-btn:hover{border-color:#f59e0b;color:#f59e0b}

.wizard-nav{display:flex;justify-content:space-between;margin-top:2rem;padding-top:1.5rem;border-top:1px solid #334155}
.wbtn{padding:.75rem 2rem;border-radius:10px;font-family:inherit;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;border:none}
.wbtn-prev{background:transparent;border:2px solid #334155;color:#94a3b8}
.wbtn-prev:hover{border-color:#f59e0b;color:#f59e0b}
.wbtn-next{background:linear-gradient(135deg,#f59e0b,#d97706);color:#0f172a}
.wbtn-next:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(245,158,11,0.3)}
.wbtn-submit{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-size:.95rem;padding:.85rem 2.5rem}
.wbtn-submit:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(34,197,94,0.3)}
.wbtn:disabled{opacity:.5;cursor:default;transform:none!important}

.no-injury-toggle{display:flex;align-items:center;gap:.75rem;padding:.85rem 1rem;background:rgba(37,99,235,0.08);border:1px solid rgba(37,99,235,0.25);border-radius:10px;margin-bottom:1.25rem;cursor:pointer;font-size:.85rem;color:#93c5fd}
.no-injury-toggle input{accent-color:#f59e0b;width:18px;height:18px}

.conditional{transition:all .3s}
.conditional.hidden{opacity:.3;pointer-events:none;max-height:0;overflow:hidden;margin:0;padding:0}

.success-screen{display:none;text-align:center;padding:3rem 1rem}
.success-icon{width:80px;height:80px;border-radius:50%;background:rgba(34,197,94,0.15);border:3px solid #22c55e;display:flex;align-items:center;justify-content:center;margin:0 auto 1.5rem;font-size:2rem;color:#22c55e}
.success-screen h2{font-size:1.5rem;font-weight:800;color:#fff;margin-bottom:.5rem}
.success-screen p{color:#94a3b8;font-size:.9rem;margin-bottom:2rem}
.success-actions{display:flex;flex-wrap:wrap;gap:.75rem;justify-content:center}
.success-actions button{padding:.75rem 1.5rem;border-radius:10px;border:none;font-family:inherit;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s}
.sa-primary{background:linear-gradient(135deg,#f59e0b,#d97706);color:#0f172a}
.sa-secondary{background:transparent;border:2px solid #334155;color:#94a3b8}
.sa-secondary:hover{border-color:#f59e0b;color:#f59e0b}

.incidents-list{display:none}
.il-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:1.25rem;margin-bottom:.75rem;cursor:pointer;transition:all .2s}
.il-card:hover{border-color:rgba(245,158,11,0.3)}
.il-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
.il-case{font-size:.9rem;font-weight:700;color:#f1f5f9}
.il-date{font-size:.75rem;color:#64748b}
.il-details{font-size:.82rem;color:#94a3b8;line-height:1.5}
.il-badge{display:inline-block;padding:.15rem .5rem;border-radius:6px;font-size:.65rem;font-weight:700;text-transform:uppercase}
.il-badge.pending{background:rgba(245,158,11,0.15);color:#fbbf24}
.il-badge.recorded{background:rgba(34,197,94,0.15);color:#4ade80}

.tab-bar{display:flex;justify-content:center;gap:.2rem;background:#1e293b;padding:.5rem;border-bottom:1px solid #334155;flex-wrap:wrap}
.tab{padding:.55rem .9rem;border-radius:8px;border:none;background:transparent;color:#94a3b8;font-family:inherit;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .2s}
.tab:hover{color:#e2e8f0;background:#334155}
.tab.active{color:#f59e0b;background:#334155}

.panel{display:none}.panel.active{display:block}
.toast{position:fixed;top:20px;right:20px;padding:.85rem 1.25rem;border-radius:10px;font-size:.85rem;font-weight:600;z-index:9999;transform:translateX(120%);transition:transform .3s ease;max-width:350px}
.toast.show{transform:translateX(0)}
.toast.success{background:#166534;color:#4ade80;border:1px solid #22c55e}
.toast.error{background:#7f1d1d;color:#fca5a5;border:1px solid #ef4444}
.info-box{background:rgba(37,99,235,0.1);border:1px solid rgba(37,99,235,0.25);border-radius:10px;padding:.85rem 1rem;margin-bottom:1.25rem;font-size:.82rem;color:#93c5fd;line-height:1.5}

/* Incident File sub-tabs */
.if-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.5rem}
.if-header h2{font-size:1.1rem;font-weight:800;color:#f1f5f9}
.if-header .if-id{font-size:.85rem;font-weight:700;color:#f59e0b;background:rgba(245,158,11,0.1);padding:.3rem .8rem;border-radius:8px;border:1px solid rgba(245,158,11,0.25)}
.if-selector{margin-bottom:1.25rem}
.if-selector select{max-width:400px}

.sub-tabs{display:flex;gap:.2rem;background:#0f172a;padding:.4rem;border-radius:10px;margin-bottom:1.5rem;flex-wrap:wrap;border:1px solid #334155}
.sub-tab{padding:.5rem .75rem;border-radius:7px;border:none;background:transparent;color:#64748b;font-family:inherit;font-size:.7rem;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
.sub-tab:hover{color:#e2e8f0;background:#1e293b}
.sub-tab.active{color:#f59e0b;background:#1e293b}
.sub-panel{display:none}.sub-panel.active{display:block}

/* Summary cards */
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1.5rem}
.summary-card{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:1rem}
.summary-card .sc-label{font-size:.65rem;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.3rem}
.summary-card .sc-value{font-size:.88rem;font-weight:600;color:#e2e8f0}
.summary-card .sc-value.amber{color:#fbbf24}
.summary-card .sc-value.red{color:#f87171}
.summary-card .sc-value.green{color:#4ade80}

/* Status tracker */
.status-tracker{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin-bottom:1.5rem}
.st-item{display:flex;align-items:center;gap:.5rem;padding:.6rem .8rem;background:#0f172a;border:1px solid #334155;border-radius:8px;font-size:.75rem;color:#94a3b8}
.st-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.st-dot.empty{background:#334155}
.st-dot.done{background:#22c55e}
.st-dot.partial{background:#f59e0b}

/* Quick link cards */
.ql-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
.ql-card{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:1rem;text-align:center;cursor:pointer;transition:all .2s}
.ql-card:hover{border-color:rgba(245,158,11,0.4);transform:translateY(-1px)}
.ql-card .ql-icon{font-size:1.5rem;margin-bottom:.4rem}
.ql-card .ql-text{font-size:.78rem;font-weight:600;color:#94a3b8}

/* Medical toggle */
.med-toggle{display:flex;gap:.5rem;margin-bottom:1.5rem}
.med-toggle-btn{flex:1;padding:.85rem;text-align:center;border:2px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-family:inherit;font-size:.82rem;font-weight:700;color:#94a3b8;transition:all .2s}
.med-toggle-btn.active-accept{border-color:#22c55e;color:#22c55e;background:rgba(34,197,94,0.08)}
.med-toggle-btn.active-refuse{border-color:#ef4444;color:#f87171;background:rgba(239,68,68,0.08)}

/* Clinic cards */
.clinic-card{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:1rem;margin-bottom:.6rem;display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;flex-wrap:wrap}
.clinic-card.primary{border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.04)}
.clinic-card .cc-name{font-size:.88rem;font-weight:700;color:#f1f5f9}
.clinic-card .cc-primary{font-size:.6rem;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:.05em}
.clinic-card .cc-detail{font-size:.78rem;color:#94a3b8;line-height:1.5}
.clinic-card .cc-actions{display:flex;gap:.4rem;flex-shrink:0}
.clinic-card .cc-actions a{padding:.4rem .8rem;border-radius:6px;font-size:.72rem;font-weight:600;text-decoration:none;transition:all .2s}
.cc-call{background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.25)}
.cc-call:hover{background:rgba(34,197,94,0.25)}
.cc-dir{background:rgba(59,130,246,0.12);color:#60a5fa;border:1px solid rgba(59,130,246,0.25)}
.cc-dir:hover{background:rgba(59,130,246,0.25)}

/* Medical Packet */
.med-packet-section{background:rgba(37,99,235,0.08);border:2px solid rgba(37,99,235,0.25);border-radius:14px;padding:1.5rem;margin-top:1.5rem;text-align:left}
.med-packet-section h3{font-size:1rem;font-weight:700;color:#60a5fa;margin-bottom:.75rem;display:flex;align-items:center;gap:.5rem}
.med-packet-section h3 .mp-icon{font-size:1.2rem}
.mp-summary{font-size:.82rem;color:#94a3b8;margin-bottom:1rem;line-height:1.6}
.mp-summary strong{color:#cbd5e1}
.mp-downloads{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1.25rem}
.mp-dl-btn{padding:.6rem 1.2rem;border-radius:8px;border:2px solid rgba(37,99,235,0.3);background:rgba(37,99,235,0.1);color:#60a5fa;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.4rem}
.mp-dl-btn:hover{background:rgba(37,99,235,0.2);border-color:#60a5fa}
.mp-clinics-heading{font-size:.82rem;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.6rem}

/* WC Checklist */
.wc-checklist{margin-bottom:1.5rem}
.wc-item{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;background:#0f172a;border:1px solid #334155;border-radius:8px;margin-bottom:.35rem;font-size:.82rem;color:#cbd5e1;cursor:pointer;transition:all .2s}
.wc-item:hover{border-color:#475569}
.wc-item.checked{border-color:rgba(34,197,94,0.3);background:rgba(34,197,94,0.05);color:#4ade80}
.wc-item input{accent-color:#22c55e;width:16px;height:16px;flex-shrink:0}

/* Statement cards */
.stmt-card{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:1.25rem;margin-bottom:.75rem;position:relative}
.stmt-card .stmt-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
.stmt-card .stmt-type{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;padding:.2rem .6rem;border-radius:5px}
.stmt-type.employee{color:#60a5fa;background:rgba(59,130,246,0.12)}
.stmt-type.witness{color:#a78bfa;background:rgba(167,139,250,0.12)}
.stmt-remove{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#f87171;font-size:.7rem;padding:4px 10px;border-radius:6px;cursor:pointer;font-family:inherit}
.stmt-remove:hover{background:rgba(239,68,68,0.3)}

/* Corrective action rows */
.ca-row{display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:.5rem;align-items:start;padding:.75rem;background:#0f172a;border:1px solid #334155;border-radius:8px;margin-bottom:.4rem}
.ca-row .sv-input{padding:.5rem .6rem;font-size:.78rem}
.ca-status{padding:.35rem .6rem;border-radius:6px;font-size:.7rem;font-weight:600;text-align:center;border:none;font-family:inherit;cursor:pointer}
.ca-status.open{background:rgba(245,158,11,0.15);color:#fbbf24}
.ca-status.in_progress{background:rgba(59,130,246,0.15);color:#60a5fa}
.ca-status.completed{background:rgba(34,197,94,0.15);color:#4ade80}

/* RTW toggle */
.rtw-toggle{display:flex;gap:.4rem;margin-bottom:1.5rem}
.rtw-btn{flex:1;padding:.75rem .5rem;text-align:center;border:2px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-family:inherit;font-size:.78rem;font-weight:700;color:#94a3b8;transition:all .2s}
.rtw-btn.active-full{border-color:#22c55e;color:#22c55e;background:rgba(34,197,94,0.08)}
.rtw-btn.active-modified{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,0.08)}
.rtw-btn.active-not{border-color:#ef4444;color:#f87171;background:rgba(239,68,68,0.08)}

/* Document download cards */
.doc-card{display:flex;align-items:center;justify-content:space-between;background:#0f172a;border:1px solid #334155;border-radius:10px;padding:1rem;margin-bottom:.5rem;flex-wrap:wrap;gap:.75rem}
.doc-card .dc-info{flex:1;min-width:200px}
.doc-card .dc-name{font-size:.88rem;font-weight:700;color:#f1f5f9}
.doc-card .dc-desc{font-size:.72rem;color:#64748b;margin-top:.15rem}
.doc-card button{padding:.5rem 1.2rem;border-radius:8px;border:none;background:linear-gradient(135deg,#f59e0b,#d97706);color:#0f172a;font-family:inherit;font-size:.78rem;font-weight:700;cursor:pointer;transition:all .2s}
.doc-card button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(245,158,11,0.3)}
.doc-card button:disabled{opacity:.5;cursor:default;transform:none}

/* Close-out section */
.closeout-section{background:rgba(37,99,235,0.06);border:1px solid rgba(37,99,235,0.2);border-radius:10px;padding:1.25rem;margin-top:1.25rem}
.closeout-section .co-title{font-size:.75rem;font-weight:700;color:#60a5fa;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.75rem}

@media(max-width:768px){
  .sv-row,.sv-row-3{grid-template-columns:1fr}
  .cb-grid,.rc-grid{grid-template-columns:repeat(2,1fr)}
  .content{padding:1rem .75rem 2rem}
  .card{padding:1.25rem}
  .wizard-progress{padding:.6rem .5rem}
  .wsi{min-width:38px}
  .wsl{font-size:.42rem}
  .summary-grid,.status-tracker,.ql-grid{grid-template-columns:1fr}
  .ca-row{grid-template-columns:1fr}
  .sub-tabs{gap:.15rem;padding:.3rem}
}
@media(max-width:480px){
  .cb-grid,.rc-grid{grid-template-columns:1fr}
  .sv-radio-group{flex-direction:column}
  .sv-radio-card{min-width:auto}
}
</style>
</head>
<body>

<!-- Header injected by shared/header.js -->

<div class="hero">
  <h1>Safety Incident <em>Report</em></h1>
  <p>Document workplace incidents with guided steps. Data maps to OSHA 301, 300 Log, and 300A Summary.</p>
</div>

<div class="tab-bar">
  <button class="tab active" onclick="showPanel('wizard')" id="tabNewReport">New Report</button>
  <button class="tab" onclick="showPanel('medpacket')" id="tabMedPacket">Medical Packet</button>
  <button class="tab" onclick="showPanel('list')" id="tabPastReports">Past Reports</button>
  <button class="tab" onclick="showPanel('file')" id="tabIncidentFile">Incident File</button>
  <button class="tab" onclick="showPanel('reports')" id="tabOshaDownloads">OSHA Downloads</button>
</div>

<div class="panel active" id="panel-wizard">

<div class="wizard-progress" id="progressBar"></div>

<div class="content" id="wizardContent">

<!-- STEP 1: Contact Info -->
<div class="wizard-step active" id="step-1">
<div class="card">
  <div class="step-title">Step 1 of 9</div>
  <div class="step-heading">Who is reporting this incident?</div>
  <div class="sv-field"><label class="sv-label sv-required">Reporting Party Name</label><input type="text" class="sv-input" id="f_rp_name"></div>
  <div class="sv-field"><label class="sv-label sv-required">Title / Position</label><input type="text" class="sv-input" id="f_rp_title"></div>
  <div class="sv-field"><label class="sv-label sv-required">Site / Location Name</label><select class="sv-input sv-select" id="f_site"><option value="">-- Select site location --</option></select></div>
</div>
<div class="wizard-nav"><div></div><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 2: Incident Details -->
<div class="wizard-step" id="step-2">
<div class="card">
  <div class="step-title">Step 2 of 9</div>
  <div class="step-heading">When and where did the incident occur?</div>
  <div class="sv-row">
    <div class="sv-field"><label class="sv-label sv-required">Date of Incident</label><input type="date" class="sv-input" id="f_date"></div>
    <div class="sv-field"><label class="sv-label sv-required">Time of Incident</label><input type="time" class="sv-input" id="f_time"></div>
  </div>
  <div class="sv-field"><label class="sv-label">Report Filed</label><input type="text" class="sv-input" id="f_report_time" readonly style="opacity:.6"></div>
  <div class="sv-field"><label class="sv-label">Specific Location</label><input type="text" class="sv-input" id="f_specific_loc" placeholder="e.g., Loading dock B, north entrance"></div>
  <div class="sv-row">
    <div class="sv-field"><label class="sv-label">Visibility</label><select class="sv-input sv-select" id="f_visibility"><option value="">Select</option><option>Good</option><option>Fair</option><option>Poor</option><option>Dark</option></select></div>
    <div class="sv-field"><label class="sv-label">Surface Conditions</label><select class="sv-input sv-select" id="f_surface"><option value="">Select</option><option>Dry</option><option>Wet</option><option>Icy</option><option>Oily</option><option>Uneven</option><option>Other</option></select></div>
  </div>
  <div class="sv-row">
    <div class="sv-field"><label class="sv-label">Temperature</label><input type="text" class="sv-input" id="f_temp" placeholder="e.g., 85&#176;F, humid"></div>
    <div class="sv-field"><label class="sv-label">People Involved</label><input type="number" class="sv-input" id="f_people" min="1" value="1"></div>
  </div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 3: Injured Party -->
<div class="wizard-step" id="step-3">
<div class="card">
  <div class="step-title">Step 3 of 9</div>
  <div class="step-heading">Who was injured?</div>
  <label class="no-injury-toggle"><input type="checkbox" id="f_no_injury" onchange="toggleNoInjury()"> No injury occurred â€” skip injury details</label>
  <div id="injuryFields">
    <div class="sv-field"><label class="sv-label sv-required">Full Name</label><input type="text" class="sv-input" id="f_inj_name"></div>
    <div class="sv-field"><label class="sv-label sv-required">Job Title</label><input type="text" class="sv-input" id="f_inj_title"></div>
    <div class="sv-field"><label class="sv-label">Treatment</label>
      <div class="sv-radio-group" id="f_treatment">
        <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="treatment" value="refused">Refused</label>
        <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="treatment" value="first_aid">First Aid</label>
        <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="treatment" value="ems">EMS Transport</label>
        <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="treatment" value="self_transport">Self-Transport</label>
      </div>
    </div>
    <div class="sv-field"><label class="sv-label">Local Branch Contact</label><input type="text" class="sv-input" id="f_local_contact" placeholder="Name, phone, or email"></div>
  </div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 4: Injury Classification -->
<div class="wizard-step" id="step-4">
<div class="card">
  <div class="step-title">Step 4 of 9</div>
  <div class="step-heading">What type of injury occurred?</div>
  <div class="sv-field"><label class="sv-label">Injury Types (check all that apply)</label>
    <div class="cb-grid" id="f_injury_types">
      <label class="cb-item"><input type="checkbox" value="Abrasion/Scratch">Abrasion/Scratch</label>
      <label class="cb-item"><input type="checkbox" value="Amputation">Amputation</label>
      <label class="cb-item"><input type="checkbox" value="Bite">Bite</label>
      <label class="cb-item"><input type="checkbox" value="Bruise/Contusion">Bruise/Contusion</label>
      <label class="cb-item"><input type="checkbox" value="Burn">Burn (thermal)</label>
      <label class="cb-item"><input type="checkbox" value="Chemical/Allergic">Chemical/Allergic</label>
      <label class="cb-item"><input type="checkbox" value="Cold-Related">Cold-Related</label>
      <label class="cb-item"><input type="checkbox" value="Concussion">Concussion</label>
      <label class="cb-item"><input type="checkbox" value="Crush Injury">Crush Injury</label>
      <label class="cb-item"><input type="checkbox" value="Dislocation">Dislocation</label>
      <label class="cb-item"><input type="checkbox" value="Foreign Object">Foreign Object</label>
      <label class="cb-item"><input type="checkbox" value="Fracture/Break">Fracture/Break</label>
      <label class="cb-item"><input type="checkbox" value="Heat-Related">Heat-Related</label>
      <label class="cb-item"><input type="checkbox" value="Internal Injury">Internal Injury</label>
      <label class="cb-item"><input type="checkbox" value="Laceration/Cut">Laceration/Cut</label>
      <label class="cb-item"><input type="checkbox" value="Sting">Sting</label>
      <label class="cb-item"><input type="checkbox" value="Strain/Sprain">Strain/Sprain</label>
      <label class="cb-item"><input type="checkbox" value="Other">Other</label>
    </div>
  </div>
  <div class="sv-row">
    <div class="sv-field"><label class="sv-label">Severity</label><select class="sv-input sv-select" id="f_severity"><option value="">Select</option><option>Minor</option><option>Moderate</option><option>Severe</option><option>Life-Threatening</option></select></div>
    <div class="sv-field"><label class="sv-label">Body Part Injured</label><input type="text" class="sv-input" id="f_body_part" placeholder="Include left/right side"></div>
  </div>
  <div class="sv-field"><label class="sv-label">Comments</label><textarea class="sv-input sv-textarea" id="f_inj_comments" placeholder="Additional details about the injury..."></textarea></div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 5: What Happened -->
<div class="wizard-step" id="step-5">
<div class="card">
  <div class="step-title">Step 5 of 9</div>
  <div class="step-heading">Describe the incident</div>
  <div class="sv-field"><label class="sv-label">What was the employee doing right before the incident?</label><textarea class="sv-input sv-textarea" id="f_activity" placeholder="e.g., Walking to break room, operating forklift, carrying materials..."></textarea></div>
  <div class="sv-field"><label class="sv-label sv-required">Describe what happened in detail</label><textarea class="sv-input sv-textarea lg" id="f_description" placeholder="Include who was involved, what happened, when and where..."></textarea></div>
  <div class="sv-field"><label class="sv-label">What object, substance, or condition caused harm?</label><input type="text" class="sv-input" id="f_cause" placeholder="e.g., Wet floor, forklift, chemical splash"></div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 6: Witnesses -->
<div class="wizard-step" id="step-6">
<div class="card">
  <div class="step-title">Step 6 of 9</div>
  <div class="step-heading">Witness information</div>
  <div class="sv-helper" style="margin-bottom:1rem">Add up to 2 witnesses. If there are no witnesses, skip to the next step.</div>
  <div id="witnessContainer"></div>
  <button class="add-btn" id="addWitnessBtn" onclick="addWitness()">+ Add Witness</button>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 7: Motor Vehicle -->
<div class="wizard-step" id="step-7">
<div class="card">
  <div class="step-title">Step 7 of 9</div>
  <div class="step-heading">Did this incident involve a motor vehicle?</div>
  <div class="toggle-group">
    <button class="toggle-btn yes" onclick="toggleVehicle(true)">Yes</button>
    <button class="toggle-btn no selected" onclick="toggleVehicle(false)">No</button>
  </div>
  <div id="vehicleFields" style="display:none">
    <div class="sv-row"><div class="sv-field"><label class="sv-label">Make</label><input type="text" class="sv-input" id="f_v_make"></div><div class="sv-field"><label class="sv-label">Model</label><input type="text" class="sv-input" id="f_v_model"></div></div>
    <div class="sv-row-3"><div class="sv-field"><label class="sv-label">Color</label><input type="text" class="sv-input" id="f_v_color"></div><div class="sv-field"><label class="sv-label">Year</label><input type="text" class="sv-input" id="f_v_year"></div><div class="sv-field"><label class="sv-label">Plate</label><input type="text" class="sv-input" id="f_v_plate"></div></div>
    <div class="sv-field"><label class="sv-label">Damage Location</label><input type="text" class="sv-input" id="f_v_damage" placeholder="e.g., Front bumper, driver side door"></div>
  </div>
  <div id="noVehicleMsg"><div class="info-box">No motor vehicle involved. Continue to the next step.</div></div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 8: Root Cause -->
<div class="wizard-step" id="step-8">
<div class="card">
  <div class="step-title">Step 8 of 9</div>
  <div class="step-heading">Identify contributing factors</div>
  <div class="rc-section">
    <div class="rc-title">Unsafe Acts</div>
    <div class="rc-grid" id="f_rc_acts">
      <label class="cb-item"><input type="checkbox" value="Bypassing safety device">Bypassing safety device</label>
      <label class="cb-item"><input type="checkbox" value="Distracted while moving">Distracted while moving</label>
      <label class="cb-item"><input type="checkbox" value="Failure to follow procedure">Failure to follow procedure</label>
      <label class="cb-item"><input type="checkbox" value="Failure to use safety device">Failure to use safety device</label>
      <label class="cb-item"><input type="checkbox" value="Horseplay">Horseplay</label>
      <label class="cb-item"><input type="checkbox" value="Improper lifting">Improper lifting</label>
      <label class="cb-item"><input type="checkbox" value="Improper PPE use">Improper PPE use</label>
      <label class="cb-item"><input type="checkbox" value="Improper work technique">Improper work technique</label>
      <label class="cb-item"><input type="checkbox" value="Loss of vigilance">Loss of vigilance</label>
      <label class="cb-item"><input type="checkbox" value="Operating at improper speed">Operating at improper speed</label>
      <label class="cb-item"><input type="checkbox" value="Operating without authorization">Operating w/o authorization</label>
      <label class="cb-item"><input type="checkbox" value="Personal medical">Personal medical</label>
      <label class="cb-item"><input type="checkbox" value="Safety rule violation">Safety rule violation</label>
      <label class="cb-item"><input type="checkbox" value="Unnecessary haste">Unnecessary haste</label>
      <label class="cb-item"><input type="checkbox" value="Unsafe act of others">Unsafe act of others</label>
    </div>
  </div>
  <div class="rc-section">
    <div class="rc-title">Unsafe Conditions</div>
    <div class="rc-grid" id="f_rc_conditions">
      <label class="cb-item"><input type="checkbox" value="Congested work area">Congested work area</label>
      <label class="cb-item"><input type="checkbox" value="Construction hazard">Construction hazard</label>
      <label class="cb-item"><input type="checkbox" value="Equipment defect">Equipment defect</label>
      <label class="cb-item"><input type="checkbox" value="Excessive noise">Excessive noise</label>
      <label class="cb-item"><input type="checkbox" value="Fire hazard">Fire hazard</label>
      <label class="cb-item"><input type="checkbox" value="Hazardous substances">Hazardous substances</label>
      <label class="cb-item"><input type="checkbox" value="Improper lighting">Improper lighting</label>
      <label class="cb-item"><input type="checkbox" value="Improper material storage">Improper material storage</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate fall protection">Inadequate fall protection</label>
      <label class="cb-item"><input type="checkbox" value="Missing safety device">Missing safety device</label>
      <label class="cb-item"><input type="checkbox" value="Poor housekeeping">Poor housekeeping</label>
      <label class="cb-item"><input type="checkbox" value="Poor surface conditions">Poor surface conditions</label>
      <label class="cb-item"><input type="checkbox" value="Sharp edge">Sharp edge</label>
      <label class="cb-item"><input type="checkbox" value="Slippery conditions">Slippery conditions</label>
      <label class="cb-item"><input type="checkbox" value="Trip hazard">Trip hazard</label>
      <label class="cb-item"><input type="checkbox" value="Weather-related">Weather-related</label>
      <label class="cb-item"><input type="checkbox" value="Other unsafe condition">Other</label>
    </div>
  </div>
  <div class="rc-section">
    <div class="rc-title">Management Systems</div>
    <div class="rc-grid" id="f_rc_mgmt">
      <label class="cb-item"><input type="checkbox" value="Hazard not identified">Hazard not identified</label>
      <label class="cb-item"><input type="checkbox" value="Improper maintenance">Improper maintenance</label>
      <label class="cb-item"><input type="checkbox" value="Improper supervisor training">Improper supervisor training</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate equipment">Inadequate equipment</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate hiring practice">Inadequate hiring practice</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate supervision">Inadequate supervision</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate task planning">Inadequate task planning</label>
      <label class="cb-item"><input type="checkbox" value="Insufficient follow-up">Insufficient follow-up</label>
      <label class="cb-item"><input type="checkbox" value="Insufficient training">Insufficient training</label>
      <label class="cb-item"><input type="checkbox" value="Lack of procedure">Lack of procedure</label>
      <label class="cb-item"><input type="checkbox" value="Poor process design">Poor process design</label>
      <label class="cb-item"><input type="checkbox" value="PPE unavailable">PPE unavailable</label>
      <label class="cb-item"><input type="checkbox" value="Previously identified hazard">Previously identified hazard</label>
      <label class="cb-item"><input type="checkbox" value="Safety rule not enforced">Safety rule not enforced</label>
      <label class="cb-item"><input type="checkbox" value="Unrealistic schedule">Unrealistic schedule</label>
      <label class="cb-item"><input type="checkbox" value="Unsafe design">Unsafe design</label>
      <label class="cb-item"><input type="checkbox" value="Other management factor">Other</label>
    </div>
  </div>
  <div class="sv-field"><label class="sv-label">Immediate actions taken to mitigate the hazard</label><textarea class="sv-input sv-textarea" id="f_immediate" placeholder="What corrective actions were taken right away?"></textarea></div>
  <div class="sv-field"><label class="sv-label">What should be done to prevent recurrence?</label><textarea class="sv-input sv-textarea" id="f_prevention" placeholder="Recommended corrective and preventive actions..."></textarea></div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 9: OSHA Classification -->
<div class="wizard-step" id="step-9">
<div class="card">
  <div class="step-title">Step 9 of 9</div>
  <div class="step-heading">OSHA Recordkeeping Classification</div>
  <div class="info-box">Select the most serious outcome of this incident. If the outcome is not yet known, select "N/A - Pending" and update later.</div>

  <div class="sv-field"><label class="sv-label">Outcome Classification</label>
    <div id="f_osha_outcome">
      <label class="osha-card" onclick="selectOsha(this,'sel-red')"><input type="radio" name="osha_outcome" value="death"><span class="oc-title">Death</span><span class="oc-desc">Fatality resulting from the incident</span></label>
      <label class="osha-card" onclick="selectOsha(this,'selected')"><input type="radio" name="osha_outcome" value="days_away"><span class="oc-title">Days Away From Work</span><span class="oc-desc">Employee missed one or more days</span></label>
      <label class="osha-card" onclick="selectOsha(this,'selected')"><input type="radio" name="osha_outcome" value="job_transfer_restriction"><span class="oc-title">Job Transfer or Restriction</span><span class="oc-desc">Employee transferred or had restricted duties</span></label>
      <label class="osha-card" onclick="selectOsha(this,'selected')"><input type="radio" name="osha_outcome" value="other_recordable"><span class="oc-title">Other Recordable Case</span><span class="oc-desc">Medical treatment beyond first aid</span></label>
      <label class="osha-card" onclick="selectOsha(this,'sel-green')"><input type="radio" name="osha_outcome" value="na_pending"><span class="oc-title">N/A - Classification Pending</span><span class="oc-desc">Outcome not yet determined, can update later</span></label>
    </div>
  </div>

  <div class="sv-field"><label class="sv-label">Injury or Illness?</label>
    <div class="sv-radio-group" id="f_inj_or_ill">
      <label class="sv-radio-card" onclick="selectRadio(this);toggleIllnessType()"><input type="radio" name="inj_or_ill" value="injury">Injury</label>
      <label class="sv-radio-card" onclick="selectRadio(this);toggleIllnessType()"><input type="radio" name="inj_or_ill" value="illness">Illness</label>
    </div>
  </div>

  <div class="sv-field" id="illnessTypeField" style="display:none">
    <label class="sv-label">Illness Type</label>
    <select class="sv-input sv-select" id="f_illness_type"><option value="">Select</option><option value="skin_disorder">Skin Disorder</option><option value="respiratory">Respiratory Condition</option><option value="poisoning">Poisoning</option><option value="hearing_loss">Hearing Loss</option><option value="all_other">All Other Illnesses</option></select>
  </div>

  <div id="daysFields" style="display:none">
    <div class="sv-row">
      <div class="sv-field"><label class="sv-label">Days Away From Work</label><input type="number" class="sv-input" id="f_days_away" min="0" value="0"></div>
      <div class="sv-field"><label class="sv-label">Days of Restricted Duty</label><input type="number" class="sv-input" id="f_days_restricted" min="0" value="0"></div>
    </div>
  </div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-submit" onclick="submitReport()" id="submitBtn">Submit Incident Report</button></div>
</div>

<!-- SUCCESS SCREEN -->
<div class="success-screen" id="successScreen">
  <div class="success-icon">&#10003;</div>
  <h2>Incident Report Submitted</h2>
  <p>Case #<span id="successCaseNum"></span> has been recorded successfully.</p>
  <div class="success-actions">
    <button class="sa-primary" onclick="openIncidentFileFromLast()" id="successFileBtn">Continue to Incident File</button>
    <button class="sa-secondary" onclick="resetForm()">Submit Another Report</button>
    <button class="sa-secondary" onclick="showPanel('list')">View Past Reports</button>
    <button class="sa-secondary" onclick="downloadOSHA301FromLast()">Download OSHA 301 PDF</button>
  </div>
  <div id="successMedPacket" style="display:none"></div>
</div>

</div>
</div>

<!-- MEDICAL PACKET PANEL -->
<div class="panel" id="panel-medpacket">
<div class="content">
  <div id="medpacketContent"></div>
</div>
</div>

<!-- PAST REPORTS PANEL -->
<div class="panel" id="panel-list">
<div class="content">
  <div id="incidentsList"></div>
</div>
</div>

<!-- INCIDENT FILE PANEL -->
<div class="panel" id="panel-file">
<div class="content">

  <div class="if-selector">
    <label class="sv-label">Select Incident</label>
    <select class="sv-input sv-select" id="ifCaseSelect" onchange="loadIncidentFile()">
      <option value="">-- Choose an incident --</option>
    </select>
  </div>

  <div id="ifContent" style="display:none">
    <div class="if-header">
      <h2>Incident File</h2>
      <span class="if-id" id="ifDisplayId"></span>
    </div>

    <div class="sub-tabs" id="subTabs">
      <button class="sub-tab active" onclick="showSubTab('summary')">Summary</button>
      <button class="sub-tab" onclick="showSubTab('medical')">Medical</button>
      <button class="sub-tab" onclick="showSubTab('statements')">Statements</button>
      <button class="sub-tab" onclick="showSubTab('investigation')">Investigation</button>
      <button class="sub-tab" onclick="showSubTab('rtw')">Return to Work</button>
      <button class="sub-tab" onclick="showSubTab('documents')">Documents</button>
    </div>

    <!-- ========== SUMMARY SUB-TAB ========== -->
    <div class="sub-panel active" id="sp-summary">
      <div class="summary-grid" id="summaryCards"></div>
      <div class="card">
        <div class="card-title">Sub-Tab Status</div>
        <div class="status-tracker" id="statusTracker"></div>
      </div>
      <div class="card">
        <div class="card-title">Quick Links</div>
        <div class="ql-grid">
          <div class="ql-card" onclick="showSubTab('medical')"><div class="ql-icon">&#127973;</div><div class="ql-text">Find Approved Clinic</div></div>
          <div class="ql-card" onclick="showSubTab('medical')"><div class="ql-icon">&#128203;</div><div class="ql-text">Start WC Process</div></div>
          <div class="ql-card" onclick="showSubTab('documents')"><div class="ql-icon">&#128196;</div><div class="ql-text">Download OSHA 301</div></div>
        </div>
      </div>
    </div>

    <!-- ========== MEDICAL SUB-TAB ========== -->
    <div class="sub-panel" id="sp-medical">
      <div class="card">
        <div class="card-title">Medical Decision</div>
        <div class="info-box">Select whether the employee accepted a medical referral or refused treatment. Shared incident fields are auto-filled.</div>
        <div class="med-toggle">
          <button class="med-toggle-btn" onclick="setMedDecision('accepted')">Employee Accepted Referral</button>
          <button class="med-toggle-btn" onclick="setMedDecision('refused')">Employee Refused Treatment</button>
        </div>

        <!-- Auto-filled incident info -->
        <div style="background:rgba(37,99,235,0.06);border:1px solid rgba(37,99,235,0.15);border-radius:10px;padding:1rem;margin-bottom:1.25rem">
          <div style="font-size:.7rem;font-weight:600;color:#60a5fa;text-transform:uppercase;margin-bottom:.5rem">Auto-Filled from Incident</div>
          <div class="sv-row">
            <div class="sv-field" style="margin-bottom:.5rem"><label class="sv-label">Employee Name</label><input type="text" class="sv-input" id="med_emp_name" readonly style="opacity:.7"></div>
            <div class="sv-field" style="margin-bottom:.5rem"><label class="sv-label">Date of Injury</label><input type="text" class="sv-input" id="med_injury_date" readonly style="opacity:.7"></div>
          </div>
          <div class="sv-row">
            <div class="sv-field" style="margin-bottom:0"><label class="sv-label">Injury Description</label><input type="text" class="sv-input" id="med_injury_desc" readonly style="opacity:.7"></div>
            <div class="sv-field" style="margin-bottom:0"><label class="sv-label">Body Part</label><input type="text" class="sv-input" id="med_body_part" readonly style="opacity:.7"></div>
          </div>
        </div>

        <!-- Referral fields -->
        <div id="medReferralFields" style="display:none">
          <div class="step-heading" style="font-size:.9rem;margin-bottom:1rem">Medical Referral Details</div>
          <div class="sv-field">
            <label class="sv-label">Approved Clinic</label>
            <select class="sv-input sv-select" id="med_clinic_select" onchange="fillClinicFromSelect()">
              <option value="">-- Select approved clinic --</option>
            </select>
          </div>
          <div class="sv-row">
            <div class="sv-field"><label class="sv-label">Clinic Name</label><input type="text" class="sv-input" id="med_clinic_name"></div>
            <div class="sv-field"><label class="sv-label">Clinic Phone</label><input type="text" class="sv-input" id="med_clinic_phone"></div>
          </div>
          <div class="sv-field"><label class="sv-label">Clinic Address</label><input type="text" class="sv-input" id="med_clinic_address"></div>
          <div class="sv-field"><label class="sv-label">Authorization Notes</label><textarea class="sv-input sv-textarea" id="med_auth_notes" placeholder="Authorization details, referral instructions..."></textarea></div>
        </div>

        <!-- Refusal fields -->
        <div id="medRefusalFields" style="display:none">
          <div class="step-heading" style="font-size:.9rem;margin-bottom:1rem">Refusal of Treatment</div>
          <div class="sv-field"><label class="sv-label">Reason for Refusal</label><textarea class="sv-input sv-textarea" id="med_refusal_reason" placeholder="Why did the employee refuse treatment?"></textarea></div>
          <div class="sv-row">
            <div class="sv-field"><label class="sv-label">Employee Signature (type name)</label><input type="text" class="sv-input" id="med_refusal_sig" placeholder="Full legal name"></div>
            <div class="sv-field"><label class="sv-label">Witness Name</label><input type="text" class="sv-input" id="med_refusal_witness"></div>
          </div>
          <div class="sv-field"><label class="sv-label">Refusal Date</label><input type="date" class="sv-input" id="med_refusal_date"></div>
        </div>

        <div style="margin-top:1.25rem">
          <button class="wbtn wbtn-next" onclick="saveMedical()" id="saveMedBtn" style="padding:.6rem 1.5rem;font-size:.82rem">Save Medical Info</button>
        </div>
      </div>

      <!-- Approved Clinics -->
      <div class="card">
        <div class="card-title">Approved Occupational Clinics</div>
        <div id="clinicsList"><div style="color:#64748b;font-size:.82rem">Loading clinics...</div></div>
      </div>

      <!-- WC Quick-Start -->
      <div class="card">
        <div class="card-title">Workers' Comp Quick-Start</div>
        <div class="info-box">Follow this checklist after any incident requiring medical treatment. Check items off as you complete them.</div>
        <div class="wc-checklist" id="wcChecklist">
          <label class="wc-item" onclick="toggleWcItem(this)"><input type="checkbox" data-wc="0"> Notify HR immediately</label>
          <label class="wc-item" onclick="toggleWcItem(this)"><input type="checkbox" data-wc="1"> Provide employee with WC claim forms</label>
          <label class="wc-item" onclick="toggleWcItem(this)"><input type="checkbox" data-wc="2"> Route to approved Occupational Clinic</label>
          <label class="wc-item" onclick="toggleWcItem(this)"><input type="checkbox" data-wc="3"> Document medical facility and treatment provided</label>
          <label class="wc-item" onclick="toggleWcItem(this)"><input type="checkbox" data-wc="4"> Submit all WC paperwork within 24 hours</label>
          <label class="wc-item" onclick="toggleWcItem(this)"><input type="checkbox" data-wc="5"> HR coordinates follow-up with employee and insurance</label>
        </div>
        <div class="step-heading" style="font-size:.9rem;margin-bottom:1rem">WC Intake Fields</div>
        <div class="sv-row">
          <div class="sv-field"><label class="sv-label">WC Claim Number</label><input type="text" class="sv-input" id="wc_claim_number" placeholder="Assigned by insurer"></div>
          <div class="sv-field"><label class="sv-label">Insurance Carrier</label><input type="text" class="sv-input" id="wc_insurance_carrier"></div>
        </div>
        <div class="sv-row">
          <div class="sv-field"><label class="sv-label">Policy Number</label><input type="text" class="sv-input" id="wc_policy_number"></div>
          <div class="sv-field"><label class="sv-label">Date Employer Notified Insurer</label><input type="date" class="sv-input" id="wc_date_notified"></div>
        </div>
        <div class="sv-row">
          <div class="sv-field"><label class="sv-label">Date Employee Left Work</label><input type="date" class="sv-input" id="wc_date_left"></div>
          <div class="sv-field"><label class="sv-label">Date of Disability Onset</label><input type="date" class="sv-input" id="wc_date_disability"></div>
        </div>
        <div class="sv-field"><label class="sv-label">Notes</label><textarea class="sv-input sv-textarea" id="wc_notes" placeholder="Additional WC tracking notes..."></textarea></div>
        <button class="wbtn wbtn-next" onclick="saveWcInfo()" style="padding:.6rem 1.5rem;font-size:.82rem;margin-top:.5rem">Save WC Info</button>
      </div>
    </div>

    <!-- ========== STATEMENTS SUB-TAB ========== -->
    <div class="sub-panel" id="sp-statements">
      <div class="card">
        <div class="card-title">Employee's Own Account</div>
        <div class="info-box">Have the injured employee describe the incident in their own words.</div>
        <div class="sv-field"><label class="sv-label">Employee Name</label><input type="text" class="sv-input" id="stmt_emp_name"></div>
        <div class="sv-field"><label class="sv-label">Employee Title</label><input type="text" class="sv-input" id="stmt_emp_title"></div>
        <div class="sv-field"><label class="sv-label">Date</label><input type="date" class="sv-input" id="stmt_emp_date"></div>
        <div class="sv-field"><label class="sv-label">Statement</label><textarea class="sv-input sv-textarea lg" id="stmt_emp_text" placeholder="In the employee's own words, describe what happened..."></textarea></div>
        <button class="wbtn wbtn-next" onclick="saveEmployeeStatement()" style="padding:.6rem 1.5rem;font-size:.82rem">Save Employee Statement</button>
      </div>
      <div class="card">
        <div class="card-title">Witness Statements</div>
        <div class="sv-helper" style="margin-bottom:1rem">Add up to 4 witness statements for this incident.</div>
        <div id="witnessStmtContainer"></div>
        <button class="add-btn" id="addWitnessStmtBtn" onclick="addWitnessStatement()">+ Add Witness Statement</button>
      </div>
    </div>

    <!-- ========== INVESTIGATION SUB-TAB ========== -->
    <div class="sub-panel" id="sp-investigation">
      <div class="card">
        <div class="card-title">Supervisor Investigation</div>
        <div class="info-box">Complete the 5W analysis. Root cause data from the original report is available in the Contributing Factors section below.</div>
        <div class="sv-field"><label class="sv-label">Who was involved?</label><textarea class="sv-input sv-textarea" id="inv_who" placeholder="All persons involved, their roles, and their actions..."></textarea></div>
        <div class="sv-field"><label class="sv-label">What happened?</label><textarea class="sv-input sv-textarea" id="inv_what" placeholder="Detailed sequence of events leading to the incident..."></textarea></div>
        <div class="sv-row">
          <div class="sv-field"><label class="sv-label">When? (timeline details)</label><textarea class="sv-input sv-textarea" id="inv_when" placeholder="Timeline, shift, time of day..."></textarea></div>
          <div class="sv-field"><label class="sv-label">Where? (specific location details)</label><textarea class="sv-input sv-textarea" id="inv_where" placeholder="Exact location, conditions at scene..."></textarea></div>
        </div>
        <div class="sv-field"><label class="sv-label">Why? (root cause)</label><textarea class="sv-input sv-textarea lg" id="inv_why" placeholder="Underlying systemic causes and contributing factors..."></textarea></div>
      </div>

      <div class="card">
        <div class="card-title">Contributing Factors</div>
        <div class="info-box">Check all factors that contributed to the incident. Factors from the original report are pre-checked.</div>
        <div class="rc-section">
          <div class="rc-title">Unsafe Act</div>
          <div class="rc-grid" id="inv_cf_acts">
            <label class="cb-item"><input type="checkbox" value="Unsafe Act">Unsafe Act</label>
            <label class="cb-item"><input type="checkbox" value="Unsafe Condition">Unsafe Condition</label>
            <label class="cb-item"><input type="checkbox" value="Equipment Failure">Equipment Failure</label>
            <label class="cb-item"><input type="checkbox" value="Inadequate Training">Inadequate Training</label>
            <label class="cb-item"><input type="checkbox" value="Inadequate Procedure/SOP">Inadequate Procedure/SOP</label>
            <label class="cb-item"><input type="checkbox" value="PPE Issue">PPE Issue</label>
            <label class="cb-item"><input type="checkbox" value="Environmental/Weather">Environmental/Weather</label>
            <label class="cb-item"><input type="checkbox" value="Communication Breakdown">Communication Breakdown</label>
            <label class="cb-item"><input type="checkbox" value="Management System Deficiency">Management System Deficiency</label>
            <label class="cb-item"><input type="checkbox" value="Other">Other</label>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Corrective Action Tracker</div>
        <div id="caContainer"></div>
        <button class="add-btn" onclick="addCorrectiveAction()" style="margin-top:.5rem">+ Add Corrective Action</button>
      </div>

      <div class="card">
        <div class="closeout-section">
          <div class="co-title">Close-Out Approval</div>
          <div class="sv-row">
            <div class="sv-field"><label class="sv-label">Safety Manager</label><input type="text" class="sv-input" id="inv_closeout_safety" placeholder="Name"></div>
            <div class="sv-field"><label class="sv-label">Supervisor</label><input type="text" class="sv-input" id="inv_closeout_super" placeholder="Name"></div>
          </div>
          <div class="sv-field"><label class="sv-label">Close-Out Date</label><input type="date" class="sv-input" id="inv_closeout_date" style="max-width:250px"></div>
        </div>
        <div class="sv-field" style="margin-top:1rem">
          <label class="sv-label">Investigation Status</label>
          <div class="sv-radio-group" id="inv_status_group">
            <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="inv_status" value="open">Open</label>
            <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="inv_status" value="in_progress">In Progress</label>
            <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="inv_status" value="closed">Closed</label>
          </div>
        </div>
        <button class="wbtn wbtn-next" onclick="saveInvestigation()" style="padding:.6rem 1.5rem;font-size:.82rem;margin-top:1rem">Save Investigation</button>
      </div>
    </div>

    <!-- ========== RETURN TO WORK SUB-TAB ========== -->
    <div class="sub-panel" id="sp-rtw">
      <div class="card">
        <div class="card-title">Fit for Duty Certification</div>
        <div class="sv-field">
          <label class="sv-label">Clearance Status</label>
          <div class="rtw-toggle">
            <button class="rtw-btn" onclick="setRtwStatus('full')">Full Duty</button>
            <button class="rtw-btn" onclick="setRtwStatus('modified')">Modified / Light Duty</button>
            <button class="rtw-btn" onclick="setRtwStatus('not_cleared')">Not Yet Cleared</button>
          </div>
        </div>
        <div class="sv-row">
          <div class="sv-field"><label class="sv-label">Physician Name</label><input type="text" class="sv-input" id="rtw_physician"></div>
          <div class="sv-field"><label class="sv-label">Evaluation Date</label><input type="date" class="sv-input" id="rtw_eval_date"></div>
        </div>

        <div id="rtwModifiedFields" style="display:none">
          <div class="sv-field"><label class="sv-label">Restrictions</label><textarea class="sv-input sv-textarea" id="rtw_restrictions" placeholder="e.g., No lifting over 10 lbs, no prolonged standing..."></textarea></div>
          <div class="sv-field"><label class="sv-label">Modified Duty Description</label><textarea class="sv-input sv-textarea" id="rtw_modified_duties" placeholder="Describe the modified/light duty assignment..."></textarea></div>
          <div class="sv-row">
            <div class="sv-field"><label class="sv-label">Restriction Duration</label><input type="text" class="sv-input" id="rtw_duration" placeholder="e.g., 2 weeks, 30 days"></div>
            <div class="sv-field"><label class="sv-label">Next Follow-Up Date</label><input type="date" class="sv-input" id="rtw_followup"></div>
          </div>
        </div>

        <div class="sv-field"><label class="sv-label">Supervisor Name</label><input type="text" class="sv-input" id="rtw_supervisor"></div>
        <label class="no-injury-toggle" style="margin-top:.5rem"><input type="checkbox" id="rtw_acknowledged"> Employee acknowledged return-to-work plan</label>
        <button class="wbtn wbtn-next" onclick="saveRtw()" style="padding:.6rem 1.5rem;font-size:.82rem;margin-top:1rem">Save Return to Work</button>
      </div>
    </div>

    <!-- ========== DOCUMENTS SUB-TAB ========== -->
    <div class="sub-panel" id="sp-documents">
      <div class="card">
        <div class="card-title">Document Downloads</div>
        <div class="info-box">Generate and download pre-filled PDF documents for this incident. All forms are auto-populated from the data saved in this Incident File.</div>
        <div class="doc-card"><div class="dc-info"><div class="dc-name">OSHA 301 &mdash; Incident Report</div><div class="dc-desc">Official OSHA individual incident form</div></div><button onclick="downloadIfOsha301()">Download PDF</button></div>
        <div class="doc-card"><div class="dc-info"><div class="dc-name">Medical Referral Form</div><div class="dc-desc">Authorization for occupational clinic visit</div></div><button onclick="downloadIfMedReferral()">Download PDF</button></div>
        <div class="doc-card"><div class="dc-info"><div class="dc-name">Refusal of Treatment</div><div class="dc-desc">Employee treatment refusal acknowledgment</div></div><button onclick="downloadIfRefusal()">Download PDF</button></div>
        <div class="doc-card"><div class="dc-info"><div class="dc-name">Investigation Report</div><div class="dc-desc">Root cause analysis and corrective actions</div></div><button onclick="downloadIfInvestigation()">Download PDF</button></div>
        <div class="doc-card"><div class="dc-info"><div class="dc-name">Return to Work Clearance</div><div class="dc-desc">Fit for duty certification document</div></div><button onclick="downloadIfRtw()">Download PDF</button></div>
      </div>
    </div>

  </div><!-- /ifContent -->
</div><!-- /content -->
</div><!-- /panel-file -->

<!-- OSHA DOWNLOADS PANEL -->
<div class="panel" id="panel-reports">
<div class="content">
  <div class="card">
    <div class="step-title">OSHA Form Downloads</div>
    <div class="step-heading">Generate &amp; Download Official OSHA Forms</div>
    <div class="info-box">Select a year and download pre-filled OSHA recordkeeping forms. Data is pulled from your submitted incident reports.</div>

    <div class="sv-field">
      <label class="sv-label">Year</label>
      <select class="sv-input sv-select" id="oshaYear" style="max-width:200px"></select>
    </div>

    <div style="display:flex;flex-direction:column;gap:.75rem;margin-top:1.5rem">
      <div class="card" style="padding:1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem">
        <div><div style="font-size:.9rem;font-weight:700;color:#f1f5f9">OSHA 300 &mdash; Log of Injuries &amp; Illnesses</div><div style="font-size:.75rem;color:#64748b;margin-top:.15rem">All incidents for the selected year (10 per page)</div></div>
        <button class="wbtn wbtn-next" style="padding:.6rem 1.5rem;font-size:.8rem" onclick="downloadOSHA300()" id="btn300">Download 300 Log</button>
      </div>
      <div class="card" style="padding:1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem">
        <div><div style="font-size:.9rem;font-weight:700;color:#f1f5f9">OSHA 300A &mdash; Annual Summary</div><div style="font-size:.75rem;color:#64748b;margin-top:.15rem">Calculated totals and company information</div></div>
        <button class="wbtn wbtn-next" style="padding:.6rem 1.5rem;font-size:.8rem" onclick="downloadOSHA300A()" id="btn300a">Download 300A Summary</button>
      </div>
      <div class="card" style="padding:1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem">
        <div><div style="font-size:.9rem;font-weight:700;color:#f1f5f9">OSHA 301 &mdash; Individual Incident Report</div><div style="font-size:.75rem;color:#64748b;margin-top:.15rem">Select a specific case to download</div></div>
        <select class="sv-input sv-select" id="osha301Case" style="max-width:200px;display:inline-block"></select>
        <button class="wbtn wbtn-next" style="padding:.6rem 1.5rem;font-size:.8rem" onclick="downloadOSHA301()" id="btn301">Download 301</button>
      </div>
    </div>
    <div id="pdfStatus" style="margin-top:1rem;font-size:.82rem;color:#64748b"></div>
  </div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const sb = getSafetyVerseSupabase();

let currentStep=1;
const totalSteps=9;
const stepLabels=['Contact','Incident','Injured','Injury','Details','Witness','Vehicle','Root Cause','OSHA'];
let formData={};
let lastSubmitted=null;
let vehicleApplicable=false;
let witnessCount=0;
let isAdmin=false;

// Init
document.addEventListener('DOMContentLoaded',()=>{
  // â”€â”€ Admin Role Check â”€â”€
  const userRole=localStorage.getItem('safetyverse-role');
  isAdmin=(userRole==='Admin');
  if(!isAdmin){
    // Hide admin-only tabs
    document.getElementById('tabPastReports').style.display='none';
    document.getElementById('tabIncidentFile').style.display='none';
    document.getElementById('tabOshaDownloads').style.display='none';
    // Hide admin-only buttons on success screen
    const successFileBtn=document.getElementById('successFileBtn');
    if(successFileBtn)successFileBtn.style.display='none';
    // Hide "View Past Reports" and "Download OSHA 301" buttons for non-admin
    document.querySelectorAll('#successScreen .sa-secondary').forEach(btn=>{
      if(btn.textContent.includes('Past Reports')||btn.textContent.includes('OSHA 301'))btn.style.display='none';
    });
  }

  buildProgressBar();
  showStep(1);
  loadSiteLocations();
  const now=new Date();
  document.getElementById('f_date').value=now.toISOString().split('T')[0];
  document.getElementById('f_time').value=now.toTimeString().slice(0,5);
  document.getElementById('f_report_time').value=now.toLocaleString();

  // Auto-fill from triage params
  const params=new URLSearchParams(window.location.search);
  if(params.has('triage_severity')||params.has('triage_treatment')){
    // Map severity: red=Life-Threatening, amber=Moderate, green=Minor
    const sevMap={red:'Life-Threatening',amber:'Moderate',green:'Minor'};
    const triageSev=params.get('triage_severity');
    if(triageSev&&sevMap[triageSev]){
      document.getElementById('f_severity').value=sevMap[triageSev];
    }
    // Treatment type
    const triageTreat=params.get('triage_treatment');
    if(triageTreat){
      const radio=document.querySelector(`input[name="treatment"][value="${triageTreat}"]`);
      if(radio){radio.checked=true;radio.closest('.sv-radio-card').classList.add('selected');}
    }
    // Injury type checkbox
    const triageInj=params.get('triage_injury');
    if(triageInj){
      const cb=document.querySelector(`#f_injury_types input[value="${triageInj}"]`);
      if(cb)cb.checked=true;
    }
    // Show triage info banner
    const triageOutcome=params.get('triage_outcome');
    if(triageOutcome){
      const banner=document.createElement('div');
      banner.className='info-box';
      banner.style.margin='0 1rem 0';
      banner.innerHTML='<strong>Triage Data Applied:</strong> '+triageOutcome+' â€” Some fields have been pre-filled from the incident triage protocol.';
      document.getElementById('wizardContent').insertBefore(banner,document.getElementById('wizardContent').firstChild);
    }
  }
});

async function loadSiteLocations(){
  try{
    const{data,error}=await sb.from('site_locations').select('*').order('name',{ascending:true});
    if(error)throw error;
    const sel=document.getElementById('f_site');
    sel.innerHTML='<option value="">-- Select site location --</option>';
    (data||[]).forEach(s=>{sel.innerHTML+=`<option value="${s.name}">${s.name}</option>`;});
  }catch(e){console.error('Failed to load site locations:',e);}
}

function buildProgressBar(){
  const bar=document.getElementById('progressBar');
  bar.innerHTML=stepLabels.map((l,i)=>`<div class="wsi"><div class="wsc" id="wsc-${i+1}">${i+1}</div><div class="wsl" id="wsl-${i+1}">${l}</div></div>`).join('');
}

function updateProgress(){
  for(let i=1;i<=totalSteps;i++){
    const c=document.getElementById('wsc-'+i);
    const l=document.getElementById('wsl-'+i);
    c.className='wsc'+(i<currentStep?' done':i===currentStep?' active':'');
    l.className='wsl'+(i<currentStep?' done':i===currentStep?' active':'');
    if(i<currentStep)c.innerHTML='&#10003;';
    else c.textContent=i;
  }
}

function showStep(n){
  document.querySelectorAll('.wizard-step').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById('step-'+n);
  if(el){el.classList.add('active');el.scrollIntoView({behavior:'smooth',block:'start'});}
  updateProgress();
  // Skip step 4 if no injury
  if(n===4&&document.getElementById('f_no_injury').checked){
    if(currentStep>formData._prevStep)currentStep=5;
    else currentStep=3;
    showStep(currentStep);
    return;
  }
}

function nextStep(){
  if(!validateStep(currentStep))return;
  collectStepData(currentStep);
  formData._prevStep=currentStep;
  currentStep++;
  showStep(currentStep);
}

function prevStep(){
  collectStepData(currentStep);
  formData._prevStep=currentStep;
  currentStep--;
  // Skip step 4 if no injury
  if(currentStep===4&&document.getElementById('f_no_injury').checked)currentStep=3;
  showStep(currentStep);
}

function validateStep(n){
  let valid=true;
  const check=(id)=>{
    const el=document.getElementById(id);
    if(!el.value.trim()){el.classList.add('sv-error');valid=false;
      el.addEventListener('input',()=>el.classList.remove('sv-error'),{once:true});
    }
  };
  if(n===1){check('f_rp_name');check('f_rp_title');check('f_site');}
  if(n===2){check('f_date');check('f_time');}
  if(n===3&&!document.getElementById('f_no_injury').checked){check('f_inj_name');check('f_inj_title');}
  if(n===5){check('f_description');}
  if(!valid)showToast('Please fill in all required fields','error');
  return valid;
}

function collectStepData(n){
  const v=id=>{const el=document.getElementById(id);return el?el.value.trim():'';};
  const r=name=>{const el=document.querySelector(`input[name="${name}"]:checked`);return el?el.value:'';};
  const cbs=id=>[...document.querySelectorAll(`#${id} input:checked`)].map(c=>c.value);

  if(n===1){formData.reporting_party_name=v('f_rp_name');formData.reporting_party_title=v('f_rp_title');formData.site_location=v('f_site');}
  if(n===2){formData.incident_date=v('f_date');formData.incident_time=v('f_time');formData.specific_location=v('f_specific_loc');formData.visibility=v('f_visibility');formData.surface_conditions=v('f_surface');formData.temperature=v('f_temp');formData.num_people_involved=parseInt(v('f_people'))||1;}
  if(n===3){formData.no_injury=document.getElementById('f_no_injury').checked;formData.injured_name=v('f_inj_name');formData.injured_title=v('f_inj_title');formData.treatment_type=r('treatment');formData.local_contact=v('f_local_contact');}
  if(n===4){formData.injury_types=cbs('f_injury_types');formData.severity=v('f_severity');formData.body_part=v('f_body_part');formData.injury_comments=v('f_inj_comments');}
  if(n===5){formData.activity_before=v('f_activity');formData.incident_description=v('f_description');formData.what_caused_harm=v('f_cause');}
  if(n===6){formData.witnesses=collectWitnesses();}
  if(n===7){formData.motor_vehicle_applicable=vehicleApplicable;if(vehicleApplicable){formData.vehicle_info={make:v('f_v_make'),model:v('f_v_model'),color:v('f_v_color'),year:v('f_v_year'),plate:v('f_v_plate'),damage_location:v('f_v_damage')};}else{formData.vehicle_info={};}}
  if(n===8){formData.root_cause_unsafe_acts=cbs('f_rc_acts');formData.root_cause_unsafe_conditions=cbs('f_rc_conditions');formData.root_cause_management=cbs('f_rc_mgmt');formData.immediate_actions=v('f_immediate');formData.prevention_recommendations=v('f_prevention');}
  if(n===9){formData.osha_outcome=r('osha_outcome');formData.injury_or_illness=r('inj_or_ill');formData.illness_type=v('f_illness_type');formData.days_away_from_work=parseInt(v('f_days_away'))||0;formData.days_restricted_duty=parseInt(v('f_days_restricted'))||0;}
}

// UI Helpers
function selectRadio(el){
  el.closest('.sv-radio-group').querySelectorAll('.sv-radio-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  el.querySelector('input').checked=true;
}

function selectOsha(el,cls){
  document.querySelectorAll('#f_osha_outcome .osha-card').forEach(c=>{c.className='osha-card';});
  el.classList.add(cls);
  el.querySelector('input').checked=true;
  const val=el.querySelector('input').value;
  document.getElementById('daysFields').style.display=(val==='days_away'||val==='job_transfer_restriction')?'block':'none';
}

function toggleIllnessType(){
  const val=document.querySelector('input[name="inj_or_ill"]:checked');
  document.getElementById('illnessTypeField').style.display=(val&&val.value==='illness')?'block':'none';
}

function toggleNoInjury(){
  const checked=document.getElementById('f_no_injury').checked;
  document.getElementById('injuryFields').style.display=checked?'none':'block';
}

function toggleVehicle(yes){
  vehicleApplicable=yes;
  document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('selected'));
  if(yes)document.querySelector('.toggle-btn.yes').classList.add('selected');
  else document.querySelector('.toggle-btn.no').classList.add('selected');
  document.getElementById('vehicleFields').style.display=yes?'block':'none';
  document.getElementById('noVehicleMsg').style.display=yes?'none':'block';
}

// Witnesses
function addWitness(){
  if(witnessCount>=2)return;
  witnessCount++;
  const div=document.createElement('div');
  div.className='witness-block';
  div.id='witness-'+witnessCount;
  div.innerHTML=`<button class="remove-btn" onclick="removeWitness(${witnessCount})">Remove</button>
    <div style="font-size:.8rem;font-weight:700;color:#f59e0b;margin-bottom:.75rem">Witness ${witnessCount}</div>
    <div class="sv-row"><div class="sv-field"><label class="sv-label">Name</label><input type="text" class="sv-input w-name"></div>
    <div class="sv-field"><label class="sv-label">Contact Info</label><input type="text" class="sv-input w-contact"></div></div>
    <div class="sv-row"><div class="sv-field"><label class="sv-label">Statement Attached?</label>
    <div class="sv-radio-group"><label class="sv-radio-card" onclick="selectRadio(this)" style="min-width:60px"><input type="radio" name="w${witnessCount}_stmt" value="yes">Yes</label>
    <label class="sv-radio-card" onclick="selectRadio(this)" style="min-width:60px"><input type="radio" name="w${witnessCount}_stmt" value="no">No</label></div></div>
    <div class="sv-field"><label class="sv-label">If no, why?</label><input type="text" class="sv-input w-reason"></div></div>`;
  document.getElementById('witnessContainer').appendChild(div);
  if(witnessCount>=2)document.getElementById('addWitnessBtn').style.display='none';
}

function removeWitness(n){
  const el=document.getElementById('witness-'+n);
  if(el)el.remove();
  witnessCount--;
  document.getElementById('addWitnessBtn').style.display='inline-flex';
}

function collectWitnesses(){
  const witnesses=[];
  document.querySelectorAll('.witness-block').forEach(block=>{
    const name=block.querySelector('.w-name')?.value||'';
    const contact=block.querySelector('.w-contact')?.value||'';
    const stmt=block.querySelector('input[type="radio"]:checked')?.value||'';
    const reason=block.querySelector('.w-reason')?.value||'';
    if(name)witnesses.push({name,contact,statement_attached:stmt,reason_not:reason});
  });
  return witnesses;
}

// Submit
async function submitReport(){
  if(!validateStep(currentStep))return;
  collectStepData(currentStep);
  const btn=document.getElementById('submitBtn');
  btn.disabled=true;btn.textContent='Submitting...';

  const row={
    reporting_party_name:formData.reporting_party_name,
    reporting_party_title:formData.reporting_party_title,
    site_location:formData.site_location,
    incident_date:formData.incident_date||null,
    incident_time:formData.incident_time||null,
    specific_location:formData.specific_location,
    visibility:formData.visibility,
    surface_conditions:formData.surface_conditions,
    temperature:formData.temperature,
    num_people_involved:formData.num_people_involved,
    injured_name:formData.injured_name,
    injured_title:formData.injured_title,
    local_contact:formData.local_contact,
    treatment_type:formData.treatment_type||null,
    injury_types:formData.injury_types||[],
    severity:formData.severity,
    body_part:formData.body_part,
    injury_comments:formData.injury_comments,
    activity_before:formData.activity_before,
    incident_description:formData.incident_description,
    what_caused_harm:formData.what_caused_harm,
    witnesses:formData.witnesses||[],
    motor_vehicle_applicable:formData.motor_vehicle_applicable||false,
    vehicle_info:formData.vehicle_info||{},
    root_cause_unsafe_acts:formData.root_cause_unsafe_acts||[],
    root_cause_unsafe_conditions:formData.root_cause_unsafe_conditions||[],
    root_cause_management:formData.root_cause_management||[],
    immediate_actions:formData.immediate_actions,
    prevention_recommendations:formData.prevention_recommendations,
    osha_outcome:formData.osha_outcome||null,
    injury_or_illness:formData.injury_or_illness||null,
    illness_type:formData.illness_type||null,
    days_away_from_work:formData.days_away_from_work||0,
    days_restricted_duty:formData.days_restricted_duty||0,
    no_injury:formData.no_injury||false,
    status:'submitted'
  };

  try{
    const{data,error}=await sb.from('incidents').insert([row]).select();
    if(error)throw error;
    lastSubmitted=data[0];
    document.getElementById('successCaseNum').textContent=data[0].case_number;
    document.querySelectorAll('.wizard-step').forEach(s=>s.classList.remove('active'));
    document.getElementById('successScreen').style.display='block';
    showToast('Incident report submitted!','success');
    // Show medical packet on success screen if medical attention is needed
    if(needsMedicalPacket(lastSubmitted)){
      renderMedPacketHTML(lastSubmitted,'successMedPacket');
    }
  }catch(e){
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.textContent='Submit Incident Report';
}

function resetForm(){
  formData={};currentStep=1;witnessCount=0;vehicleApplicable=false;lastSubmitted=null;
  document.querySelectorAll('.sv-input,.sv-textarea').forEach(el=>{if(!el.readOnly)el.value='';});
  document.querySelectorAll('.sv-select').forEach(el=>el.selectedIndex=0);
  document.querySelectorAll('input[type="checkbox"],input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('.sv-radio-card,.osha-card').forEach(el=>el.className=el.className.replace(/selected|sel-red|sel-green/g,'').trim());
  document.getElementById('witnessContainer').innerHTML='';
  document.getElementById('addWitnessBtn').style.display='inline-flex';
  toggleVehicle(false);
  document.getElementById('f_no_injury').checked=false;
  toggleNoInjury();
  document.getElementById('illnessTypeField').style.display='none';
  document.getElementById('daysFields').style.display='none';
  document.getElementById('successScreen').style.display='none';
  document.getElementById('successMedPacket').style.display='none';
  document.getElementById('successMedPacket').innerHTML='';
  const now=new Date();
  document.getElementById('f_date').value=now.toISOString().split('T')[0];
  document.getElementById('f_time').value=now.toTimeString().slice(0,5);
  document.getElementById('f_report_time').value=now.toLocaleString();
  showStep(1);
}

// Panels & List
function showPanel(name){
  // Block non-admins from accessing restricted panels
  if(!isAdmin&&(name==='list'||name==='file'||name==='reports')){
    alert('Access denied â€” Admin role required to view this section.');
    return;
  }
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  const panelMap={wizard:'panel-wizard',medpacket:'panel-medpacket',list:'panel-list',file:'panel-file',reports:'panel-reports'};
  document.getElementById(panelMap[name]||'panel-wizard').classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(event&&event.target&&event.target.classList.contains('tab'))event.target.classList.add('active');
  else{
    const map={wizard:0,medpacket:1,list:2,file:3,reports:4};
    document.querySelectorAll('.tab')[map[name]||0].classList.add('active');
  }
  if(name==='list')loadIncidents();
  if(name==='reports')loadReportsPanel();
  if(name==='file')loadIncidentFileList();
  if(name==='medpacket')renderMedPacketHTML(lastSubmitted,'medpacketContent');
}

async function loadIncidents(){
  const container=document.getElementById('incidentsList');
  container.innerHTML='<div style="text-align:center;color:#64748b;padding:2rem">Loading...</div>';
  try{
    const{data,error}=await sb.from('incidents').select('*').order('created_at',{ascending:false});
    if(error)throw error;
    if(!data||data.length===0){
      container.innerHTML='<div style="text-align:center;color:#64748b;padding:3rem"><div style="font-size:2rem;margin-bottom:.5rem">&#128203;</div>No incident reports yet.<br>Use the form to create your first report.</div>';
      return;
    }
    container.innerHTML=data.map(inc=>{
      const badge=inc.osha_outcome==='na_pending'?'<span class="il-badge pending">Pending</span>':'<span class="il-badge recorded">Recorded</span>';
      const date=inc.incident_date?new Date(inc.incident_date).toLocaleDateString():'N/A';
      return `<div class="il-card" onclick="openIncidentFile('${inc.id}')" style="cursor:pointer" title="Open Incident File">
        <div class="il-top"><span class="il-case">Case #${inc.case_number}</span>${badge}</div>
        <div class="il-top"><span class="il-date">${date} ${inc.incident_time||''}</span><span class="il-date">${inc.site_location||''}</span></div>
        <div class="il-details">${inc.no_injury?'No injury reported':(inc.injured_name||'Unknown')+' &mdash; '+(inc.severity||'N/A')+' &mdash; '+(inc.injury_types||[]).join(', ')}</div>
        <div style="margin-top:.5rem;font-size:.78rem;color:#64748b">${(inc.incident_description||'').substring(0,120)}${(inc.incident_description||'').length>120?'...':''}</div>
        <div style="margin-top:.4rem;font-size:.7rem;color:#f59e0b;font-weight:600">Click to open Incident File &rarr;</div>
      </div>`;
    }).join('');
  }catch(e){
    container.innerHTML='<div style="text-align:center;color:#f87171;padding:2rem">Error loading: '+e.message+'</div>';
  }
}

function showToast(msg,type){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast '+type+' show';
  setTimeout(()=>t.classList.remove('show'),3000);
}

// ===== OSHA PDF EXPORT =====
const PDF_URL='../osha-forms/osha-forms-package.pdf';
let cachedPdfBytes=null;
let companySettings=null;

async function loadPdfBytes(){
  if(cachedPdfBytes)return cachedPdfBytes.slice(0);
  const resp=await fetch(PDF_URL);
  if(!resp.ok)throw new Error('Could not load OSHA PDF template');
  cachedPdfBytes=await resp.arrayBuffer();
  return cachedPdfBytes.slice(0);
}

async function loadCompanySettings(){
  if(companySettings)return companySettings;
  const{data,error}=await sb.from('company_settings').select('*').limit(1);
  if(error)throw error;
  companySettings=(data&&data.length>0)?data[0]:{};
  return companySettings;
}

async function loadReportsPanel(){
  const stat=document.getElementById('pdfStatus');
  stat.textContent='Loading data...';
  try{
    const{data,error}=await sb.from('incidents').select('case_number,incident_date,injured_name').order('incident_date',{ascending:false});
    if(error)throw error;
    // Populate year picker
    const yearSel=document.getElementById('oshaYear');
    const years=new Set();
    const curYear=new Date().getFullYear();
    years.add(curYear);
    (data||[]).forEach(d=>{if(d.incident_date)years.add(new Date(d.incident_date).getFullYear());});
    const sortedYears=[...years].sort((a,b)=>b-a);
    yearSel.innerHTML=sortedYears.map(y=>`<option value="${y}">${y}</option>`).join('');
    // Populate 301 case picker
    const caseSel=document.getElementById('osha301Case');
    if(!data||data.length===0){
      caseSel.innerHTML='<option value="">No incidents</option>';
    }else{
      caseSel.innerHTML=data.map(d=>`<option value="${d.case_number}">Case #${d.case_number} - ${d.injured_name||'No injury'}</option>`).join('');
    }
    stat.textContent=`${(data||[]).length} incident(s) available`;
  }catch(e){
    stat.textContent='Error: '+e.message;
  }
}

function setPdfField(form,name,value){
  try{
    const f=form.getTextField(name);
    if(f&&value)f.setText(String(value));
  }catch(e){}
}

function setPdfCheck(form,name,checked){
  try{
    const f=form.getCheckBox(name);
    if(f&&checked)f.check();
  }catch(e){}
}

// OSHA 301 â€” Individual Incident Report
async function downloadOSHA301(){
  const caseNum=document.getElementById('osha301Case').value;
  if(!caseNum){showToast('Select a case first','error');return;}
  const btn=document.getElementById('btn301');
  btn.disabled=true;btn.textContent='Generating...';
  try{
    const{data,error}=await sb.from('incidents').select('*').eq('case_number',parseInt(caseNum)).limit(1);
    if(error)throw error;
    if(!data||data.length===0)throw new Error('Incident not found');
    await generateOSHA301PDF(data[0]);
  }catch(e){
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.textContent='Download 301';
}

async function downloadOSHA301FromLast(){
  if(!lastSubmitted){showToast('No recent submission','error');return;}
  try{await generateOSHA301PDF(lastSubmitted);}
  catch(e){showToast('Error: '+e.message,'error');}
}

async function generateOSHA301PDF(inc){
  const pdfBytes=await loadPdfBytes();
  const co=await loadCompanySettings();
  const{PDFDocument}=PDFLib;
  const pdfDoc=await PDFDocument.load(pdfBytes);
  const form=pdfDoc.getForm();

  // Company/establishment info
  setPdfField(form,'301 Facility Name',co.establishment_name||'');
  setPdfField(form,'301 Facility Address Street',co.street||'');
  setPdfField(form,'301 Facility Address City',co.city||'');
  setPdfField(form,'301 Facility Address State',co.state||'');
  setPdfField(form,'301 Facility Address Zip',co.zip||'');

  // Employee / injured party
  setPdfField(form,'301 Full name',inc.injured_name||'');
  setPdfField(form,'301 Address Street',inc.local_contact||'');

  // Incident details
  if(inc.incident_date){
    const d=new Date(inc.incident_date);
    const ds=(d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear();
    setPdfField(form,'301 Date of Injury or Illness',ds);
  }
  if(inc.incident_time){
    const tp=inc.incident_time.split(':');
    let hr=parseInt(tp[0]),mn=tp[1]||'00',ampm='AM';
    if(hr>=12){ampm='PM';if(hr>12)hr-=12;}
    if(hr===0)hr=12;
    setPdfField(form,'301 Time of event',hr+':'+mn);
    // Time AMPM is a radio group
    try{const rg=form.getRadioGroup('301 Time of Event AMPM');if(rg)rg.select(ampm);}
    catch(e){setPdfField(form,'301 Time of Event AMPM',ampm);}
  }

  setPdfField(form,'301 Activity Prior to Event',inc.activity_before||'');
  setPdfField(form,'301 What Happened',inc.incident_description||'');

  // Build injury description
  let injDesc='';
  if(inc.injury_types&&inc.injury_types.length>0)injDesc=inc.injury_types.join(', ');
  if(inc.body_part)injDesc+=(injDesc?' â€” ':'')+inc.body_part;
  if(inc.injury_comments)injDesc+=(injDesc?'. ':'')+inc.injury_comments;
  setPdfField(form,'301 Describe Injury or Illness',injDesc);

  setPdfField(form,'301 What Harmed Employee',inc.what_caused_harm||'');
  setPdfField(form,'301 Case Number',String(inc.case_number||''));

  // Treatment - ER and Hospitalized are radio/check buttons
  try{
    if(inc.treatment_type==='EMS'||inc.treatment_type==='Self-Transport'){
      const erField=form.getCheckBox('301 ER');
      if(erField)erField.check();
    }
  }catch(e){try{
    if(inc.treatment_type==='EMS'||inc.treatment_type==='Self-Transport'){
      const rg=form.getRadioGroup('301 ER');
      if(rg)rg.select('Yes');
    }
  }catch(e2){}}

  // Completed by
  setPdfField(form,'301 Completed by',inc.reporting_party_name||'');
  setPdfField(form,'301 Title',inc.reporting_party_title||'');
  setPdfField(form,'301 Phone',co.phone||'');
  const today=new Date();
  setPdfField(form,'301 Date',(today.getMonth()+1)+'/'+today.getDate()+'/'+today.getFullYear());

  // Flatten form so filled values render as visible text
  form.flatten();
  // Extract only 301 pages (pages 10-11 = index 9-10)
  const newDoc=await PDFDocument.create();
  const pages=await newDoc.copyPages(pdfDoc,[9,10]);
  pages.forEach(p=>newDoc.addPage(p));
  const outBytes=await newDoc.save();
  downloadBlob(outBytes,'OSHA-301-Case-'+inc.case_number+'.pdf');
  showToast('OSHA 301 downloaded!','success');
}

// OSHA 300 â€” Log of Work-Related Injuries and Illnesses
async function downloadOSHA300(){
  const year=document.getElementById('oshaYear').value;
  if(!year){showToast('Select a year','error');return;}
  const btn=document.getElementById('btn300');
  btn.disabled=true;btn.textContent='Generating...';
  try{
    const startDate=year+'-01-01';
    const endDate=year+'-12-31';
    const{data,error}=await sb.from('incidents').select('*')
      .gte('incident_date',startDate).lte('incident_date',endDate)
      .order('incident_date',{ascending:true});
    if(error)throw error;
    if(!data||data.length===0){showToast('No incidents for '+year,'error');btn.disabled=false;btn.textContent='Download 300 Log';return;}
    await generateOSHA300PDF(data,year);
  }catch(e){
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.textContent='Download 300 Log';
}

async function generateOSHA300PDF(incidents,year){
  const pdfBytes=await loadPdfBytes();
  const co=await loadCompanySettings();
  const{PDFDocument}=PDFLib;
  const pdfDoc=await PDFDocument.load(pdfBytes);
  const form=pdfDoc.getForm();

  // Establishment header
  setPdfField(form,'Log of Injury/Illness Establishment name',co.establishment_name||'');
  setPdfField(form,'Log of Injury/Illness City',co.city||'');
  setPdfField(form,'Log of Injury/Illness State',co.state||'');
  setPdfField(form,'Log of Injury/Illness Year',String(year));

  // Fill rows (max 10 per page in the 300 form)
  const maxRows=Math.min(incidents.length,10);
  for(let i=0;i<maxRows;i++){
    const inc=incidents[i];
    const n=i+1;
    setPdfField(form,'Case No. '+n,String(inc.case_number||''));
    setPdfField(form,'Employee\'s Name '+n,inc.injured_name||'N/A');
    setPdfField(form,'Job Title '+n,inc.injured_title||'');
    if(inc.incident_date){
      const d=new Date(inc.incident_date);
      setPdfField(form,'Date of injury or Illness month '+n,String(d.getMonth()+1));
      setPdfField(form,'Date of injury or illness day '+n,String(d.getDate()));
    }
    setPdfField(form,'Where the Event Occurred '+n,inc.specific_location||'');

    // Build description
    let desc='';
    if(inc.injury_types&&inc.injury_types.length>0)desc=inc.injury_types.join(', ');
    if(inc.body_part)desc+=(desc?' - ':'')+inc.body_part;
    setPdfField(form,'Injury or Illness Description '+n,desc);

    // Days
    setPdfField(form,'Number of days injured or ill away from work '+n,String(inc.days_away_from_work||0));
    setPdfField(form,'On job transfer or restriction '+n,String(inc.days_restricted_duty||0));

    // Outcome checkboxes - Group[N] radio for G/H/I/J columns
    try{
      const rg=form.getRadioGroup('Group'+n);
      if(rg){
        const outcome=inc.osha_outcome;
        if(outcome==='death')rg.select('G');
        else if(outcome==='days_away')rg.select('H');
        else if(outcome==='job_transfer_restriction')rg.select('I');
        else if(outcome==='other_recordable')rg.select('J');
      }
    }catch(e){}

    // Injury vs Illness type - Group[N]a radio
    try{
      const rga=form.getRadioGroup('Group'+n+'a');
      if(rga){
        if(inc.injury_or_illness==='injury')rga.select('1');
        else if(inc.injury_or_illness==='illness'){
          const it=inc.illness_type||'';
          if(it.includes('Skin'))rga.select('2');
          else if(it.includes('Respiratory'))rga.select('3');
          else if(it.includes('Poison'))rga.select('4');
          else if(it.includes('Hear'))rga.select('5');
          else rga.select('6');
        }
      }
    }catch(e){}
  }

  // Column totals for 300 log
  let totDeath=0,totDaysAway=0,totJobTrans=0,totOtherRec=0;
  let totDA=0,totRD=0;
  let totInj=0,totSkin=0,totResp=0,totPoison=0,totHear=0,totAllOther=0;
  incidents.forEach(i=>{
    if(i.osha_outcome==='death')totDeath++;
    else if(i.osha_outcome==='days_away')totDaysAway++;
    else if(i.osha_outcome==='job_transfer_restriction')totJobTrans++;
    else if(i.osha_outcome==='other_recordable')totOtherRec++;
    totDA+=(i.days_away_from_work||0);totRD+=(i.days_restricted_duty||0);
    if(i.injury_or_illness==='injury')totInj++;
    else if(i.injury_or_illness==='illness'){
      const it=i.illness_type||'';
      if(it.includes('Skin'))totSkin++;
      else if(it.includes('Respiratory'))totResp++;
      else if(it.includes('Poison'))totPoison++;
      else if(it.includes('Hear'))totHear++;
      else totAllOther++;
    }
  });
  setPdfField(form,'Death Total',String(totDeath));
  setPdfField(form,'Days away from work Total',String(totDaysAway));
  setPdfField(form,'Job transfer or restriction Total',String(totJobTrans));
  setPdfField(form,'Other recordable cases Total',String(totOtherRec));
  setPdfField(form,'Number of days injured or ill away from work Total',String(totDA));
  setPdfField(form,'On job transfer or restriction Total',String(totRD));
  setPdfField(form,'Injury Total',String(totInj));
  setPdfField(form,'Skin Disorder Total',String(totSkin));
  setPdfField(form,'Respiratory Cond Total',String(totResp));
  setPdfField(form,'Poisoning Total',String(totPoison));
  setPdfField(form,'Hearling Loss Total',String(totHear));
  setPdfField(form,'All other Total',String(totAllOther));

  // If >10 incidents, note it
  if(incidents.length>10){
    showToast('Note: Only first 10 of '+incidents.length+' incidents shown on single 300 form page.','info');
  }

  // Flatten form so filled values render as visible text
  form.flatten();
  // Extract only 300 pages (pages 7-8 = index 6-7)
  const newDoc=await PDFDocument.create();
  const pages=await newDoc.copyPages(pdfDoc,[6,7]);
  pages.forEach(p=>newDoc.addPage(p));
  const outBytes=await newDoc.save();
  downloadBlob(outBytes,'OSHA-300-Log-'+year+'.pdf');
  showToast('OSHA 300 Log downloaded!','success');
}

// OSHA 300A â€” Summary of Work-Related Injuries and Illnesses
async function downloadOSHA300A(){
  const year=document.getElementById('oshaYear').value;
  if(!year){showToast('Select a year','error');return;}
  const btn=document.getElementById('btn300a');
  btn.disabled=true;btn.textContent='Generating...';
  try{
    const startDate=year+'-01-01';
    const endDate=year+'-12-31';
    const{data,error}=await sb.from('incidents').select('*')
      .gte('incident_date',startDate).lte('incident_date',endDate);
    if(error)throw error;
    const co=await loadCompanySettings();
    await generateOSHA300APDF(data||[],year,co);
  }catch(e){
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.textContent='Download 300A Summary';
}

async function generateOSHA300APDF(incidents,year,co){
  const pdfBytes=await loadPdfBytes();
  const{PDFDocument}=PDFLib;
  const pdfDoc=await PDFDocument.load(pdfBytes);
  const form=pdfDoc.getForm();

  // Company info
  setPdfField(form,'Summary of Injury/Illness Establishment Name',co.establishment_name||'');
  setPdfField(form,'Summary of Injury/Illness Street',co.street||'');
  setPdfField(form,'Summary of Injury/Illness City',co.city||'');
  setPdfField(form,'Summary of Injury/Illness State',co.state||'');
  setPdfField(form,'Summary of Injury/Illness Zip',co.zip||'');
  setPdfField(form,'Summary of Injury/Illness Industry description',co.industry_description||'');
  setPdfField(form,'Summary of Injury/Illness NAICS',co.naics_code||'');
  setPdfField(form,'Summary of Injury/Illness Phone',co.phone||'');
  setPdfField(form,'Summary of Injury/Illness Year',String(year));
  setPdfField(form,'Summary of Injury/Illness Annual avg num of employees',String(co.avg_employees||''));
  setPdfField(form,'Summary of Injury/Illness Total hours worked by all employees last year',String(co.total_hours_worked||''));

  // Calculate totals from incidents
  let deaths=0,daysAway=0,jobTransfer=0,otherRec=0;
  let totalDaysAway=0,totalDaysRestrict=0;
  let injuries=0,skinDis=0,respCond=0,poison=0,hearLoss=0,allOther=0;

  incidents.forEach(inc=>{
    const oc=inc.osha_outcome;
    if(oc==='death')deaths++;
    else if(oc==='days_away')daysAway++;
    else if(oc==='job_transfer_restriction')jobTransfer++;
    else if(oc==='other_recordable')otherRec++;

    totalDaysAway+=(inc.days_away_from_work||0);
    totalDaysRestrict+=(inc.days_restricted_duty||0);

    if(inc.injury_or_illness==='injury')injuries++;
    else if(inc.injury_or_illness==='illness'){
      const it=inc.illness_type||'';
      if(it.includes('Skin'))skinDis++;
      else if(it.includes('Respiratory'))respCond++;
      else if(it.includes('Poison'))poison++;
      else if(it.includes('Hear'))hearLoss++;
      else allOther++;
    }
  });

  const totalCases=deaths+daysAway+jobTransfer+otherRec;

  // 300A Summary fields
  setPdfField(form,'Total Deaths Summary',String(deaths));
  setPdfField(form,'Days away from work Summary',String(daysAway));
  setPdfField(form,'Job transfer or restriction Summary',String(jobTransfer));
  setPdfField(form,'Other recordable cases Summary',String(otherRec));
  setPdfField(form,'Injury Summary',String(injuries));
  setPdfField(form,'Skin Disorder Summary',String(skinDis));
  setPdfField(form,'Respiratory Cond Summary',String(respCond));
  setPdfField(form,'Poisoning Summary',String(poison));
  setPdfField(form,'Hearing Loss Summary',String(hearLoss));
  setPdfField(form,'All other Summary',String(allOther));
  setPdfField(form,'Number of days injured or ill away from work Summary',String(totalDaysAway));
  setPdfField(form,'On job transfer or restriction Summary',String(totalDaysRestrict));

  // Incidence rates (if hours data available)
  if(co.total_hours_worked&&co.total_hours_worked>0){
    const hrs=co.total_hours_worked;
    const tcr=((totalCases*200000)/hrs).toFixed(1);
    const dart=(((daysAway+jobTransfer)*200000)/hrs).toFixed(1);
    setPdfField(form,'Total recordable case rate',tcr);
    setPdfField(form,'DART incidence rate',dart);
  }

  // Sign date
  const today=new Date();
  setPdfField(form,'Summary of Injury/Illness Date',(today.getMonth()+1)+'/'+today.getDate()+'/'+today.getFullYear());

  // Flatten form so filled values render as visible text
  form.flatten();
  // Extract only 300A pages (pages 8-9 = index 7-8)
  const newDoc=await PDFDocument.create();
  const pages=await newDoc.copyPages(pdfDoc,[7,8]);
  pages.forEach(p=>newDoc.addPage(p));
  const outBytes=await newDoc.save();
  downloadBlob(outBytes,'OSHA-300A-Summary-'+year+'.pdf');
  showToast('OSHA 300A Summary downloaded!','success');
}

function downloadBlob(bytes,filename){
  const blob=new Blob([bytes],{type:'application/pdf'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===================================================================
// INCIDENT FILE SYSTEM
// ===================================================================

let currentIncident=null;
let currentMedical=null;
let currentInvestigation=null;
let currentRtw=null;
let currentStatements=[];
let approvedClinics=[];
let ifWitnessCount=0;
let caCount=0;
let rtwStatus='';
let medDecision='';

// --- Sub-Tab Navigation ---
function showSubTab(name){
  document.querySelectorAll('.sub-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('sp-'+name).classList.add('active');
  document.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active'));
  if(event&&event.target&&event.target.classList.contains('sub-tab'))event.target.classList.add('active');
  else{
    const map={summary:0,medical:1,statements:2,investigation:3,rtw:4,documents:5};
    document.querySelectorAll('.sub-tab')[map[name]].classList.add('active');
  }
}

// --- Load Incident File ---
async function loadIncidentFileList(){
  try{
    const{data,error}=await sb.from('incidents').select('id,case_number,incident_date,injured_name,site_location').order('created_at',{ascending:false});
    if(error)throw error;
    const sel=document.getElementById('ifCaseSelect');
    sel.innerHTML='<option value="">-- Choose an incident --</option>';
    (data||[]).forEach(inc=>{
      const d=inc.incident_date?new Date(inc.incident_date).toLocaleDateString():'';
      const yr=inc.incident_date?new Date(inc.incident_date).getFullYear():new Date().getFullYear();
      const displayId=yr+'-'+String(inc.case_number).padStart(4,'0');
      sel.innerHTML+=`<option value="${inc.id}">${displayId} â€” ${inc.injured_name||'No injury'} (${d}, ${inc.site_location||''})</option>`;
    });
  }catch(e){console.error('Failed to load incident list:',e);}
}

async function loadIncidentFile(){
  const id=document.getElementById('ifCaseSelect').value;
  if(!id){document.getElementById('ifContent').style.display='none';return;}
  document.getElementById('ifContent').style.display='block';

  try{
    // Load incident
    const{data:inc,error:ie}=await sb.from('incidents').select('*').eq('id',id).single();
    if(ie)throw ie;
    currentIncident=inc;
    const yr=inc.incident_date?new Date(inc.incident_date).getFullYear():new Date().getFullYear();
    const displayId=yr+'-'+String(inc.case_number).padStart(4,'0');
    document.getElementById('ifDisplayId').textContent='Incident #'+displayId;

    // Load related data in parallel
    const[medRes,stmtRes,invRes,rtwRes]=await Promise.all([
      sb.from('incident_medical').select('*').eq('incident_id',inc.id).maybeSingle(),
      sb.from('incident_statements').select('*').eq('incident_id',inc.id).order('created_at',{ascending:true}),
      sb.from('incident_investigation').select('*').eq('incident_id',inc.id).maybeSingle(),
      sb.from('incident_rtw').select('*').eq('incident_id',inc.id).maybeSingle()
    ]);

    currentMedical=medRes.data||null;
    currentStatements=stmtRes.data||[];
    currentInvestigation=invRes.data||null;
    currentRtw=rtwRes.data||null;

    // Load clinics
    await loadApprovedClinics();

    // Populate all sub-tabs
    populateSummary();
    populateMedical();
    populateStatements();
    populateInvestigation();
    populateRtw();

    // Show summary tab
    showSubTab('summary');

  }catch(e){
    showToast('Error loading incident file: '+e.message,'error');
    console.error(e);
  }
}

// --- Summary Sub-Tab ---
function populateSummary(){
  const inc=currentIncident;
  if(!inc)return;
  const date=inc.incident_date?new Date(inc.incident_date).toLocaleDateString():'N/A';
  const sevClass=inc.severity==='Life-Threatening'||inc.severity==='Severe'?'red':inc.severity==='Moderate'?'amber':'green';
  const treatment=inc.treatment_type?inc.treatment_type.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase()):'N/A';

  document.getElementById('summaryCards').innerHTML=`
    <div class="summary-card"><div class="sc-label">Date</div><div class="sc-value">${date}</div></div>
    <div class="summary-card"><div class="sc-label">Location</div><div class="sc-value">${inc.site_location||'N/A'}</div></div>
    <div class="summary-card"><div class="sc-label">Severity</div><div class="sc-value ${sevClass}">${inc.severity||'N/A'}</div></div>
    <div class="summary-card"><div class="sc-label">Injured</div><div class="sc-value">${inc.no_injury?'No injury':inc.injured_name||'N/A'}</div></div>
    <div class="summary-card"><div class="sc-label">Treatment</div><div class="sc-value">${inc.no_injury?'N/A':treatment}</div></div>
    <div class="summary-card"><div class="sc-label">Reported By</div><div class="sc-value">${inc.reporting_party_name||'N/A'}</div></div>
  `;

  // Status tracker
  const tabs=[
    {name:'Medical',done:!!currentMedical},
    {name:'Statements',done:currentStatements.length>0},
    {name:'Investigation',done:!!currentInvestigation},
    {name:'Return to Work',done:!!currentRtw},
    {name:'OSHA Classification',done:inc.osha_outcome&&inc.osha_outcome!=='na_pending'},
  ];
  document.getElementById('statusTracker').innerHTML=tabs.map(t=>{
    const cls=t.done?'done':'empty';
    return `<div class="st-item"><div class="st-dot ${cls}"></div>${t.name}</div>`;
  }).join('');
}

// --- Medical Sub-Tab ---
async function loadApprovedClinics(){
  try{
    const{data,error}=await sb.from('approved_clinics').select('*').order('is_primary',{ascending:false});
    if(error)throw error;
    approvedClinics=data||[];
  }catch(e){approvedClinics=[];}
}

function populateMedical(){
  const inc=currentIncident;
  if(!inc)return;

  // Auto-fill
  document.getElementById('med_emp_name').value=inc.injured_name||'';
  document.getElementById('med_injury_date').value=inc.incident_date||'';
  document.getElementById('med_injury_desc').value=(inc.injury_types||[]).join(', ');
  document.getElementById('med_body_part').value=inc.body_part||'';

  // Filter clinics by incident site
  const siteClinics=approvedClinics.filter(c=>c.site_location===inc.site_location);

  // Clinic dropdown
  const clinicSel=document.getElementById('med_clinic_select');
  clinicSel.innerHTML='<option value="">-- Select approved clinic --</option>';
  siteClinics.forEach(c=>{
    clinicSel.innerHTML+=`<option value="${c.id}">${c.name}${c.is_primary?' (Primary)':''}</option>`;
  });

  // Clinic list
  const clinicList=document.getElementById('clinicsList');
  if(siteClinics.length===0){
    clinicList.innerHTML='<div style="color:#64748b;font-size:.82rem">No approved clinics for '+(inc.site_location||'this site')+'. Add clinics in <a href="../settings/index.html" style="color:#f59e0b">Settings</a>.</div>';
  }else{
    clinicList.innerHTML=siteClinics.map(c=>{
      const addr=[c.address,c.city,c.state,c.zip].filter(Boolean).join(', ');
      const mapsUrl='https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(addr);
      return `<div class="clinic-card${c.is_primary?' primary':''}">
        <div>
          ${c.is_primary?'<div class="cc-primary">Primary Clinic</div>':''}
          <div class="cc-name">${c.name}</div>
          <div class="cc-detail">${addr}</div>
          ${c.hours?'<div class="cc-detail">Hours: '+c.hours+'</div>':''}
          ${c.phone?'<div class="cc-detail">Phone: '+c.phone+'</div>':''}
        </div>
        <div class="cc-actions">
          ${c.phone?'<a href="tel:'+c.phone+'" class="cc-call">Call</a>':''}
          <a href="${mapsUrl}" target="_blank" class="cc-dir">Directions</a>
        </div>
      </div>`;
    }).join('');
  }

  // Load existing medical data
  if(currentMedical){
    const m=currentMedical;
    if(m.medical_decision)setMedDecision(m.medical_decision);
    if(m.clinic_name)document.getElementById('med_clinic_name').value=m.clinic_name;
    if(m.clinic_phone)document.getElementById('med_clinic_phone').value=m.clinic_phone;
    if(m.clinic_address)document.getElementById('med_clinic_address').value=m.clinic_address;
    if(m.authorization_notes)document.getElementById('med_auth_notes').value=m.authorization_notes;
    if(m.refusal_reason)document.getElementById('med_refusal_reason').value=m.refusal_reason;
    if(m.refusal_employee_signature)document.getElementById('med_refusal_sig').value=m.refusal_employee_signature;
    if(m.refusal_witness_name)document.getElementById('med_refusal_witness').value=m.refusal_witness_name;
    if(m.refusal_date)document.getElementById('med_refusal_date').value=m.refusal_date;
    if(m.wc_claim_number)document.getElementById('wc_claim_number').value=m.wc_claim_number;
    if(m.wc_insurance_carrier)document.getElementById('wc_insurance_carrier').value=m.wc_insurance_carrier;
    if(m.wc_policy_number)document.getElementById('wc_policy_number').value=m.wc_policy_number;
    if(m.wc_date_insurer_notified)document.getElementById('wc_date_notified').value=m.wc_date_insurer_notified;
    if(m.wc_date_left_work)document.getElementById('wc_date_left').value=m.wc_date_left_work;
    if(m.wc_date_disability_onset)document.getElementById('wc_date_disability').value=m.wc_date_disability_onset;
    if(m.wc_notes)document.getElementById('wc_notes').value=m.wc_notes;
    // WC checklist
    if(m.wc_checklist&&Array.isArray(m.wc_checklist)){
      document.querySelectorAll('#wcChecklist input[type="checkbox"]').forEach(cb=>{
        const idx=parseInt(cb.dataset.wc);
        cb.checked=m.wc_checklist.includes(idx);
        if(cb.checked)cb.closest('.wc-item').classList.add('checked');
      });
    }
  }else{
    // Reset
    medDecision='';
    document.querySelectorAll('.med-toggle-btn').forEach(b=>b.className='med-toggle-btn');
    document.getElementById('medReferralFields').style.display='none';
    document.getElementById('medRefusalFields').style.display='none';
    ['med_clinic_name','med_clinic_phone','med_clinic_address','med_auth_notes','med_refusal_reason','med_refusal_sig','med_refusal_witness','med_refusal_date','wc_claim_number','wc_insurance_carrier','wc_policy_number','wc_date_notified','wc_date_left','wc_date_disability','wc_notes'].forEach(id=>{
      const el=document.getElementById(id);if(el)el.value='';
    });
    document.querySelectorAll('#wcChecklist input[type="checkbox"]').forEach(cb=>{cb.checked=false;cb.closest('.wc-item').classList.remove('checked');});
  }
}

function setMedDecision(decision){
  medDecision=decision;
  document.querySelectorAll('.med-toggle-btn').forEach(b=>b.className='med-toggle-btn');
  if(decision==='accepted'){
    document.querySelectorAll('.med-toggle-btn')[0].classList.add('active-accept');
    document.getElementById('medReferralFields').style.display='block';
    document.getElementById('medRefusalFields').style.display='none';
  }else{
    document.querySelectorAll('.med-toggle-btn')[1].classList.add('active-refuse');
    document.getElementById('medReferralFields').style.display='none';
    document.getElementById('medRefusalFields').style.display='block';
  }
}

function fillClinicFromSelect(){
  const id=document.getElementById('med_clinic_select').value;
  const clinic=approvedClinics.find(c=>c.id===id);
  if(clinic){
    document.getElementById('med_clinic_name').value=clinic.name||'';
    document.getElementById('med_clinic_phone').value=clinic.phone||'';
    const addr=[clinic.address,clinic.city,clinic.state,clinic.zip].filter(Boolean).join(', ');
    document.getElementById('med_clinic_address').value=addr;
  }
}

function toggleWcItem(el){
  const cb=el.querySelector('input[type="checkbox"]');
  // Toggle happens naturally. Just update visual
  setTimeout(()=>{
    if(cb.checked)el.classList.add('checked');
    else el.classList.remove('checked');
  },10);
}

async function saveMedical(){
  if(!currentIncident){showToast('No incident selected','error');return;}
  const btn=document.getElementById('saveMedBtn');
  btn.disabled=true;btn.textContent='Saving...';

  const row={
    incident_id:currentIncident.id,
    medical_decision:medDecision||null,
    clinic_name:document.getElementById('med_clinic_name').value||null,
    clinic_address:document.getElementById('med_clinic_address').value||null,
    clinic_phone:document.getElementById('med_clinic_phone').value||null,
    authorization_notes:document.getElementById('med_auth_notes').value||null,
    refusal_reason:document.getElementById('med_refusal_reason').value||null,
    refusal_employee_signature:document.getElementById('med_refusal_sig').value||null,
    refusal_witness_name:document.getElementById('med_refusal_witness').value||null,
    refusal_date:document.getElementById('med_refusal_date').value||null,
    updated_at:new Date().toISOString()
  };

  try{
    if(currentMedical){
      const{error}=await sb.from('incident_medical').update(row).eq('id',currentMedical.id);
      if(error)throw error;
    }else{
      const{data,error}=await sb.from('incident_medical').insert([row]).select();
      if(error)throw error;
      currentMedical=data[0];
    }
    showToast('Medical info saved!','success');
    populateSummary();
  }catch(e){showToast('Error: '+e.message,'error');}
  btn.disabled=false;btn.textContent='Save Medical Info';
}

async function saveWcInfo(){
  if(!currentIncident){showToast('No incident selected','error');return;}

  // Gather WC checklist state
  const checklist=[];
  document.querySelectorAll('#wcChecklist input[type="checkbox"]').forEach(cb=>{
    if(cb.checked)checklist.push(parseInt(cb.dataset.wc));
  });

  const wcFields={
    incident_id:currentIncident.id,
    wc_claim_number:document.getElementById('wc_claim_number').value||null,
    wc_insurance_carrier:document.getElementById('wc_insurance_carrier').value||null,
    wc_policy_number:document.getElementById('wc_policy_number').value||null,
    wc_date_insurer_notified:document.getElementById('wc_date_notified').value||null,
    wc_date_left_work:document.getElementById('wc_date_left').value||null,
    wc_date_disability_onset:document.getElementById('wc_date_disability').value||null,
    wc_notes:document.getElementById('wc_notes').value||null,
    wc_checklist:checklist,
    updated_at:new Date().toISOString()
  };

  try{
    if(currentMedical){
      const{error}=await sb.from('incident_medical').update(wcFields).eq('id',currentMedical.id);
      if(error)throw error;
    }else{
      wcFields.medical_decision=medDecision||null;
      const{data,error}=await sb.from('incident_medical').insert([wcFields]).select();
      if(error)throw error;
      currentMedical=data[0];
    }
    showToast('WC info saved!','success');
    populateSummary();
  }catch(e){showToast('Error: '+e.message,'error');}
}

// --- Statements Sub-Tab ---
function populateStatements(){
  const inc=currentIncident;
  if(!inc)return;

  // Reset
  ifWitnessCount=0;
  document.getElementById('witnessStmtContainer').innerHTML='';
  document.getElementById('addWitnessStmtBtn').style.display='inline-flex';

  // Employee statement defaults
  document.getElementById('stmt_emp_name').value=inc.injured_name||'';
  document.getElementById('stmt_emp_title').value=inc.injured_title||'';
  document.getElementById('stmt_emp_date').value=inc.incident_date||'';
  document.getElementById('stmt_emp_text').value='';

  // Load existing statements
  const empStmt=currentStatements.find(s=>s.statement_type==='employee');
  if(empStmt){
    document.getElementById('stmt_emp_name').value=empStmt.person_name||'';
    document.getElementById('stmt_emp_title').value=empStmt.person_title||'';
    document.getElementById('stmt_emp_date').value=empStmt.statement_date||'';
    document.getElementById('stmt_emp_text').value=empStmt.statement_text||'';
  }

  const witnessStmts=currentStatements.filter(s=>s.statement_type==='witness');
  witnessStmts.forEach(w=>addWitnessStatement(w));
}

function addWitnessStatement(data){
  if(ifWitnessCount>=4)return;
  ifWitnessCount++;
  const n=ifWitnessCount;
  const div=document.createElement('div');
  div.className='stmt-card';
  div.id='wstmt-'+n;
  div.innerHTML=`
    <div class="stmt-header">
      <span class="stmt-type witness">Witness ${n}</span>
      <button class="stmt-remove" onclick="removeWitnessStmt(${n})">Remove</button>
    </div>
    <div class="sv-row">
      <div class="sv-field"><label class="sv-label">Name</label><input type="text" class="sv-input ws-name" value="${data?.person_name||''}"></div>
      <div class="sv-field"><label class="sv-label">Title</label><input type="text" class="sv-input ws-title" value="${data?.person_title||''}"></div>
    </div>
    <div class="sv-row">
      <div class="sv-field"><label class="sv-label">Contact</label><input type="text" class="sv-input ws-contact" value="${data?.person_contact||''}"></div>
      <div class="sv-field"><label class="sv-label">Date</label><input type="date" class="sv-input ws-date" value="${data?.statement_date||''}"></div>
    </div>
    <div class="sv-field"><label class="sv-label">Statement</label><textarea class="sv-input sv-textarea ws-text" placeholder="Witness account in their own words...">${data?.statement_text||''}</textarea></div>
  `;
  if(data&&data.id)div.dataset.stmtId=data.id;
  document.getElementById('witnessStmtContainer').appendChild(div);
  if(ifWitnessCount>=4)document.getElementById('addWitnessStmtBtn').style.display='none';
}

function removeWitnessStmt(n){
  const el=document.getElementById('wstmt-'+n);
  if(el)el.remove();
  ifWitnessCount--;
  document.getElementById('addWitnessStmtBtn').style.display='inline-flex';
}

async function saveEmployeeStatement(){
  if(!currentIncident){showToast('No incident selected','error');return;}
  const row={
    incident_id:currentIncident.id,
    statement_type:'employee',
    person_name:document.getElementById('stmt_emp_name').value||null,
    person_title:document.getElementById('stmt_emp_title').value||null,
    statement_text:document.getElementById('stmt_emp_text').value||null,
    statement_date:document.getElementById('stmt_emp_date').value||null
  };

  try{
    const existing=currentStatements.find(s=>s.statement_type==='employee');
    if(existing){
      const{error}=await sb.from('incident_statements').update(row).eq('id',existing.id);
      if(error)throw error;
    }else{
      const{data,error}=await sb.from('incident_statements').insert([row]).select();
      if(error)throw error;
      currentStatements.push(data[0]);
    }
    showToast('Employee statement saved!','success');
    populateSummary();
  }catch(e){showToast('Error: '+e.message,'error');}
}

// Save all witness statements (called when saving investigation or manually)
async function saveAllWitnessStatements(){
  if(!currentIncident)return;

  // Delete existing witness statements
  await sb.from('incident_statements').delete().eq('incident_id',currentIncident.id).eq('statement_type','witness');

  const blocks=document.querySelectorAll('#witnessStmtContainer .stmt-card');
  const rows=[];
  blocks.forEach(block=>{
    const name=block.querySelector('.ws-name')?.value||'';
    if(!name)return;
    rows.push({
      incident_id:currentIncident.id,
      statement_type:'witness',
      person_name:name,
      person_title:block.querySelector('.ws-title')?.value||null,
      person_contact:block.querySelector('.ws-contact')?.value||null,
      statement_text:block.querySelector('.ws-text')?.value||null,
      statement_date:block.querySelector('.ws-date')?.value||null
    });
  });

  if(rows.length>0){
    const{data,error}=await sb.from('incident_statements').insert(rows).select();
    if(error)throw error;
    // Update local cache
    currentStatements=currentStatements.filter(s=>s.statement_type!=='witness');
    currentStatements.push(...(data||[]));
  }
  showToast('Witness statements saved!','success');
  populateSummary();
}

// --- Investigation Sub-Tab ---
function populateInvestigation(){
  const inc=currentIncident;
  if(!inc)return;

  // Reset CA container
  caCount=0;
  document.getElementById('caContainer').innerHTML='';

  // Pre-fill investigation from incident data
  document.getElementById('inv_who').value='';
  document.getElementById('inv_what').value=inc.incident_description||'';
  document.getElementById('inv_when').value='';
  document.getElementById('inv_where').value=[inc.site_location,inc.specific_location].filter(Boolean).join(' â€” ');
  document.getElementById('inv_why').value='';

  // Reset contributing factors
  document.querySelectorAll('#inv_cf_acts input').forEach(cb=>cb.checked=false);

  // Reset close-out
  document.getElementById('inv_closeout_safety').value='';
  document.getElementById('inv_closeout_super').value='';
  document.getElementById('inv_closeout_date').value='';
  document.querySelectorAll('#inv_status_group .sv-radio-card').forEach(c=>c.classList.remove('selected'));

  if(currentInvestigation){
    const inv=currentInvestigation;
    if(inv.who_involved)document.getElementById('inv_who').value=inv.who_involved;
    if(inv.what_happened)document.getElementById('inv_what').value=inv.what_happened;
    if(inv.when_details)document.getElementById('inv_when').value=inv.when_details;
    if(inv.where_details)document.getElementById('inv_where').value=inv.where_details;
    if(inv.why_root_cause)document.getElementById('inv_why').value=inv.why_root_cause;

    // Contributing factors
    if(inv.contributing_factors&&Array.isArray(inv.contributing_factors)){
      document.querySelectorAll('#inv_cf_acts input').forEach(cb=>{
        if(inv.contributing_factors.includes(cb.value))cb.checked=true;
      });
    }

    // Corrective actions
    if(inv.corrective_actions&&Array.isArray(inv.corrective_actions)){
      inv.corrective_actions.forEach(ca=>addCorrectiveAction(ca));
    }

    // Close-out
    if(inv.closeout_safety_mgr)document.getElementById('inv_closeout_safety').value=inv.closeout_safety_mgr;
    if(inv.closeout_supervisor)document.getElementById('inv_closeout_super').value=inv.closeout_supervisor;
    if(inv.closeout_date)document.getElementById('inv_closeout_date').value=inv.closeout_date;

    // Status
    if(inv.status){
      const radio=document.querySelector(`input[name="inv_status"][value="${inv.status}"]`);
      if(radio){radio.checked=true;radio.closest('.sv-radio-card').classList.add('selected');}
    }
  }
}

function addCorrectiveAction(data){
  caCount++;
  const n=caCount;
  const div=document.createElement('div');
  div.className='ca-row';
  div.id='ca-'+n;
  const sts=data?.status||'open';
  div.innerHTML=`
    <div class="sv-field" style="margin:0"><input type="text" class="sv-input ca-action" placeholder="Corrective action description" value="${data?.action||''}"></div>
    <div class="sv-field" style="margin:0"><input type="text" class="sv-input ca-owner" placeholder="Owner" value="${data?.owner||''}"></div>
    <div class="sv-field" style="margin:0"><input type="date" class="sv-input ca-due" value="${data?.due_date||''}"></div>
    <select class="sv-input ca-status-sel" style="width:auto;min-width:100px;padding:.5rem;font-size:.72rem" onchange="updateCaStatusColor(this)">
      <option value="open" ${sts==='open'?'selected':''}>Open</option>
      <option value="in_progress" ${sts==='in_progress'?'selected':''}>In Progress</option>
      <option value="completed" ${sts==='completed'?'selected':''}>Completed</option>
    </select>
  `;
  document.getElementById('caContainer').appendChild(div);
}

function updateCaStatusColor(sel){
  // Visual feedback handled by select value
}

async function saveInvestigation(){
  if(!currentIncident){showToast('No incident selected','error');return;}

  // Gather contributing factors
  const factors=[...document.querySelectorAll('#inv_cf_acts input:checked')].map(cb=>cb.value);

  // Gather corrective actions
  const actions=[];
  document.querySelectorAll('.ca-row').forEach(row=>{
    const action=row.querySelector('.ca-action')?.value||'';
    if(!action)return;
    actions.push({
      action,
      owner:row.querySelector('.ca-owner')?.value||'',
      due_date:row.querySelector('.ca-due')?.value||'',
      status:row.querySelector('.ca-status-sel')?.value||'open'
    });
  });

  const invStatus=document.querySelector('input[name="inv_status"]:checked')?.value||'open';

  const row={
    incident_id:currentIncident.id,
    who_involved:document.getElementById('inv_who').value||null,
    what_happened:document.getElementById('inv_what').value||null,
    when_details:document.getElementById('inv_when').value||null,
    where_details:document.getElementById('inv_where').value||null,
    why_root_cause:document.getElementById('inv_why').value||null,
    contributing_factors:factors,
    corrective_actions:actions,
    closeout_safety_mgr:document.getElementById('inv_closeout_safety').value||null,
    closeout_supervisor:document.getElementById('inv_closeout_super').value||null,
    closeout_date:document.getElementById('inv_closeout_date').value||null,
    status:invStatus,
    updated_at:new Date().toISOString()
  };

  try{
    if(currentInvestigation){
      const{error}=await sb.from('incident_investigation').update(row).eq('id',currentInvestigation.id);
      if(error)throw error;
    }else{
      const{data,error}=await sb.from('incident_investigation').insert([row]).select();
      if(error)throw error;
      currentInvestigation=data[0];
    }
    showToast('Investigation saved!','success');
    populateSummary();
  }catch(e){showToast('Error: '+e.message,'error');}
}

// --- Return to Work Sub-Tab ---
function populateRtw(){
  // Reset
  rtwStatus='';
  document.querySelectorAll('.rtw-btn').forEach(b=>b.className='rtw-btn');
  document.getElementById('rtwModifiedFields').style.display='none';
  ['rtw_physician','rtw_eval_date','rtw_restrictions','rtw_modified_duties','rtw_duration','rtw_followup','rtw_supervisor'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.value='';
  });
  document.getElementById('rtw_acknowledged').checked=false;

  if(currentRtw){
    const r=currentRtw;
    if(r.clearance_status)setRtwStatus(r.clearance_status);
    if(r.physician_name)document.getElementById('rtw_physician').value=r.physician_name;
    if(r.eval_date)document.getElementById('rtw_eval_date').value=r.eval_date;
    if(r.restrictions)document.getElementById('rtw_restrictions').value=r.restrictions;
    if(r.modified_duties)document.getElementById('rtw_modified_duties').value=r.modified_duties;
    if(r.restriction_duration)document.getElementById('rtw_duration').value=r.restriction_duration;
    if(r.next_followup_date)document.getElementById('rtw_followup').value=r.next_followup_date;
    if(r.supervisor_name)document.getElementById('rtw_supervisor').value=r.supervisor_name;
    if(r.employee_acknowledged)document.getElementById('rtw_acknowledged').checked=true;
  }
}

function setRtwStatus(status){
  rtwStatus=status;
  document.querySelectorAll('.rtw-btn').forEach(b=>b.className='rtw-btn');
  const btns=document.querySelectorAll('.rtw-btn');
  if(status==='full')btns[0].classList.add('active-full');
  else if(status==='modified')btns[1].classList.add('active-modified');
  else if(status==='not_cleared')btns[2].classList.add('active-not');
  document.getElementById('rtwModifiedFields').style.display=(status==='modified')?'block':'none';
}

async function saveRtw(){
  if(!currentIncident){showToast('No incident selected','error');return;}
  const row={
    incident_id:currentIncident.id,
    clearance_status:rtwStatus||null,
    physician_name:document.getElementById('rtw_physician').value||null,
    eval_date:document.getElementById('rtw_eval_date').value||null,
    restrictions:document.getElementById('rtw_restrictions').value||null,
    modified_duties:document.getElementById('rtw_modified_duties').value||null,
    restriction_duration:document.getElementById('rtw_duration').value||null,
    next_followup_date:document.getElementById('rtw_followup').value||null,
    supervisor_name:document.getElementById('rtw_supervisor').value||null,
    employee_acknowledged:document.getElementById('rtw_acknowledged').checked,
    updated_at:new Date().toISOString()
  };

  try{
    if(currentRtw){
      const{error}=await sb.from('incident_rtw').update(row).eq('id',currentRtw.id);
      if(error)throw error;
    }else{
      const{data,error}=await sb.from('incident_rtw').insert([row]).select();
      if(error)throw error;
      currentRtw=data[0];
    }
    showToast('Return to work info saved!','success');
    populateSummary();
  }catch(e){showToast('Error: '+e.message,'error');}
}

// --- Documents Sub-Tab: PDF Generation ---
async function downloadIfOsha301(){
  if(!currentIncident){showToast('No incident selected','error');return;}
  try{await generateOSHA301PDF(currentIncident);showToast('OSHA 301 downloaded!','success');}
  catch(e){showToast('Error: '+e.message,'error');}
}

// â”€â”€ Medical Packet (accessible to all users) â”€â”€
function needsMedicalPacket(inc){
  if(!inc||inc.no_injury)return false;
  return['ems','self_transport'].includes(inc.treatment_type);
}

function buildMedPacketReferralContent(inc){
  const yr=inc.incident_date?new Date(inc.incident_date).getFullYear():new Date().getFullYear();
  const displayId=yr+'-'+String(inc.case_number).padStart(4,'0');
  const siteFiltered=approvedClinics.filter(c=>c.site_location===inc.site_location);
  const primaryClinic=siteFiltered.find(c=>c.is_primary)||siteFiltered[0]||null;
  const clinicName=primaryClinic?primaryClinic.name:'___________________';
  const clinicAddr=primaryClinic?[primaryClinic.address,primaryClinic.city,primaryClinic.state,primaryClinic.zip].filter(Boolean).join(', '):'___________________';
  const clinicPhone=primaryClinic?(primaryClinic.phone||'N/A'):'___________________';
  return[
    'MEDICAL REFERRAL AUTHORIZATION','Incident #'+displayId,'',
    'Employee: '+(inc.injured_name||'N/A'),
    'Job Title: '+(inc.injured_title||'N/A'),
    'Date of Injury: '+(inc.incident_date||'N/A'),
    'Time of Injury: '+(inc.incident_time||'N/A'),
    'Injury: '+((inc.injury_types||[]).join(', '))+' - '+(inc.body_part||''),
    'Severity: '+(inc.severity||'N/A'),
    '','REFERRED CLINIC:',
    'Name: '+clinicName,
    'Address: '+clinicAddr,
    'Phone: '+clinicPhone,
    '','Authorization: This employee is authorized for occupational medical',
    'evaluation and treatment related to the above workplace incident.',
    '','Reported By: '+(inc.reporting_party_name||''),
    'Title: '+(inc.reporting_party_title||''),
    'Site: '+(inc.site_location||''),
    'Date: '+new Date().toLocaleDateString()
  ];
}

function buildClinicListContent(siteLocation){
  const filtered=siteLocation?approvedClinics.filter(c=>c.site_location===siteLocation):approvedClinics;
  const lines=['APPROVED OCCUPATIONAL CLINICS'+(siteLocation?' â€” '+siteLocation:''),'Generated: '+new Date().toLocaleDateString(),''];
  if(filtered.length===0){lines.push('No approved clinics configured'+(siteLocation?' for '+siteLocation:'')+'.'); return lines;}
  filtered.forEach((c,i)=>{
    const addr=[c.address,c.city,c.state,c.zip].filter(Boolean).join(', ');
    if(c.is_primary)lines.push('*** PRIMARY CLINIC ***');
    lines.push((i+1)+'. '+c.name);
    lines.push('   Address: '+addr);
    if(c.phone)lines.push('   Phone: '+c.phone);
    if(c.hours)lines.push('   Hours: '+c.hours);
    lines.push('');
  });
  return lines;
}

async function renderMedPacketHTML(inc,targetId){
  const container=document.getElementById(targetId);
  if(!inc||!needsMedicalPacket(inc)){
    if(targetId==='medpacketContent'){
      container.innerHTML='<div style="text-align:center;color:#64748b;padding:3rem">'+
        '<div style="font-size:2rem;margin-bottom:.5rem">&#128203;</div>'+
        '<div style="font-size:.95rem;font-weight:600;color:#cbd5e1;margin-bottom:.5rem">No Medical Packet Available</div>'+
        '<div style="font-size:.82rem">Submit an incident report that requires medical attention<br>(EMS Transport or Self-Transport) to generate a Medical Packet here.</div></div>';
    }
    return;
  }
  // Ensure clinics are loaded
  if(approvedClinics.length===0)await loadApprovedClinics();
  const yr=inc.incident_date?new Date(inc.incident_date).getFullYear():new Date().getFullYear();
  const displayId=yr+'-'+String(inc.case_number).padStart(4,'0');
  const treatment=inc.treatment_type?inc.treatment_type.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase()):'N/A';
  // Filter clinics by incident site
  const siteFilteredClinics=approvedClinics.filter(c=>c.site_location===inc.site_location);
  let clinicHTML='';
  if(siteFilteredClinics.length===0){
    clinicHTML='<div style="color:#64748b;font-size:.82rem">No approved clinics configured for '+(inc.site_location||'this site')+'. <a href="../settings/index.html" style="color:#f59e0b">Manage clinics in Settings</a>.</div>';
  }else{
    clinicHTML=siteFilteredClinics.map(c=>{
      const addr=[c.address,c.city,c.state,c.zip].filter(Boolean).join(', ');
      const mapsUrl='https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(addr);
      return'<div class="clinic-card'+(c.is_primary?' primary':'')+'">'+
        '<div>'+(c.is_primary?'<div class="cc-primary">Primary Clinic</div>':'')+
        '<div class="cc-name">'+c.name+'</div>'+
        '<div class="cc-detail">'+addr+'</div>'+
        (c.hours?'<div class="cc-detail">Hours: '+c.hours+'</div>':'')+
        (c.phone?'<div class="cc-detail">Phone: '+c.phone+'</div>':'')+
        '</div><div class="cc-actions">'+
        (c.phone?'<a href="tel:'+c.phone+'" class="cc-call">Call</a>':'')+
        '<a href="'+mapsUrl+'" target="_blank" class="cc-dir">Directions</a>'+
        '</div></div>';
    }).join('');
  }
  container.innerHTML='<div class="med-packet-section">'+
    '<h3><span class="mp-icon">&#9883;</span> Medical Packet &mdash; Case #'+displayId+'</h3>'+
    '<div class="mp-summary">'+
      '<strong>Employee:</strong> '+(inc.injured_name||'N/A')+' &bull; '+
      '<strong>Treatment:</strong> '+treatment+' &bull; '+
      '<strong>Severity:</strong> '+(inc.severity||'N/A')+
    '</div>'+
    '<div class="mp-downloads">'+
      '<button class="mp-dl-btn" onclick="downloadMedPacketReferral()">&#128196; Medical Referral PDF</button>'+
      '<button class="mp-dl-btn" onclick="downloadClinicListPdf()">&#128196; Clinic List PDF</button>'+
    '</div>'+
    '<div class="mp-clinics-heading">Approved Occupational Clinics</div>'+
    clinicHTML+
  '</div>';
  container.style.display='block';
}

async function downloadMedPacketReferral(){
  if(!lastSubmitted){showToast('No recent submission','error');return;}
  if(approvedClinics.length===0)await loadApprovedClinics();
  generateTextPdf('Medical Referral Form',buildMedPacketReferralContent(lastSubmitted),lastSubmitted.case_number);
}

function downloadClinicListPdf(){
  const caseNum=lastSubmitted?lastSubmitted.case_number:'0';
  const site=lastSubmitted?lastSubmitted.site_location:null;
  generateTextPdf('Approved Clinics List',buildClinicListContent(site),caseNum);
}

// â”€â”€ Admin-only Incident File document downloads â”€â”€
async function downloadIfMedReferral(){
  if(!currentIncident||!currentMedical){showToast('Save medical info first','error');return;}
  generateTextPdf('Medical Referral Form',buildMedReferralContent());
}

async function downloadIfRefusal(){
  if(!currentIncident||!currentMedical){showToast('Save medical info first','error');return;}
  generateTextPdf('Refusal of Treatment',buildRefusalContent());
}

async function downloadIfInvestigation(){
  if(!currentIncident||!currentInvestigation){showToast('Save investigation first','error');return;}
  generateTextPdf('Investigation Report',buildInvestigationContent());
}

async function downloadIfRtw(){
  if(!currentIncident||!currentRtw){showToast('Save return to work info first','error');return;}
  generateTextPdf('Return to Work Clearance',buildRtwContent());
}

function buildMedReferralContent(){
  const inc=currentIncident;const m=currentMedical;
  const yr=inc.incident_date?new Date(inc.incident_date).getFullYear():new Date().getFullYear();
  const displayId=yr+'-'+String(inc.case_number).padStart(4,'0');
  return [
    'MEDICAL REFERRAL AUTHORIZATION','Incident #'+displayId,'',
    'Employee: '+(inc.injured_name||'N/A'),
    'Date of Injury: '+(inc.incident_date||'N/A'),
    'Injury: '+((inc.injury_types||[]).join(', '))+' - '+(inc.body_part||''),
    '','Referred Clinic: '+(m.clinic_name||'N/A'),
    'Address: '+(m.clinic_address||'N/A'),
    'Phone: '+(m.clinic_phone||'N/A'),
    '','Authorization Notes: '+(m.authorization_notes||'N/A'),
    '','Reported By: '+(inc.reporting_party_name||''),'Title: '+(inc.reporting_party_title||''),
    'Date: '+new Date().toLocaleDateString()
  ];
}

function buildRefusalContent(){
  const inc=currentIncident;const m=currentMedical;
  const yr=inc.incident_date?new Date(inc.incident_date).getFullYear():new Date().getFullYear();
  const displayId=yr+'-'+String(inc.case_number).padStart(4,'0');
  return [
    'REFUSAL OF MEDICAL TREATMENT','Incident #'+displayId,'',
    'Employee: '+(inc.injured_name||'N/A'),
    'Date of Injury: '+(inc.incident_date||'N/A'),
    'Injury: '+((inc.injury_types||[]).join(', '))+' - '+(inc.body_part||''),
    '','Reason for Refusal: '+(m.refusal_reason||'N/A'),
    '','Employee Signature: '+(m.refusal_employee_signature||'N/A'),
    'Witness: '+(m.refusal_witness_name||'N/A'),
    'Refusal Date: '+(m.refusal_date||'N/A')
  ];
}

function buildInvestigationContent(){
  const inc=currentIncident;const inv=currentInvestigation;
  const yr=inc.incident_date?new Date(inc.incident_date).getFullYear():new Date().getFullYear();
  const displayId=yr+'-'+String(inc.case_number).padStart(4,'0');
  const cas=(inv.corrective_actions||[]).map((ca,i)=>
    `  ${i+1}. ${ca.action} | Owner: ${ca.owner} | Due: ${ca.due_date} | Status: ${ca.status}`
  ).join('\n');
  return [
    'INCIDENT INVESTIGATION REPORT','Incident #'+displayId,'Status: '+(inv.status||'open').toUpperCase(),'',
    'WHO: '+(inv.who_involved||'N/A'),'',
    'WHAT: '+(inv.what_happened||'N/A'),'',
    'WHEN: '+(inv.when_details||'N/A'),'',
    'WHERE: '+(inv.where_details||'N/A'),'',
    'WHY (Root Cause): '+(inv.why_root_cause||'N/A'),'',
    'Contributing Factors: '+((inv.contributing_factors||[]).join(', ')||'None'),'',
    'CORRECTIVE ACTIONS:',cas||'  None','',
    'CLOSE-OUT:',
    'Safety Manager: '+(inv.closeout_safety_mgr||'N/A'),
    'Supervisor: '+(inv.closeout_supervisor||'N/A'),
    'Close-Out Date: '+(inv.closeout_date||'N/A')
  ];
}

function buildRtwContent(){
  const inc=currentIncident;const r=currentRtw;
  const yr=inc.incident_date?new Date(inc.incident_date).getFullYear():new Date().getFullYear();
  const displayId=yr+'-'+String(inc.case_number).padStart(4,'0');
  const statusLabel={full:'Full Duty',modified:'Modified / Light Duty',not_cleared:'Not Yet Cleared'};
  return [
    'RETURN TO WORK CLEARANCE','Incident #'+displayId,'',
    'Employee: '+(inc.injured_name||'N/A'),
    'Clearance Status: '+(statusLabel[r.clearance_status]||'N/A'),'',
    'Physician: '+(r.physician_name||'N/A'),
    'Evaluation Date: '+(r.eval_date||'N/A'),'',
    ...(r.clearance_status==='modified'?[
      'Restrictions: '+(r.restrictions||'N/A'),
      'Modified Duties: '+(r.modified_duties||'N/A'),
      'Duration: '+(r.restriction_duration||'N/A'),
      'Next Follow-Up: '+(r.next_followup_date||'N/A'),''
    ]:[]),
    'Supervisor: '+(r.supervisor_name||'N/A'),
    'Employee Acknowledged: '+(r.employee_acknowledged?'Yes':'No'),
    '','Date: '+new Date().toLocaleDateString()
  ];
}

async function generateTextPdf(title,lines,caseNumOverride){
  const{PDFDocument,StandardFonts,rgb}=PDFLib;
  const doc=await PDFDocument.create();
  const font=await doc.embedFont(StandardFonts.Helvetica);
  const boldFont=await doc.embedFont(StandardFonts.HelveticaBold);
  let page=doc.addPage([612,792]);
  let y=742;
  const margin=50;
  const maxW=612-margin*2;

  // Title
  page.drawText(title,{x:margin,y,font:boldFont,size:16,color:rgb(0,0,0)});
  y-=8;
  page.drawLine({start:{x:margin,y},end:{x:612-margin,y},thickness:1,color:rgb(.8,.6,0)});
  y-=20;

  for(const line of lines){
    if(y<60){page=doc.addPage([612,792]);y=742;}
    const isHeader=line===line.toUpperCase()&&line.length>2&&!line.startsWith(' ');
    const f=isHeader?boldFont:font;
    const size=isHeader?11:10;
    // Word wrap
    const words=line.split(' ');
    let cur='';
    for(const w of words){
      const test=cur?cur+' '+w:w;
      if(f.widthOfTextAtSize(test,size)>maxW){
        page.drawText(cur,{x:margin,y,font:f,size,color:rgb(0,0,0)});
        y-=15;
        if(y<60){page=doc.addPage([612,792]);y=742;}
        cur=w;
      }else{cur=test;}
    }
    if(cur){page.drawText(cur,{x:margin,y,font:f,size,color:rgb(0,0,0)});y-=15;}
    if(!line)y-=5;
  }

  const bytes=await doc.save();
  const slug=title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
  const caseNum=caseNumOverride||(currentIncident?currentIncident.case_number:'0');
  downloadBlob(bytes,slug+'-case-'+caseNum+'.pdf');
  showToast(title+' downloaded!','success');
}

// Open Incident File for a specific incident (called from success screen or past reports)
function openIncidentFile(incidentId){
  showPanel('file');
  setTimeout(()=>{
    const sel=document.getElementById('ifCaseSelect');
    sel.value=String(incidentId);
    loadIncidentFile();
  },300);
}

// Open Incident File from the success screen after submission
function openIncidentFileFromLast(){
  if(!lastSubmitted||!lastSubmitted.id){showToast('No recent submission','error');return;}
  openIncidentFile(lastSubmitted.id);
}
</script>
</body>
</html>
