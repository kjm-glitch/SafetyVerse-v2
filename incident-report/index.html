<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Incident Report - TheSafetyVerse</title>
<link rel="icon" type="image/png" href="logo.png?v=2">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}

.sv-header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:rgba(0,0,0,0.6);border-bottom:2px solid rgba(245,158,11,0.3)}
.sv-header-left{display:flex;align-items:center;gap:14px}
.sv-header .btn-back{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);color:#f59e0b;font-size:.8rem;font-weight:600;text-decoration:none;transition:all .2s}
.sv-header .btn-back:hover{background:rgba(245,158,11,0.3)}
.sv-header .btn-back svg{width:14px;height:14px}
.sv-header .logo{display:flex;align-items:center;gap:8px;text-decoration:none}
.sv-header .logo img{height:36px;width:auto}
.sv-header .logo-text{font-size:1.1rem;font-weight:800;color:#fff}
.sv-header .logo-text em{color:#f59e0b;font-style:normal}

.hero{background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border-bottom:3px solid #2563eb;padding:2rem 1.5rem 1.5rem;text-align:center}
.hero h1{font-size:1.6rem;font-weight:800;color:#fff;margin-bottom:.4rem}
.hero h1 em{font-style:normal;color:#f59e0b}
.hero p{color:#94a3b8;font-size:.82rem;max-width:580px;margin:0 auto;line-height:1.5}

.wizard-progress{display:flex;justify-content:space-between;padding:.75rem 1rem;background:#1e293b;border-bottom:1px solid #334155;position:sticky;top:0;z-index:100;overflow-x:auto;gap:2px}
.wsi{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:48px;cursor:default}
.wsc{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;border:2px solid #334155;color:#64748b;background:transparent;transition:all .3s}
.wsc.active{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,0.1)}
.wsc.done{border-color:#22c55e;color:#fff;background:#22c55e}
.wsl{font-size:.48rem;color:#64748b;text-align:center;text-transform:uppercase;letter-spacing:.03em;font-weight:600;white-space:nowrap}
.wsl.active{color:#f59e0b}
.wsl.done{color:#22c55e}

.content{max-width:760px;margin:0 auto;padding:1.5rem 1rem 3rem}
.wizard-step{display:none;animation:fadeIn .3s ease}
.wizard-step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.card{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:2rem;margin-bottom:1rem}
.step-title{font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:#f59e0b;margin-bottom:.5rem}
.step-heading{font-size:1.08rem;font-weight:700;color:#f1f5f9;line-height:1.45;margin-bottom:1.25rem}

.sv-field{margin-bottom:1.25rem}
.sv-label{display:block;font-size:.72rem;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.4rem}
.sv-required::after{content:' *';color:#ef4444}
.sv-input,.sv-select{width:100%;padding:.75rem 1rem;background:#0f172a;border:2px solid #334155;border-radius:10px;color:#e2e8f0;font-family:'Inter',sans-serif;font-size:.85rem;transition:border-color .2s}
.sv-input:focus,.sv-select:focus{outline:none;border-color:#f59e0b}
.sv-textarea{min-height:100px;resize:vertical}
.sv-textarea.lg{min-height:150px}
.sv-select{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.sv-select option{background:#1e293b;color:#e2e8f0}
.sv-helper{font-size:.72rem;color:#64748b;margin-top:.3rem}
.sv-error{border-color:#ef4444!important}
.sv-error-msg{font-size:.72rem;color:#ef4444;margin-top:.3rem;display:none}
.sv-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.sv-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}

.sv-radio-group{display:flex;flex-wrap:wrap;gap:.5rem}
.sv-radio-card{flex:1;min-width:120px;padding:.8rem;text-align:center;border:2px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-size:.82rem;font-weight:600;color:#94a3b8;transition:all .2s}
.sv-radio-card:hover{border-color:#475569}
.sv-radio-card input{display:none}
.sv-radio-card.selected{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,0.08)}

.osha-card{display:block;width:100%;padding:1rem 1.25rem;text-align:left;border:2px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;transition:all .2s;margin-bottom:.5rem}
.osha-card:hover{border-color:#475569}
.osha-card input{display:none}
.osha-card .oc-title{font-size:.88rem;font-weight:700;color:#cbd5e1}
.osha-card .oc-desc{font-size:.72rem;color:#64748b;margin-top:.15rem}
.osha-card.selected{border-color:#f59e0b;background:rgba(245,158,11,0.06)}
.osha-card.selected .oc-title{color:#f59e0b}
.osha-card.sel-red{border-color:#ef4444;background:rgba(239,68,68,0.06)}
.osha-card.sel-red .oc-title{color:#f87171}
.osha-card.sel-green{border-color:#22c55e;background:rgba(34,197,94,0.06)}

.cb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem}
.cb-item{display:flex;align-items:center;gap:.45rem;padding:.5rem .6rem;background:#0f172a;border:1px solid #334155;border-radius:8px;cursor:pointer;transition:all .2s;font-size:.75rem;color:#cbd5e1}
.cb-item:hover{border-color:#475569}
.cb-item:has(input:checked){border-color:#f59e0b;background:rgba(245,158,11,0.06)}
.cb-item input[type="checkbox"]{accent-color:#f59e0b;flex-shrink:0}

.rc-section{margin-bottom:1.5rem}
.rc-title{font-size:.75rem;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;padding-bottom:.35rem;border-bottom:1px solid #334155}
.rc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.35rem}

.witness-block{background:#0f172a;border:1px solid #334155;border-radius:10px;padding:1.25rem;margin-bottom:.75rem;position:relative}
.witness-block .remove-btn{position:absolute;top:10px;right:10px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#f87171;font-size:.7rem;padding:4px 10px;border-radius:6px;cursor:pointer}
.witness-block .remove-btn:hover{background:rgba(239,68,68,0.3)}

.toggle-group{display:flex;gap:.5rem;margin-bottom:1.25rem}
.toggle-btn{flex:1;padding:.85rem;text-align:center;border:2px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-family:inherit;font-size:.88rem;font-weight:700;color:#94a3b8;transition:all .2s}
.toggle-btn.yes.selected{border-color:#22c55e;color:#22c55e;background:rgba(34,197,94,0.08)}
.toggle-btn.no.selected{border-color:#ef4444;color:#f87171;background:rgba(239,68,68,0.08)}

.add-btn{display:inline-flex;align-items:center;gap:6px;padding:.6rem 1.2rem;border-radius:8px;border:2px solid #334155;background:transparent;color:#94a3b8;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s}
.add-btn:hover{border-color:#f59e0b;color:#f59e0b}

.wizard-nav{display:flex;justify-content:space-between;margin-top:2rem;padding-top:1.5rem;border-top:1px solid #334155}
.wbtn{padding:.75rem 2rem;border-radius:10px;font-family:inherit;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;border:none}
.wbtn-prev{background:transparent;border:2px solid #334155;color:#94a3b8}
.wbtn-prev:hover{border-color:#f59e0b;color:#f59e0b}
.wbtn-next{background:linear-gradient(135deg,#f59e0b,#d97706);color:#0f172a}
.wbtn-next:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(245,158,11,0.3)}
.wbtn-submit{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-size:.95rem;padding:.85rem 2.5rem}
.wbtn-submit:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(34,197,94,0.3)}
.wbtn:disabled{opacity:.5;cursor:default;transform:none!important}

.no-injury-toggle{display:flex;align-items:center;gap:.75rem;padding:.85rem 1rem;background:rgba(37,99,235,0.08);border:1px solid rgba(37,99,235,0.25);border-radius:10px;margin-bottom:1.25rem;cursor:pointer;font-size:.85rem;color:#93c5fd}
.no-injury-toggle input{accent-color:#f59e0b;width:18px;height:18px}

.conditional{transition:all .3s}
.conditional.hidden{opacity:.3;pointer-events:none;max-height:0;overflow:hidden;margin:0;padding:0}

.success-screen{display:none;text-align:center;padding:3rem 1rem}
.success-icon{width:80px;height:80px;border-radius:50%;background:rgba(34,197,94,0.15);border:3px solid #22c55e;display:flex;align-items:center;justify-content:center;margin:0 auto 1.5rem;font-size:2rem;color:#22c55e}
.success-screen h2{font-size:1.5rem;font-weight:800;color:#fff;margin-bottom:.5rem}
.success-screen p{color:#94a3b8;font-size:.9rem;margin-bottom:2rem}
.success-actions{display:flex;flex-wrap:wrap;gap:.75rem;justify-content:center}
.success-actions button{padding:.75rem 1.5rem;border-radius:10px;border:none;font-family:inherit;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s}
.sa-primary{background:linear-gradient(135deg,#f59e0b,#d97706);color:#0f172a}
.sa-secondary{background:transparent;border:2px solid #334155;color:#94a3b8}
.sa-secondary:hover{border-color:#f59e0b;color:#f59e0b}

.incidents-list{display:none}
.il-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:1.25rem;margin-bottom:.75rem;cursor:pointer;transition:all .2s}
.il-card:hover{border-color:rgba(245,158,11,0.3)}
.il-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
.il-case{font-size:.9rem;font-weight:700;color:#f1f5f9}
.il-date{font-size:.75rem;color:#64748b}
.il-details{font-size:.82rem;color:#94a3b8;line-height:1.5}
.il-badge{display:inline-block;padding:.15rem .5rem;border-radius:6px;font-size:.65rem;font-weight:700;text-transform:uppercase}
.il-badge.pending{background:rgba(245,158,11,0.15);color:#fbbf24}
.il-badge.recorded{background:rgba(34,197,94,0.15);color:#4ade80}

.tab-bar{display:flex;justify-content:center;gap:.2rem;background:#1e293b;padding:.5rem;border-bottom:1px solid #334155;flex-wrap:wrap}
.tab{padding:.55rem .9rem;border-radius:8px;border:none;background:transparent;color:#94a3b8;font-family:inherit;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .2s}
.tab:hover{color:#e2e8f0;background:#334155}
.tab.active{color:#f59e0b;background:#334155}

.panel{display:none}.panel.active{display:block}
.toast{position:fixed;top:20px;right:20px;padding:.85rem 1.25rem;border-radius:10px;font-size:.85rem;font-weight:600;z-index:9999;transform:translateX(120%);transition:transform .3s ease;max-width:350px}
.toast.show{transform:translateX(0)}
.toast.success{background:#166534;color:#4ade80;border:1px solid #22c55e}
.toast.error{background:#7f1d1d;color:#fca5a5;border:1px solid #ef4444}
.info-box{background:rgba(37,99,235,0.1);border:1px solid rgba(37,99,235,0.25);border-radius:10px;padding:.85rem 1rem;margin-bottom:1.25rem;font-size:.82rem;color:#93c5fd;line-height:1.5}

@media(max-width:768px){
  .sv-row,.sv-row-3{grid-template-columns:1fr}
  .cb-grid,.rc-grid{grid-template-columns:repeat(2,1fr)}
  .content{padding:1rem .75rem 2rem}
  .card{padding:1.25rem}
  .wizard-progress{padding:.6rem .5rem}
  .wsi{min-width:38px}
  .wsl{font-size:.42rem}
}
@media(max-width:480px){
  .cb-grid,.rc-grid{grid-template-columns:1fr}
  .sv-radio-group{flex-direction:column}
  .sv-radio-card{min-width:auto}
}
</style>
</head>
<body>

<div class="sv-header">
  <div class="sv-header-left">
    <a href="../user-dashboard/index.html" class="btn-back" aria-label="Back to Dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      Dashboard
    </a>
  </div>
  <a href="../index.html" class="logo">
    <img src="logo.png?v=2" alt="TheSafetyVerse Logo">
    <span class="logo-text"><em>The</em>Safety<em>Verse</em></span>
  </a>
</div>

<div class="hero">
  <h1>Safety Incident <em>Report</em></h1>
  <p>Document workplace incidents with guided steps. Data maps to OSHA 301, 300 Log, and 300A Summary.</p>
</div>

<div class="tab-bar">
  <button class="tab active" onclick="showPanel('wizard')">New Report</button>
  <button class="tab" onclick="showPanel('list')">Past Reports</button>
  <button class="tab" onclick="showPanel('reports')">OSHA Downloads</button>
</div>

<div class="panel active" id="panel-wizard">

<div class="wizard-progress" id="progressBar"></div>

<div class="content" id="wizardContent">

<!-- STEP 1: Contact Info -->
<div class="wizard-step active" id="step-1">
<div class="card">
  <div class="step-title">Step 1 of 9</div>
  <div class="step-heading">Who is reporting this incident?</div>
  <div class="sv-field"><label class="sv-label sv-required">Reporting Party Name</label><input type="text" class="sv-input" id="f_rp_name"></div>
  <div class="sv-field"><label class="sv-label sv-required">Title / Position</label><input type="text" class="sv-input" id="f_rp_title"></div>
  <div class="sv-field"><label class="sv-label sv-required">Site / Location Name</label><input type="text" class="sv-input" id="f_site" placeholder="e.g., Main Campus, Warehouse B"></div>
</div>
<div class="wizard-nav"><div></div><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 2: Incident Details -->
<div class="wizard-step" id="step-2">
<div class="card">
  <div class="step-title">Step 2 of 9</div>
  <div class="step-heading">When and where did the incident occur?</div>
  <div class="sv-row">
    <div class="sv-field"><label class="sv-label sv-required">Date of Incident</label><input type="date" class="sv-input" id="f_date"></div>
    <div class="sv-field"><label class="sv-label sv-required">Time of Incident</label><input type="time" class="sv-input" id="f_time"></div>
  </div>
  <div class="sv-field"><label class="sv-label">Report Filed</label><input type="text" class="sv-input" id="f_report_time" readonly style="opacity:.6"></div>
  <div class="sv-field"><label class="sv-label">Specific Location</label><input type="text" class="sv-input" id="f_specific_loc" placeholder="e.g., Loading dock B, north entrance"></div>
  <div class="sv-row">
    <div class="sv-field"><label class="sv-label">Visibility</label><select class="sv-input sv-select" id="f_visibility"><option value="">Select</option><option>Good</option><option>Fair</option><option>Poor</option><option>Dark</option></select></div>
    <div class="sv-field"><label class="sv-label">Surface Conditions</label><select class="sv-input sv-select" id="f_surface"><option value="">Select</option><option>Dry</option><option>Wet</option><option>Icy</option><option>Oily</option><option>Uneven</option><option>Other</option></select></div>
  </div>
  <div class="sv-row">
    <div class="sv-field"><label class="sv-label">Temperature</label><input type="text" class="sv-input" id="f_temp" placeholder="e.g., 85&#176;F, humid"></div>
    <div class="sv-field"><label class="sv-label">People Involved</label><input type="number" class="sv-input" id="f_people" min="1" value="1"></div>
  </div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 3: Injured Party -->
<div class="wizard-step" id="step-3">
<div class="card">
  <div class="step-title">Step 3 of 9</div>
  <div class="step-heading">Who was injured?</div>
  <label class="no-injury-toggle"><input type="checkbox" id="f_no_injury" onchange="toggleNoInjury()"> No injury occurred â€” skip injury details</label>
  <div id="injuryFields">
    <div class="sv-field"><label class="sv-label sv-required">Full Name</label><input type="text" class="sv-input" id="f_inj_name"></div>
    <div class="sv-field"><label class="sv-label sv-required">Job Title</label><input type="text" class="sv-input" id="f_inj_title"></div>
    <div class="sv-field"><label class="sv-label">Treatment</label>
      <div class="sv-radio-group" id="f_treatment">
        <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="treatment" value="refused">Refused</label>
        <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="treatment" value="first_aid">First Aid</label>
        <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="treatment" value="ems">EMS Transport</label>
        <label class="sv-radio-card" onclick="selectRadio(this)"><input type="radio" name="treatment" value="self_transport">Self-Transport</label>
      </div>
    </div>
    <div class="sv-field"><label class="sv-label">Local Branch Contact</label><input type="text" class="sv-input" id="f_local_contact" placeholder="Name, phone, or email"></div>
  </div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 4: Injury Classification -->
<div class="wizard-step" id="step-4">
<div class="card">
  <div class="step-title">Step 4 of 9</div>
  <div class="step-heading">What type of injury occurred?</div>
  <div class="sv-field"><label class="sv-label">Injury Types (check all that apply)</label>
    <div class="cb-grid" id="f_injury_types">
      <label class="cb-item"><input type="checkbox" value="Abrasion/Scratch">Abrasion/Scratch</label>
      <label class="cb-item"><input type="checkbox" value="Amputation">Amputation</label>
      <label class="cb-item"><input type="checkbox" value="Bite">Bite</label>
      <label class="cb-item"><input type="checkbox" value="Bruise/Contusion">Bruise/Contusion</label>
      <label class="cb-item"><input type="checkbox" value="Burn">Burn (thermal)</label>
      <label class="cb-item"><input type="checkbox" value="Chemical/Allergic">Chemical/Allergic</label>
      <label class="cb-item"><input type="checkbox" value="Cold-Related">Cold-Related</label>
      <label class="cb-item"><input type="checkbox" value="Concussion">Concussion</label>
      <label class="cb-item"><input type="checkbox" value="Crush Injury">Crush Injury</label>
      <label class="cb-item"><input type="checkbox" value="Dislocation">Dislocation</label>
      <label class="cb-item"><input type="checkbox" value="Foreign Object">Foreign Object</label>
      <label class="cb-item"><input type="checkbox" value="Fracture/Break">Fracture/Break</label>
      <label class="cb-item"><input type="checkbox" value="Heat-Related">Heat-Related</label>
      <label class="cb-item"><input type="checkbox" value="Internal Injury">Internal Injury</label>
      <label class="cb-item"><input type="checkbox" value="Laceration/Cut">Laceration/Cut</label>
      <label class="cb-item"><input type="checkbox" value="Sting">Sting</label>
      <label class="cb-item"><input type="checkbox" value="Strain/Sprain">Strain/Sprain</label>
      <label class="cb-item"><input type="checkbox" value="Other">Other</label>
    </div>
  </div>
  <div class="sv-row">
    <div class="sv-field"><label class="sv-label">Severity</label><select class="sv-input sv-select" id="f_severity"><option value="">Select</option><option>Minor</option><option>Moderate</option><option>Severe</option><option>Life-Threatening</option></select></div>
    <div class="sv-field"><label class="sv-label">Body Part Injured</label><input type="text" class="sv-input" id="f_body_part" placeholder="Include left/right side"></div>
  </div>
  <div class="sv-field"><label class="sv-label">Comments</label><textarea class="sv-input sv-textarea" id="f_inj_comments" placeholder="Additional details about the injury..."></textarea></div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 5: What Happened -->
<div class="wizard-step" id="step-5">
<div class="card">
  <div class="step-title">Step 5 of 9</div>
  <div class="step-heading">Describe the incident</div>
  <div class="sv-field"><label class="sv-label">What was the employee doing right before the incident?</label><textarea class="sv-input sv-textarea" id="f_activity" placeholder="e.g., Walking to break room, operating forklift, carrying materials..."></textarea></div>
  <div class="sv-field"><label class="sv-label sv-required">Describe what happened in detail</label><textarea class="sv-input sv-textarea lg" id="f_description" placeholder="Include who was involved, what happened, when and where..."></textarea></div>
  <div class="sv-field"><label class="sv-label">What object, substance, or condition caused harm?</label><input type="text" class="sv-input" id="f_cause" placeholder="e.g., Wet floor, forklift, chemical splash"></div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 6: Witnesses -->
<div class="wizard-step" id="step-6">
<div class="card">
  <div class="step-title">Step 6 of 9</div>
  <div class="step-heading">Witness information</div>
  <div class="sv-helper" style="margin-bottom:1rem">Add up to 2 witnesses. If there are no witnesses, skip to the next step.</div>
  <div id="witnessContainer"></div>
  <button class="add-btn" id="addWitnessBtn" onclick="addWitness()">+ Add Witness</button>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 7: Motor Vehicle -->
<div class="wizard-step" id="step-7">
<div class="card">
  <div class="step-title">Step 7 of 9</div>
  <div class="step-heading">Did this incident involve a motor vehicle?</div>
  <div class="toggle-group">
    <button class="toggle-btn yes" onclick="toggleVehicle(true)">Yes</button>
    <button class="toggle-btn no selected" onclick="toggleVehicle(false)">No</button>
  </div>
  <div id="vehicleFields" style="display:none">
    <div class="sv-row"><div class="sv-field"><label class="sv-label">Make</label><input type="text" class="sv-input" id="f_v_make"></div><div class="sv-field"><label class="sv-label">Model</label><input type="text" class="sv-input" id="f_v_model"></div></div>
    <div class="sv-row-3"><div class="sv-field"><label class="sv-label">Color</label><input type="text" class="sv-input" id="f_v_color"></div><div class="sv-field"><label class="sv-label">Year</label><input type="text" class="sv-input" id="f_v_year"></div><div class="sv-field"><label class="sv-label">Plate</label><input type="text" class="sv-input" id="f_v_plate"></div></div>
    <div class="sv-field"><label class="sv-label">Damage Location</label><input type="text" class="sv-input" id="f_v_damage" placeholder="e.g., Front bumper, driver side door"></div>
  </div>
  <div id="noVehicleMsg"><div class="info-box">No motor vehicle involved. Continue to the next step.</div></div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 8: Root Cause -->
<div class="wizard-step" id="step-8">
<div class="card">
  <div class="step-title">Step 8 of 9</div>
  <div class="step-heading">Identify contributing factors</div>
  <div class="rc-section">
    <div class="rc-title">Unsafe Acts</div>
    <div class="rc-grid" id="f_rc_acts">
      <label class="cb-item"><input type="checkbox" value="Bypassing safety device">Bypassing safety device</label>
      <label class="cb-item"><input type="checkbox" value="Distracted while moving">Distracted while moving</label>
      <label class="cb-item"><input type="checkbox" value="Failure to follow procedure">Failure to follow procedure</label>
      <label class="cb-item"><input type="checkbox" value="Failure to use safety device">Failure to use safety device</label>
      <label class="cb-item"><input type="checkbox" value="Horseplay">Horseplay</label>
      <label class="cb-item"><input type="checkbox" value="Improper lifting">Improper lifting</label>
      <label class="cb-item"><input type="checkbox" value="Improper PPE use">Improper PPE use</label>
      <label class="cb-item"><input type="checkbox" value="Improper work technique">Improper work technique</label>
      <label class="cb-item"><input type="checkbox" value="Loss of vigilance">Loss of vigilance</label>
      <label class="cb-item"><input type="checkbox" value="Operating at improper speed">Operating at improper speed</label>
      <label class="cb-item"><input type="checkbox" value="Operating without authorization">Operating w/o authorization</label>
      <label class="cb-item"><input type="checkbox" value="Personal medical">Personal medical</label>
      <label class="cb-item"><input type="checkbox" value="Safety rule violation">Safety rule violation</label>
      <label class="cb-item"><input type="checkbox" value="Unnecessary haste">Unnecessary haste</label>
      <label class="cb-item"><input type="checkbox" value="Unsafe act of others">Unsafe act of others</label>
    </div>
  </div>
  <div class="rc-section">
    <div class="rc-title">Unsafe Conditions</div>
    <div class="rc-grid" id="f_rc_conditions">
      <label class="cb-item"><input type="checkbox" value="Congested work area">Congested work area</label>
      <label class="cb-item"><input type="checkbox" value="Construction hazard">Construction hazard</label>
      <label class="cb-item"><input type="checkbox" value="Equipment defect">Equipment defect</label>
      <label class="cb-item"><input type="checkbox" value="Excessive noise">Excessive noise</label>
      <label class="cb-item"><input type="checkbox" value="Fire hazard">Fire hazard</label>
      <label class="cb-item"><input type="checkbox" value="Hazardous substances">Hazardous substances</label>
      <label class="cb-item"><input type="checkbox" value="Improper lighting">Improper lighting</label>
      <label class="cb-item"><input type="checkbox" value="Improper material storage">Improper material storage</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate fall protection">Inadequate fall protection</label>
      <label class="cb-item"><input type="checkbox" value="Missing safety device">Missing safety device</label>
      <label class="cb-item"><input type="checkbox" value="Poor housekeeping">Poor housekeeping</label>
      <label class="cb-item"><input type="checkbox" value="Poor surface conditions">Poor surface conditions</label>
      <label class="cb-item"><input type="checkbox" value="Sharp edge">Sharp edge</label>
      <label class="cb-item"><input type="checkbox" value="Slippery conditions">Slippery conditions</label>
      <label class="cb-item"><input type="checkbox" value="Trip hazard">Trip hazard</label>
      <label class="cb-item"><input type="checkbox" value="Weather-related">Weather-related</label>
      <label class="cb-item"><input type="checkbox" value="Other unsafe condition">Other</label>
    </div>
  </div>
  <div class="rc-section">
    <div class="rc-title">Management Systems</div>
    <div class="rc-grid" id="f_rc_mgmt">
      <label class="cb-item"><input type="checkbox" value="Hazard not identified">Hazard not identified</label>
      <label class="cb-item"><input type="checkbox" value="Improper maintenance">Improper maintenance</label>
      <label class="cb-item"><input type="checkbox" value="Improper supervisor training">Improper supervisor training</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate equipment">Inadequate equipment</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate hiring practice">Inadequate hiring practice</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate supervision">Inadequate supervision</label>
      <label class="cb-item"><input type="checkbox" value="Inadequate task planning">Inadequate task planning</label>
      <label class="cb-item"><input type="checkbox" value="Insufficient follow-up">Insufficient follow-up</label>
      <label class="cb-item"><input type="checkbox" value="Insufficient training">Insufficient training</label>
      <label class="cb-item"><input type="checkbox" value="Lack of procedure">Lack of procedure</label>
      <label class="cb-item"><input type="checkbox" value="Poor process design">Poor process design</label>
      <label class="cb-item"><input type="checkbox" value="PPE unavailable">PPE unavailable</label>
      <label class="cb-item"><input type="checkbox" value="Previously identified hazard">Previously identified hazard</label>
      <label class="cb-item"><input type="checkbox" value="Safety rule not enforced">Safety rule not enforced</label>
      <label class="cb-item"><input type="checkbox" value="Unrealistic schedule">Unrealistic schedule</label>
      <label class="cb-item"><input type="checkbox" value="Unsafe design">Unsafe design</label>
      <label class="cb-item"><input type="checkbox" value="Other management factor">Other</label>
    </div>
  </div>
  <div class="sv-field"><label class="sv-label">Immediate actions taken to mitigate the hazard</label><textarea class="sv-input sv-textarea" id="f_immediate" placeholder="What corrective actions were taken right away?"></textarea></div>
  <div class="sv-field"><label class="sv-label">What should be done to prevent recurrence?</label><textarea class="sv-input sv-textarea" id="f_prevention" placeholder="Recommended corrective and preventive actions..."></textarea></div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-next" onclick="nextStep()">Continue</button></div>
</div>

<!-- STEP 9: OSHA Classification -->
<div class="wizard-step" id="step-9">
<div class="card">
  <div class="step-title">Step 9 of 9</div>
  <div class="step-heading">OSHA Recordkeeping Classification</div>
  <div class="info-box">Select the most serious outcome of this incident. If the outcome is not yet known, select "N/A - Pending" and update later.</div>

  <div class="sv-field"><label class="sv-label">Outcome Classification</label>
    <div id="f_osha_outcome">
      <label class="osha-card" onclick="selectOsha(this,'sel-red')"><input type="radio" name="osha_outcome" value="death"><span class="oc-title">Death</span><span class="oc-desc">Fatality resulting from the incident</span></label>
      <label class="osha-card" onclick="selectOsha(this,'selected')"><input type="radio" name="osha_outcome" value="days_away"><span class="oc-title">Days Away From Work</span><span class="oc-desc">Employee missed one or more days</span></label>
      <label class="osha-card" onclick="selectOsha(this,'selected')"><input type="radio" name="osha_outcome" value="job_transfer_restriction"><span class="oc-title">Job Transfer or Restriction</span><span class="oc-desc">Employee transferred or had restricted duties</span></label>
      <label class="osha-card" onclick="selectOsha(this,'selected')"><input type="radio" name="osha_outcome" value="other_recordable"><span class="oc-title">Other Recordable Case</span><span class="oc-desc">Medical treatment beyond first aid</span></label>
      <label class="osha-card" onclick="selectOsha(this,'sel-green')"><input type="radio" name="osha_outcome" value="na_pending"><span class="oc-title">N/A - Classification Pending</span><span class="oc-desc">Outcome not yet determined, can update later</span></label>
    </div>
  </div>

  <div class="sv-field"><label class="sv-label">Injury or Illness?</label>
    <div class="sv-radio-group" id="f_inj_or_ill">
      <label class="sv-radio-card" onclick="selectRadio(this);toggleIllnessType()"><input type="radio" name="inj_or_ill" value="injury">Injury</label>
      <label class="sv-radio-card" onclick="selectRadio(this);toggleIllnessType()"><input type="radio" name="inj_or_ill" value="illness">Illness</label>
    </div>
  </div>

  <div class="sv-field" id="illnessTypeField" style="display:none">
    <label class="sv-label">Illness Type</label>
    <select class="sv-input sv-select" id="f_illness_type"><option value="">Select</option><option value="skin_disorder">Skin Disorder</option><option value="respiratory">Respiratory Condition</option><option value="poisoning">Poisoning</option><option value="hearing_loss">Hearing Loss</option><option value="all_other">All Other Illnesses</option></select>
  </div>

  <div id="daysFields" style="display:none">
    <div class="sv-row">
      <div class="sv-field"><label class="sv-label">Days Away From Work</label><input type="number" class="sv-input" id="f_days_away" min="0" value="0"></div>
      <div class="sv-field"><label class="sv-label">Days of Restricted Duty</label><input type="number" class="sv-input" id="f_days_restricted" min="0" value="0"></div>
    </div>
  </div>
</div>
<div class="wizard-nav"><button class="wbtn wbtn-prev" onclick="prevStep()">Back</button><button class="wbtn wbtn-submit" onclick="submitReport()" id="submitBtn">Submit Incident Report</button></div>
</div>

<!-- SUCCESS SCREEN -->
<div class="success-screen" id="successScreen">
  <div class="success-icon">&#10003;</div>
  <h2>Incident Report Submitted</h2>
  <p>Case #<span id="successCaseNum"></span> has been recorded successfully.</p>
  <div class="success-actions">
    <button class="sa-primary" onclick="resetForm()">Submit Another Report</button>
    <button class="sa-secondary" onclick="showPanel('list')">View Past Reports</button>
    <button class="sa-secondary" onclick="downloadOSHA301FromLast()">Download OSHA 301 PDF</button>
  </div>
</div>

</div>
</div>

<!-- PAST REPORTS PANEL -->
<div class="panel" id="panel-list">
<div class="content">
  <div id="incidentsList"></div>
</div>
</div>

<!-- OSHA DOWNLOADS PANEL -->
<div class="panel" id="panel-reports">
<div class="content">
  <div class="card">
    <div class="step-title">OSHA Form Downloads</div>
    <div class="step-heading">Generate &amp; Download Official OSHA Forms</div>
    <div class="info-box">Select a year and download pre-filled OSHA recordkeeping forms. Data is pulled from your submitted incident reports.</div>

    <div class="sv-field">
      <label class="sv-label">Year</label>
      <select class="sv-input sv-select" id="oshaYear" style="max-width:200px"></select>
    </div>

    <div style="display:flex;flex-direction:column;gap:.75rem;margin-top:1.5rem">
      <div class="card" style="padding:1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem">
        <div><div style="font-size:.9rem;font-weight:700;color:#f1f5f9">OSHA 300 &mdash; Log of Injuries &amp; Illnesses</div><div style="font-size:.75rem;color:#64748b;margin-top:.15rem">All incidents for the selected year (10 per page)</div></div>
        <button class="wbtn wbtn-next" style="padding:.6rem 1.5rem;font-size:.8rem" onclick="downloadOSHA300()" id="btn300">Download 300 Log</button>
      </div>
      <div class="card" style="padding:1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem">
        <div><div style="font-size:.9rem;font-weight:700;color:#f1f5f9">OSHA 300A &mdash; Annual Summary</div><div style="font-size:.75rem;color:#64748b;margin-top:.15rem">Calculated totals and company information</div></div>
        <button class="wbtn wbtn-next" style="padding:.6rem 1.5rem;font-size:.8rem" onclick="downloadOSHA300A()" id="btn300a">Download 300A Summary</button>
      </div>
      <div class="card" style="padding:1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem">
        <div><div style="font-size:.9rem;font-weight:700;color:#f1f5f9">OSHA 301 &mdash; Individual Incident Report</div><div style="font-size:.75rem;color:#64748b;margin-top:.15rem">Select a specific case to download</div></div>
        <select class="sv-input sv-select" id="osha301Case" style="max-width:200px;display:inline-block"></select>
        <button class="wbtn wbtn-next" style="padding:.6rem 1.5rem;font-size:.8rem" onclick="downloadOSHA301()" id="btn301">Download 301</button>
      </div>
    </div>
    <div id="pdfStatus" style="margin-top:1rem;font-size:.82rem;color:#64748b"></div>
  </div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL='https://cfuupedcjroqarmgqcyn.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmdXVwZWRjanJvcWFybWdxY3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNjQ1ODksImV4cCI6MjA4Njk0MDU4OX0.kHqVQPBCljGhk8lkd_LN4JxhT1ywOIKapXKmJZD1LEo';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let currentStep=1;
const totalSteps=9;
const stepLabels=['Contact','Incident','Injured','Injury','Details','Witness','Vehicle','Root Cause','OSHA'];
let formData={};
let lastSubmitted=null;
let vehicleApplicable=false;
let witnessCount=0;

// Init
document.addEventListener('DOMContentLoaded',()=>{
  buildProgressBar();
  showStep(1);
  const now=new Date();
  document.getElementById('f_date').value=now.toISOString().split('T')[0];
  document.getElementById('f_time').value=now.toTimeString().slice(0,5);
  document.getElementById('f_report_time').value=now.toLocaleString();
});

function buildProgressBar(){
  const bar=document.getElementById('progressBar');
  bar.innerHTML=stepLabels.map((l,i)=>`<div class="wsi"><div class="wsc" id="wsc-${i+1}">${i+1}</div><div class="wsl" id="wsl-${i+1}">${l}</div></div>`).join('');
}

function updateProgress(){
  for(let i=1;i<=totalSteps;i++){
    const c=document.getElementById('wsc-'+i);
    const l=document.getElementById('wsl-'+i);
    c.className='wsc'+(i<currentStep?' done':i===currentStep?' active':'');
    l.className='wsl'+(i<currentStep?' done':i===currentStep?' active':'');
    if(i<currentStep)c.innerHTML='&#10003;';
    else c.textContent=i;
  }
}

function showStep(n){
  document.querySelectorAll('.wizard-step').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById('step-'+n);
  if(el){el.classList.add('active');el.scrollIntoView({behavior:'smooth',block:'start'});}
  updateProgress();
  // Skip step 4 if no injury
  if(n===4&&document.getElementById('f_no_injury').checked){
    if(currentStep>formData._prevStep)currentStep=5;
    else currentStep=3;
    showStep(currentStep);
    return;
  }
}

function nextStep(){
  if(!validateStep(currentStep))return;
  collectStepData(currentStep);
  formData._prevStep=currentStep;
  currentStep++;
  showStep(currentStep);
}

function prevStep(){
  collectStepData(currentStep);
  formData._prevStep=currentStep;
  currentStep--;
  // Skip step 4 if no injury
  if(currentStep===4&&document.getElementById('f_no_injury').checked)currentStep=3;
  showStep(currentStep);
}

function validateStep(n){
  let valid=true;
  const check=(id)=>{
    const el=document.getElementById(id);
    if(!el.value.trim()){el.classList.add('sv-error');valid=false;
      el.addEventListener('input',()=>el.classList.remove('sv-error'),{once:true});
    }
  };
  if(n===1){check('f_rp_name');check('f_rp_title');check('f_site');}
  if(n===2){check('f_date');check('f_time');}
  if(n===3&&!document.getElementById('f_no_injury').checked){check('f_inj_name');check('f_inj_title');}
  if(n===5){check('f_description');}
  if(!valid)showToast('Please fill in all required fields','error');
  return valid;
}

function collectStepData(n){
  const v=id=>{const el=document.getElementById(id);return el?el.value.trim():'';};
  const r=name=>{const el=document.querySelector(`input[name="${name}"]:checked`);return el?el.value:'';};
  const cbs=id=>[...document.querySelectorAll(`#${id} input:checked`)].map(c=>c.value);

  if(n===1){formData.reporting_party_name=v('f_rp_name');formData.reporting_party_title=v('f_rp_title');formData.site_location=v('f_site');}
  if(n===2){formData.incident_date=v('f_date');formData.incident_time=v('f_time');formData.specific_location=v('f_specific_loc');formData.visibility=v('f_visibility');formData.surface_conditions=v('f_surface');formData.temperature=v('f_temp');formData.num_people_involved=parseInt(v('f_people'))||1;}
  if(n===3){formData.no_injury=document.getElementById('f_no_injury').checked;formData.injured_name=v('f_inj_name');formData.injured_title=v('f_inj_title');formData.treatment_type=r('treatment');formData.local_contact=v('f_local_contact');}
  if(n===4){formData.injury_types=cbs('f_injury_types');formData.severity=v('f_severity');formData.body_part=v('f_body_part');formData.injury_comments=v('f_inj_comments');}
  if(n===5){formData.activity_before=v('f_activity');formData.incident_description=v('f_description');formData.what_caused_harm=v('f_cause');}
  if(n===6){formData.witnesses=collectWitnesses();}
  if(n===7){formData.motor_vehicle_applicable=vehicleApplicable;if(vehicleApplicable){formData.vehicle_info={make:v('f_v_make'),model:v('f_v_model'),color:v('f_v_color'),year:v('f_v_year'),plate:v('f_v_plate'),damage_location:v('f_v_damage')};}else{formData.vehicle_info={};}}
  if(n===8){formData.root_cause_unsafe_acts=cbs('f_rc_acts');formData.root_cause_unsafe_conditions=cbs('f_rc_conditions');formData.root_cause_management=cbs('f_rc_mgmt');formData.immediate_actions=v('f_immediate');formData.prevention_recommendations=v('f_prevention');}
  if(n===9){formData.osha_outcome=r('osha_outcome');formData.injury_or_illness=r('inj_or_ill');formData.illness_type=v('f_illness_type');formData.days_away_from_work=parseInt(v('f_days_away'))||0;formData.days_restricted_duty=parseInt(v('f_days_restricted'))||0;}
}

// UI Helpers
function selectRadio(el){
  el.closest('.sv-radio-group').querySelectorAll('.sv-radio-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  el.querySelector('input').checked=true;
}

function selectOsha(el,cls){
  document.querySelectorAll('#f_osha_outcome .osha-card').forEach(c=>{c.className='osha-card';});
  el.classList.add(cls);
  el.querySelector('input').checked=true;
  const val=el.querySelector('input').value;
  document.getElementById('daysFields').style.display=(val==='days_away'||val==='job_transfer_restriction')?'block':'none';
}

function toggleIllnessType(){
  const val=document.querySelector('input[name="inj_or_ill"]:checked');
  document.getElementById('illnessTypeField').style.display=(val&&val.value==='illness')?'block':'none';
}

function toggleNoInjury(){
  const checked=document.getElementById('f_no_injury').checked;
  document.getElementById('injuryFields').style.display=checked?'none':'block';
}

function toggleVehicle(yes){
  vehicleApplicable=yes;
  document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('selected'));
  if(yes)document.querySelector('.toggle-btn.yes').classList.add('selected');
  else document.querySelector('.toggle-btn.no').classList.add('selected');
  document.getElementById('vehicleFields').style.display=yes?'block':'none';
  document.getElementById('noVehicleMsg').style.display=yes?'none':'block';
}

// Witnesses
function addWitness(){
  if(witnessCount>=2)return;
  witnessCount++;
  const div=document.createElement('div');
  div.className='witness-block';
  div.id='witness-'+witnessCount;
  div.innerHTML=`<button class="remove-btn" onclick="removeWitness(${witnessCount})">Remove</button>
    <div style="font-size:.8rem;font-weight:700;color:#f59e0b;margin-bottom:.75rem">Witness ${witnessCount}</div>
    <div class="sv-row"><div class="sv-field"><label class="sv-label">Name</label><input type="text" class="sv-input w-name"></div>
    <div class="sv-field"><label class="sv-label">Contact Info</label><input type="text" class="sv-input w-contact"></div></div>
    <div class="sv-row"><div class="sv-field"><label class="sv-label">Statement Attached?</label>
    <div class="sv-radio-group"><label class="sv-radio-card" onclick="selectRadio(this)" style="min-width:60px"><input type="radio" name="w${witnessCount}_stmt" value="yes">Yes</label>
    <label class="sv-radio-card" onclick="selectRadio(this)" style="min-width:60px"><input type="radio" name="w${witnessCount}_stmt" value="no">No</label></div></div>
    <div class="sv-field"><label class="sv-label">If no, why?</label><input type="text" class="sv-input w-reason"></div></div>`;
  document.getElementById('witnessContainer').appendChild(div);
  if(witnessCount>=2)document.getElementById('addWitnessBtn').style.display='none';
}

function removeWitness(n){
  const el=document.getElementById('witness-'+n);
  if(el)el.remove();
  witnessCount--;
  document.getElementById('addWitnessBtn').style.display='inline-flex';
}

function collectWitnesses(){
  const witnesses=[];
  document.querySelectorAll('.witness-block').forEach(block=>{
    const name=block.querySelector('.w-name')?.value||'';
    const contact=block.querySelector('.w-contact')?.value||'';
    const stmt=block.querySelector('input[type="radio"]:checked')?.value||'';
    const reason=block.querySelector('.w-reason')?.value||'';
    if(name)witnesses.push({name,contact,statement_attached:stmt,reason_not:reason});
  });
  return witnesses;
}

// Submit
async function submitReport(){
  if(!validateStep(currentStep))return;
  collectStepData(currentStep);
  const btn=document.getElementById('submitBtn');
  btn.disabled=true;btn.textContent='Submitting...';

  const row={
    reporting_party_name:formData.reporting_party_name,
    reporting_party_title:formData.reporting_party_title,
    site_location:formData.site_location,
    incident_date:formData.incident_date||null,
    incident_time:formData.incident_time||null,
    specific_location:formData.specific_location,
    visibility:formData.visibility,
    surface_conditions:formData.surface_conditions,
    temperature:formData.temperature,
    num_people_involved:formData.num_people_involved,
    injured_name:formData.injured_name,
    injured_title:formData.injured_title,
    local_contact:formData.local_contact,
    treatment_type:formData.treatment_type||null,
    injury_types:formData.injury_types||[],
    severity:formData.severity,
    body_part:formData.body_part,
    injury_comments:formData.injury_comments,
    activity_before:formData.activity_before,
    incident_description:formData.incident_description,
    what_caused_harm:formData.what_caused_harm,
    witnesses:formData.witnesses||[],
    motor_vehicle_applicable:formData.motor_vehicle_applicable||false,
    vehicle_info:formData.vehicle_info||{},
    root_cause_unsafe_acts:formData.root_cause_unsafe_acts||[],
    root_cause_unsafe_conditions:formData.root_cause_unsafe_conditions||[],
    root_cause_management:formData.root_cause_management||[],
    immediate_actions:formData.immediate_actions,
    prevention_recommendations:formData.prevention_recommendations,
    osha_outcome:formData.osha_outcome||null,
    injury_or_illness:formData.injury_or_illness||null,
    illness_type:formData.illness_type||null,
    days_away_from_work:formData.days_away_from_work||0,
    days_restricted_duty:formData.days_restricted_duty||0,
    no_injury:formData.no_injury||false,
    status:'submitted'
  };

  try{
    const{data,error}=await sb.from('incidents').insert([row]).select();
    if(error)throw error;
    lastSubmitted=data[0];
    document.getElementById('successCaseNum').textContent=data[0].case_number;
    document.querySelectorAll('.wizard-step').forEach(s=>s.classList.remove('active'));
    document.getElementById('successScreen').style.display='block';
    showToast('Incident report submitted!','success');
  }catch(e){
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.textContent='Submit Incident Report';
}

function resetForm(){
  formData={};currentStep=1;witnessCount=0;vehicleApplicable=false;lastSubmitted=null;
  document.querySelectorAll('.sv-input,.sv-textarea').forEach(el=>{if(!el.readOnly)el.value='';});
  document.querySelectorAll('.sv-select').forEach(el=>el.selectedIndex=0);
  document.querySelectorAll('input[type="checkbox"],input[type="radio"]').forEach(el=>el.checked=false);
  document.querySelectorAll('.sv-radio-card,.osha-card').forEach(el=>el.className=el.className.replace(/selected|sel-red|sel-green/g,'').trim());
  document.getElementById('witnessContainer').innerHTML='';
  document.getElementById('addWitnessBtn').style.display='inline-flex';
  toggleVehicle(false);
  document.getElementById('f_no_injury').checked=false;
  toggleNoInjury();
  document.getElementById('illnessTypeField').style.display='none';
  document.getElementById('daysFields').style.display='none';
  document.getElementById('successScreen').style.display='none';
  const now=new Date();
  document.getElementById('f_date').value=now.toISOString().split('T')[0];
  document.getElementById('f_time').value=now.toTimeString().slice(0,5);
  document.getElementById('f_report_time').value=now.toLocaleString();
  showStep(1);
}

// Panels & List
function showPanel(name){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(event&&event.target)event.target.classList.add('active');
  else document.querySelectorAll('.tab')[name==='wizard'?0:name==='list'?1:2].classList.add('active');
  if(name==='list')loadIncidents();
  if(name==='reports')loadReportsPanel();
}

async function loadIncidents(){
  const container=document.getElementById('incidentsList');
  container.innerHTML='<div style="text-align:center;color:#64748b;padding:2rem">Loading...</div>';
  try{
    const{data,error}=await sb.from('incidents').select('*').order('created_at',{ascending:false});
    if(error)throw error;
    if(!data||data.length===0){
      container.innerHTML='<div style="text-align:center;color:#64748b;padding:3rem"><div style="font-size:2rem;margin-bottom:.5rem">&#128203;</div>No incident reports yet.<br>Use the form to create your first report.</div>';
      return;
    }
    container.innerHTML=data.map(inc=>{
      const badge=inc.osha_outcome==='na_pending'?'<span class="il-badge pending">Pending</span>':'<span class="il-badge recorded">Recorded</span>';
      const date=inc.incident_date?new Date(inc.incident_date).toLocaleDateString():'N/A';
      return `<div class="il-card">
        <div class="il-top"><span class="il-case">Case #${inc.case_number}</span>${badge}</div>
        <div class="il-top"><span class="il-date">${date} ${inc.incident_time||''}</span><span class="il-date">${inc.site_location||''}</span></div>
        <div class="il-details">${inc.no_injury?'No injury reported':(inc.injured_name||'Unknown')+' &mdash; '+(inc.severity||'N/A')+' &mdash; '+(inc.injury_types||[]).join(', ')}</div>
        <div style="margin-top:.5rem;font-size:.78rem;color:#64748b">${(inc.incident_description||'').substring(0,120)}${(inc.incident_description||'').length>120?'...':''}</div>
      </div>`;
    }).join('');
  }catch(e){
    container.innerHTML='<div style="text-align:center;color:#f87171;padding:2rem">Error loading: '+e.message+'</div>';
  }
}

function showToast(msg,type){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast '+type+' show';
  setTimeout(()=>t.classList.remove('show'),3000);
}

// ===== OSHA PDF EXPORT =====
const PDF_URL='../osha-forms/osha-forms-package.pdf';
let cachedPdfBytes=null;
let companySettings=null;

async function loadPdfBytes(){
  if(cachedPdfBytes)return cachedPdfBytes.slice(0);
  const resp=await fetch(PDF_URL);
  if(!resp.ok)throw new Error('Could not load OSHA PDF template');
  cachedPdfBytes=await resp.arrayBuffer();
  return cachedPdfBytes.slice(0);
}

async function loadCompanySettings(){
  if(companySettings)return companySettings;
  const{data,error}=await sb.from('company_settings').select('*').limit(1);
  if(error)throw error;
  companySettings=(data&&data.length>0)?data[0]:{};
  return companySettings;
}

async function loadReportsPanel(){
  const stat=document.getElementById('pdfStatus');
  stat.textContent='Loading data...';
  try{
    const{data,error}=await sb.from('incidents').select('case_number,incident_date,injured_name').order('incident_date',{ascending:false});
    if(error)throw error;
    // Populate year picker
    const yearSel=document.getElementById('oshaYear');
    const years=new Set();
    const curYear=new Date().getFullYear();
    years.add(curYear);
    (data||[]).forEach(d=>{if(d.incident_date)years.add(new Date(d.incident_date).getFullYear());});
    const sortedYears=[...years].sort((a,b)=>b-a);
    yearSel.innerHTML=sortedYears.map(y=>`<option value="${y}">${y}</option>`).join('');
    // Populate 301 case picker
    const caseSel=document.getElementById('osha301Case');
    if(!data||data.length===0){
      caseSel.innerHTML='<option value="">No incidents</option>';
    }else{
      caseSel.innerHTML=data.map(d=>`<option value="${d.case_number}">Case #${d.case_number} - ${d.injured_name||'No injury'}</option>`).join('');
    }
    stat.textContent=`${(data||[]).length} incident(s) available`;
  }catch(e){
    stat.textContent='Error: '+e.message;
  }
}

function setPdfField(form,name,value){
  try{
    const f=form.getTextField(name);
    if(f&&value)f.setText(String(value));
  }catch(e){}
}

function setPdfCheck(form,name,checked){
  try{
    const f=form.getCheckBox(name);
    if(f&&checked)f.check();
  }catch(e){}
}

// OSHA 301 â€” Individual Incident Report
async function downloadOSHA301(){
  const caseNum=document.getElementById('osha301Case').value;
  if(!caseNum){showToast('Select a case first','error');return;}
  const btn=document.getElementById('btn301');
  btn.disabled=true;btn.textContent='Generating...';
  try{
    const{data,error}=await sb.from('incidents').select('*').eq('case_number',parseInt(caseNum)).limit(1);
    if(error)throw error;
    if(!data||data.length===0)throw new Error('Incident not found');
    await generateOSHA301PDF(data[0]);
  }catch(e){
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.textContent='Download 301';
}

async function downloadOSHA301FromLast(){
  if(!lastSubmitted){showToast('No recent submission','error');return;}
  try{await generateOSHA301PDF(lastSubmitted);}
  catch(e){showToast('Error: '+e.message,'error');}
}

async function generateOSHA301PDF(inc){
  const pdfBytes=await loadPdfBytes();
  const co=await loadCompanySettings();
  const{PDFDocument}=PDFLib;
  const pdfDoc=await PDFDocument.load(pdfBytes);
  const form=pdfDoc.getForm();

  // Company/establishment info
  setPdfField(form,'301 Facility Name',co.establishment_name||'');
  setPdfField(form,'301 Facility Address Street',co.street||'');
  setPdfField(form,'301 Facility Address City',co.city||'');
  setPdfField(form,'301 Facility Address State',co.state||'');
  setPdfField(form,'301 Facility Address Zip',co.zip||'');

  // Employee / injured party
  setPdfField(form,'301 Full name',inc.injured_name||'');
  setPdfField(form,'301 Address Street',inc.local_contact||'');

  // Incident details
  if(inc.incident_date){
    const d=new Date(inc.incident_date);
    const ds=(d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear();
    setPdfField(form,'301 Date of Injury or Illness',ds);
  }
  if(inc.incident_time){
    const tp=inc.incident_time.split(':');
    let hr=parseInt(tp[0]),mn=tp[1]||'00',ampm='AM';
    if(hr>=12){ampm='PM';if(hr>12)hr-=12;}
    if(hr===0)hr=12;
    setPdfField(form,'301 Time of event',hr+':'+mn);
    // Time AMPM is a radio group
    try{const rg=form.getRadioGroup('301 Time of Event AMPM');if(rg)rg.select(ampm);}
    catch(e){setPdfField(form,'301 Time of Event AMPM',ampm);}
  }

  setPdfField(form,'301 Activity Prior to Event',inc.activity_before||'');
  setPdfField(form,'301 What Happened',inc.incident_description||'');

  // Build injury description
  let injDesc='';
  if(inc.injury_types&&inc.injury_types.length>0)injDesc=inc.injury_types.join(', ');
  if(inc.body_part)injDesc+=(injDesc?' â€” ':'')+inc.body_part;
  if(inc.injury_comments)injDesc+=(injDesc?'. ':'')+inc.injury_comments;
  setPdfField(form,'301 Describe Injury or Illness',injDesc);

  setPdfField(form,'301 What Harmed Employee',inc.what_caused_harm||'');
  setPdfField(form,'301 Case Number',String(inc.case_number||''));

  // Treatment - ER and Hospitalized are radio/check buttons
  try{
    if(inc.treatment_type==='EMS'||inc.treatment_type==='Self-Transport'){
      const erField=form.getCheckBox('301 ER');
      if(erField)erField.check();
    }
  }catch(e){try{
    if(inc.treatment_type==='EMS'||inc.treatment_type==='Self-Transport'){
      const rg=form.getRadioGroup('301 ER');
      if(rg)rg.select('Yes');
    }
  }catch(e2){}}

  // Completed by
  setPdfField(form,'301 Completed by',inc.reporting_party_name||'');
  setPdfField(form,'301 Title',inc.reporting_party_title||'');
  setPdfField(form,'301 Phone',co.phone||'');
  const today=new Date();
  setPdfField(form,'301 Date',(today.getMonth()+1)+'/'+today.getDate()+'/'+today.getFullYear());

  // Flatten form so filled values render as visible text
  form.flatten();
  // Extract only 301 pages (pages 10-11 = index 9-10)
  const newDoc=await PDFDocument.create();
  const pages=await newDoc.copyPages(pdfDoc,[9,10]);
  pages.forEach(p=>newDoc.addPage(p));
  const outBytes=await newDoc.save();
  downloadBlob(outBytes,'OSHA-301-Case-'+inc.case_number+'.pdf');
  showToast('OSHA 301 downloaded!','success');
}

// OSHA 300 â€” Log of Work-Related Injuries and Illnesses
async function downloadOSHA300(){
  const year=document.getElementById('oshaYear').value;
  if(!year){showToast('Select a year','error');return;}
  const btn=document.getElementById('btn300');
  btn.disabled=true;btn.textContent='Generating...';
  try{
    const startDate=year+'-01-01';
    const endDate=year+'-12-31';
    const{data,error}=await sb.from('incidents').select('*')
      .gte('incident_date',startDate).lte('incident_date',endDate)
      .order('incident_date',{ascending:true});
    if(error)throw error;
    if(!data||data.length===0){showToast('No incidents for '+year,'error');btn.disabled=false;btn.textContent='Download 300 Log';return;}
    await generateOSHA300PDF(data,year);
  }catch(e){
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.textContent='Download 300 Log';
}

async function generateOSHA300PDF(incidents,year){
  const pdfBytes=await loadPdfBytes();
  const co=await loadCompanySettings();
  const{PDFDocument}=PDFLib;
  const pdfDoc=await PDFDocument.load(pdfBytes);
  const form=pdfDoc.getForm();

  // Establishment header
  setPdfField(form,'Log of Injury/Illness Establishment name',co.establishment_name||'');
  setPdfField(form,'Log of Injury/Illness City',co.city||'');
  setPdfField(form,'Log of Injury/Illness State',co.state||'');
  setPdfField(form,'Log of Injury/Illness Year',String(year));

  // Fill rows (max 10 per page in the 300 form)
  const maxRows=Math.min(incidents.length,10);
  for(let i=0;i<maxRows;i++){
    const inc=incidents[i];
    const n=i+1;
    setPdfField(form,'Case No. '+n,String(inc.case_number||''));
    setPdfField(form,'Employee\'s Name '+n,inc.injured_name||'N/A');
    setPdfField(form,'Job Title '+n,inc.injured_title||'');
    if(inc.incident_date){
      const d=new Date(inc.incident_date);
      setPdfField(form,'Date of injury or Illness month '+n,String(d.getMonth()+1));
      setPdfField(form,'Date of injury or illness day '+n,String(d.getDate()));
    }
    setPdfField(form,'Where the Event Occurred '+n,inc.specific_location||'');

    // Build description
    let desc='';
    if(inc.injury_types&&inc.injury_types.length>0)desc=inc.injury_types.join(', ');
    if(inc.body_part)desc+=(desc?' - ':'')+inc.body_part;
    setPdfField(form,'Injury or Illness Description '+n,desc);

    // Days
    setPdfField(form,'Number of days injured or ill away from work '+n,String(inc.days_away_from_work||0));
    setPdfField(form,'On job transfer or restriction '+n,String(inc.days_restricted_duty||0));

    // Outcome checkboxes - Group[N] radio for G/H/I/J columns
    try{
      const rg=form.getRadioGroup('Group'+n);
      if(rg){
        const outcome=inc.osha_outcome;
        if(outcome==='death')rg.select('G');
        else if(outcome==='days_away')rg.select('H');
        else if(outcome==='job_transfer_restriction')rg.select('I');
        else if(outcome==='other_recordable')rg.select('J');
      }
    }catch(e){}

    // Injury vs Illness type - Group[N]a radio
    try{
      const rga=form.getRadioGroup('Group'+n+'a');
      if(rga){
        if(inc.injury_or_illness==='injury')rga.select('1');
        else if(inc.injury_or_illness==='illness'){
          const it=inc.illness_type||'';
          if(it.includes('Skin'))rga.select('2');
          else if(it.includes('Respiratory'))rga.select('3');
          else if(it.includes('Poison'))rga.select('4');
          else if(it.includes('Hear'))rga.select('5');
          else rga.select('6');
        }
      }
    }catch(e){}
  }

  // Column totals for 300 log
  let totDeath=0,totDaysAway=0,totJobTrans=0,totOtherRec=0;
  let totDA=0,totRD=0;
  let totInj=0,totSkin=0,totResp=0,totPoison=0,totHear=0,totAllOther=0;
  incidents.forEach(i=>{
    if(i.osha_outcome==='death')totDeath++;
    else if(i.osha_outcome==='days_away')totDaysAway++;
    else if(i.osha_outcome==='job_transfer_restriction')totJobTrans++;
    else if(i.osha_outcome==='other_recordable')totOtherRec++;
    totDA+=(i.days_away_from_work||0);totRD+=(i.days_restricted_duty||0);
    if(i.injury_or_illness==='injury')totInj++;
    else if(i.injury_or_illness==='illness'){
      const it=i.illness_type||'';
      if(it.includes('Skin'))totSkin++;
      else if(it.includes('Respiratory'))totResp++;
      else if(it.includes('Poison'))totPoison++;
      else if(it.includes('Hear'))totHear++;
      else totAllOther++;
    }
  });
  setPdfField(form,'Death Total',String(totDeath));
  setPdfField(form,'Days away from work Total',String(totDaysAway));
  setPdfField(form,'Job transfer or restriction Total',String(totJobTrans));
  setPdfField(form,'Other recordable cases Total',String(totOtherRec));
  setPdfField(form,'Number of days injured or ill away from work Total',String(totDA));
  setPdfField(form,'On job transfer or restriction Total',String(totRD));
  setPdfField(form,'Injury Total',String(totInj));
  setPdfField(form,'Skin Disorder Total',String(totSkin));
  setPdfField(form,'Respiratory Cond Total',String(totResp));
  setPdfField(form,'Poisoning Total',String(totPoison));
  setPdfField(form,'Hearling Loss Total',String(totHear));
  setPdfField(form,'All other Total',String(totAllOther));

  // If >10 incidents, note it
  if(incidents.length>10){
    showToast('Note: Only first 10 of '+incidents.length+' incidents shown on single 300 form page.','info');
  }

  // Flatten form so filled values render as visible text
  form.flatten();
  // Extract only 300 pages (pages 7-8 = index 6-7)
  const newDoc=await PDFDocument.create();
  const pages=await newDoc.copyPages(pdfDoc,[6,7]);
  pages.forEach(p=>newDoc.addPage(p));
  const outBytes=await newDoc.save();
  downloadBlob(outBytes,'OSHA-300-Log-'+year+'.pdf');
  showToast('OSHA 300 Log downloaded!','success');
}

// OSHA 300A â€” Summary of Work-Related Injuries and Illnesses
async function downloadOSHA300A(){
  const year=document.getElementById('oshaYear').value;
  if(!year){showToast('Select a year','error');return;}
  const btn=document.getElementById('btn300a');
  btn.disabled=true;btn.textContent='Generating...';
  try{
    const startDate=year+'-01-01';
    const endDate=year+'-12-31';
    const{data,error}=await sb.from('incidents').select('*')
      .gte('incident_date',startDate).lte('incident_date',endDate);
    if(error)throw error;
    const co=await loadCompanySettings();
    await generateOSHA300APDF(data||[],year,co);
  }catch(e){
    showToast('Error: '+e.message,'error');
  }
  btn.disabled=false;btn.textContent='Download 300A Summary';
}

async function generateOSHA300APDF(incidents,year,co){
  const pdfBytes=await loadPdfBytes();
  const{PDFDocument}=PDFLib;
  const pdfDoc=await PDFDocument.load(pdfBytes);
  const form=pdfDoc.getForm();

  // Company info
  setPdfField(form,'Summary of Injury/Illness Establishment Name',co.establishment_name||'');
  setPdfField(form,'Summary of Injury/Illness Street',co.street||'');
  setPdfField(form,'Summary of Injury/Illness City',co.city||'');
  setPdfField(form,'Summary of Injury/Illness State',co.state||'');
  setPdfField(form,'Summary of Injury/Illness Zip',co.zip||'');
  setPdfField(form,'Summary of Injury/Illness Industry description',co.industry_description||'');
  setPdfField(form,'Summary of Injury/Illness NAICS',co.naics_code||'');
  setPdfField(form,'Summary of Injury/Illness Phone',co.phone||'');
  setPdfField(form,'Summary of Injury/Illness Year',String(year));
  setPdfField(form,'Summary of Injury/Illness Annual avg num of employees',String(co.avg_employees||''));
  setPdfField(form,'Summary of Injury/Illness Total hours worked by all employees last year',String(co.total_hours_worked||''));

  // Calculate totals from incidents
  let deaths=0,daysAway=0,jobTransfer=0,otherRec=0;
  let totalDaysAway=0,totalDaysRestrict=0;
  let injuries=0,skinDis=0,respCond=0,poison=0,hearLoss=0,allOther=0;

  incidents.forEach(inc=>{
    const oc=inc.osha_outcome;
    if(oc==='death')deaths++;
    else if(oc==='days_away')daysAway++;
    else if(oc==='job_transfer_restriction')jobTransfer++;
    else if(oc==='other_recordable')otherRec++;

    totalDaysAway+=(inc.days_away_from_work||0);
    totalDaysRestrict+=(inc.days_restricted_duty||0);

    if(inc.injury_or_illness==='injury')injuries++;
    else if(inc.injury_or_illness==='illness'){
      const it=inc.illness_type||'';
      if(it.includes('Skin'))skinDis++;
      else if(it.includes('Respiratory'))respCond++;
      else if(it.includes('Poison'))poison++;
      else if(it.includes('Hear'))hearLoss++;
      else allOther++;
    }
  });

  const totalCases=deaths+daysAway+jobTransfer+otherRec;

  // 300A Summary fields
  setPdfField(form,'Total Deaths Summary',String(deaths));
  setPdfField(form,'Days away from work Summary',String(daysAway));
  setPdfField(form,'Job transfer or restriction Summary',String(jobTransfer));
  setPdfField(form,'Other recordable cases Summary',String(otherRec));
  setPdfField(form,'Injury Summary',String(injuries));
  setPdfField(form,'Skin Disorder Summary',String(skinDis));
  setPdfField(form,'Respiratory Cond Summary',String(respCond));
  setPdfField(form,'Poisoning Summary',String(poison));
  setPdfField(form,'Hearing Loss Summary',String(hearLoss));
  setPdfField(form,'All other Summary',String(allOther));
  setPdfField(form,'Number of days injured or ill away from work Summary',String(totalDaysAway));
  setPdfField(form,'On job transfer or restriction Summary',String(totalDaysRestrict));

  // Incidence rates (if hours data available)
  if(co.total_hours_worked&&co.total_hours_worked>0){
    const hrs=co.total_hours_worked;
    const tcr=((totalCases*200000)/hrs).toFixed(1);
    const dart=(((daysAway+jobTransfer)*200000)/hrs).toFixed(1);
    setPdfField(form,'Total recordable case rate',tcr);
    setPdfField(form,'DART incidence rate',dart);
  }

  // Sign date
  const today=new Date();
  setPdfField(form,'Summary of Injury/Illness Date',(today.getMonth()+1)+'/'+today.getDate()+'/'+today.getFullYear());

  // Flatten form so filled values render as visible text
  form.flatten();
  // Extract only 300A pages (pages 8-9 = index 7-8)
  const newDoc=await PDFDocument.create();
  const pages=await newDoc.copyPages(pdfDoc,[7,8]);
  pages.forEach(p=>newDoc.addPage(p));
  const outBytes=await newDoc.save();
  downloadBlob(outBytes,'OSHA-300A-Summary-'+year+'.pdf');
  showToast('OSHA 300A Summary downloaded!','success');
}

function downloadBlob(bytes,filename){
  const blob=new Blob([bytes],{type:'application/pdf'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
