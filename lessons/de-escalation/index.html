<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo.png?v=2">
    <title>Module 21: De-Escalation Techniques - TheSafetyVerse</title>
    <style>body { visibility: hidden; opacity: 0; transition: opacity 0.3s; }</style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../auth/supabase-config.js"></script>
    <script src="../../auth/auth-guard.js"></script>
    <link rel="stylesheet" href="../../shared/header.css">
    <script src="../../shared/header.js"></script>
    <style>
        /* ═══════════════════════════════════════════
           CSS VARIABLES & RESET
           ═══════════════════════════════════════════ */
        :root {
            --primary: #FFD700;
            --primary-dark: #E6C200;
            --secondary: #FF8C00;
            --secondary-dark: #E67A00;
            --bg-clay: #F5E6D3;
            --bg-clay-dark: #E8D5C0;
            --bg-clay-light: #FAF0E6;
            --text-dark: #333333;
            --text-medium: #555555;
            --text-light: #777777;
            --accent-black: #1A1A1A;
            --white: #FFFFFF;
            --success: #4CAF50;
            --success-dark: #388E3C;
            --error: #E53935;
            --error-dark: #C62828;
            --info: #2196F3;
            --warning: #FF9800;
            --deesc-blue: #1565C0;
            --shadow-soft: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-medium: 0 6px 25px rgba(0,0,0,0.15);
            --shadow-hard: 0 8px 30px rgba(0,0,0,0.2);
            --shadow-clay: 4px 4px 0px rgba(0,0,0,0.15), inset 0 2px 4px rgba(255,255,255,0.3);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-heading: 'Segoe UI', 'Arial Black', sans-serif;
            --font-body: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-clay);
            color: var(--text-dark);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }
        /* Clay texture */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(139,90,43,0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139,90,43,0.02) 0%, transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(139,90,43,0.03) 0%, transparent 50%);
        }
        /* ═══════════════════════════════════════════
           PROGRESS BAR
           ═══════════════════════════════════════════ */
        .progress-bar {
            background: var(--accent-black);
            border-bottom: 1px solid rgba(255,215,0,0.15);
            flex-shrink: 0;
            z-index: 99;
        }
        .progress-bar-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 8px 24px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .progress-label {
            font-size: 12px; font-weight: 700;
            color: rgba(255,255,255,0.5);
            white-space: nowrap;
            min-width: 90px;
        }
        .progress-track {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.08);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        .progress-pct {
            font-size: 12px; font-weight: 700;
            color: var(--primary);
            min-width: 40px;
            text-align: right;
        }
        /* ═══════════════════════════════════════════
           MAIN CONTENT AREA
           ═══════════════════════════════════════════ */
        .content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 24px 100px;
        }
        /* ═══════════════════════════════════════════
           SLIDES
           ═══════════════════════════════════════════ */
        .slide {
            display: none;
            animation: slideIn 0.3s ease;
        }
        .slide.active { display: block; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Intro Card (Slide 1) */
        .intro-card {
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
            border-radius: var(--radius-xl);
            padding: 60px 50px;
            box-shadow: var(--shadow-hard);
            color: var(--white);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .intro-card::before {
            content: '';
            position: absolute;
            top: -100px; right: -100px;
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .intro-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        .intro-title {
            font-family: var(--font-heading);
            font-size: 48px; font-weight: 900;
            margin-bottom: 12px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
        }
        .intro-subtitle {
            font-size: 20px;
            margin-bottom: 30px;
            opacity: 0.95;
        }
        .intro-meta {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        .intro-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px; font-weight: 600;
        }
        .intro-meta-item span:first-child {
            font-size: 20px;
        }
        /* Content Card */
        .content-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 50px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 30px;
        }
        .slide-header {
            margin-bottom: 35px;
        }
        .slide-number {
            font-size: 11px; font-weight: 800;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
        }
        .slide-title {
            font-family: var(--font-heading);
            font-size: 36px; font-weight: 900;
            color: var(--text-dark);
            margin-bottom: 8px;
            line-height: 1.2;
        }
        .slide-subtitle {
            font-size: 17px;
            color: var(--text-medium);
        }
        .slide-content {
            font-size: 17px;
            line-height: 1.8;
            color: var(--text-dark);
        }
        .slide-content p {
            margin-bottom: 20px;
        }
        .slide-content strong {
            color: var(--deesc-blue);
            font-weight: 700;
        }
        /* Katie Message */
        .katie-message {
            display: flex;
            align-items: flex-start;
            gap: 18px;
            background: linear-gradient(135deg, #FFFDE7 0%, #FFF9C4 100%);
            border-left: 5px solid var(--primary);
            padding: 24px;
            border-radius: var(--radius-md);
            margin-bottom: 35px;
            box-shadow: 0 3px 12px rgba(255,215,0,0.15);
        }
        .katie-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            object-position: center 20%;
            border: 4px solid var(--primary);
            flex-shrink: 0;
            box-shadow: var(--shadow-soft);
        }
        .katie-bubble {
            flex: 1;
        }
        .katie-name {
            font-weight: 800;
            color: var(--secondary);
            margin-bottom: 8px;
            font-size: 15px;
        }
        .katie-text {
            font-size: 16px;
            color: var(--text-dark);
            line-height: 1.7;
        }
        /* Info Boxes */
        .info-box {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-left: 5px solid var(--info);
            padding: 22px 24px;
            border-radius: var(--radius-md);
            margin: 28px 0;
        }
        .info-box.warning {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            border-left-color: var(--warning);
        }
        .info-box.danger {
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            border-left-color: var(--error);
        }
        .info-box.success {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-left-color: var(--success);
        }
        .info-box-title {
            font-weight: 800;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }
        .info-box-content {
            font-size: 15px;
            line-height: 1.7;
        }
        .info-box-content ul, .info-box-content ol {
            margin-top: 10px;
            padding-left: 20px;
        }
        .info-box-content li {
            margin-bottom: 6px;
        }
        /* Lists */
        .content-list {
            list-style: none;
            margin: 28px 0;
        }
        .content-list li {
            padding: 14px 0 14px 36px;
            position: relative;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 16px;
        }
        .content-list li:last-child {
            border-bottom: none;
        }
        .content-list li::before {
            content: '\1F6E1';
            position: absolute;
            left: 8px;
            font-size: 18px;
        }
        /* Principle Grid */
        .principle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 28px 0;
        }
        .principle-card {
            background: var(--bg-clay-light);
            border: 3px solid var(--deesc-blue);
            border-radius: var(--radius-md);
            padding: 24px;
            text-align: center;
            transition: var(--transition);
        }
        .principle-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        .principle-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        .principle-title {
            font-weight: 900;
            font-size: 18px;
            color: var(--deesc-blue);
            margin-bottom: 10px;
            font-family: var(--font-heading);
        }
        .principle-desc {
            font-size: 15px;
            color: var(--text-dark);
            line-height: 1.6;
        }
        /* Steps Grid */
        .steps-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin: 28px 0;
        }
        .step-card {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            background: var(--bg-clay-light);
            padding: 20px;
            border-radius: var(--radius-md);
            border-left: 5px solid var(--deesc-blue);
        }
        .step-number {
            background: var(--deesc-blue);
            color: var(--white);
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 18px;
            flex-shrink: 0;
        }
        .step-content h5 {
            font-weight: 800;
            margin-bottom: 6px;
            color: var(--text-dark);
            font-size: 16px;
        }
        .step-content p {
            font-size: 14px;
            color: var(--text-medium);
            line-height: 1.6;
            margin: 0;
        }
        /* LEAP Grid */
        .leap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 28px 0;
        }
        .leap-card {
            background: var(--bg-clay-light);
            border: 3px solid var(--deesc-blue);
            border-radius: var(--radius-md);
            padding: 26px;
            transition: var(--transition);
        }
        .leap-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        .leap-letter {
            font-size: 40px;
            font-weight: 900;
            color: var(--deesc-blue);
            font-family: var(--font-heading);
            margin-bottom: 4px;
        }
        .leap-title {
            font-weight: 800;
            font-size: 18px;
            color: var(--deesc-blue);
            margin-bottom: 10px;
            font-family: var(--font-heading);
        }
        .leap-desc {
            font-size: 15px;
            color: var(--text-dark);
            line-height: 1.6;
        }
        .leap-example {
            margin-top: 10px;
            font-size: 14px;
            font-style: italic;
            color: var(--text-medium);
            background: rgba(21,101,192,0.06);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
        }
        /* Scenario Cards */
        .scenario-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 28px 0;
        }
        .scenario-card {
            background: var(--bg-clay-light);
            border: 3px solid var(--deesc-blue);
            border-radius: var(--radius-md);
            padding: 24px;
        }
        .scenario-title {
            font-weight: 900;
            font-size: 18px;
            color: var(--deesc-blue);
            margin-bottom: 12px;
            font-family: var(--font-heading);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .scenario-desc {
            font-size: 15px;
            color: var(--text-dark);
            line-height: 1.7;
        }
        /* Warning Cards */
        .warning-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
            margin: 28px 0;
        }
        .warning-card {
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            border-left: 5px solid var(--error);
            border-radius: var(--radius-md);
            padding: 20px;
        }
        .warning-title {
            font-weight: 800;
            font-size: 16px;
            color: var(--error);
            margin-bottom: 8px;
        }
        .warning-desc {
            font-size: 14px;
            color: var(--text-dark);
            line-height: 1.6;
        }
        /* Body Language Grid */
        .body-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin: 28px 0;
        }
        .body-card {
            background: var(--bg-clay-light);
            border: 3px solid var(--deesc-blue);
            border-radius: var(--radius-md);
            padding: 24px;
            text-align: center;
            transition: var(--transition);
        }
        .body-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        .body-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        .body-title {
            font-weight: 900;
            font-size: 17px;
            color: var(--deesc-blue);
            margin-bottom: 10px;
            font-family: var(--font-heading);
        }
        .body-desc {
            font-size: 14px;
            color: var(--text-dark);
            line-height: 1.6;
        }
        /* After Incident Steps Grid */
        .after-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin: 28px 0;
        }
        .after-card {
            background: var(--bg-clay-light);
            border: 3px solid var(--success);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
        }
        .after-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }
        .after-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .after-title {
            font-weight: 800;
            font-size: 15px;
            color: var(--success-dark);
            margin-bottom: 8px;
            font-family: var(--font-heading);
        }
        .after-desc {
            font-size: 13px;
            color: var(--text-dark);
            line-height: 1.6;
        }
        /* ═══════════════════════════════════════════
           QUIZ STYLES
           ═══════════════════════════════════════════ */
        .quiz-question {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 28px;
            line-height: 1.5;
        }
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-bottom: 24px;
        }
        .quiz-option {
            background: var(--bg-clay-light);
            border: 3px solid var(--bg-clay-dark);
            padding: 18px 24px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            font-weight: 600;
            position: relative;
        }
        .quiz-option:hover:not(.disabled) {
            background: var(--bg-clay);
            border-color: var(--primary);
            transform: translateX(6px);
        }
        .quiz-option.selected {
            background: var(--primary);
            border-color: var(--primary-dark);
            color: var(--accent-black);
        }
        .quiz-option.correct {
            background: var(--success);
            border-color: var(--success-dark);
            color: var(--white);
        }
        .quiz-option.incorrect {
            background: var(--error);
            border-color: var(--error-dark);
            color: var(--white);
        }
        .quiz-option.disabled {
            cursor: default;
        }
        .quiz-feedback {
            display: none;
            padding: 18px 22px;
            border-radius: var(--radius-md);
            font-size: 16px;
            line-height: 1.7;
            margin-top: 20px;
        }
        .quiz-feedback.show {
            display: block;
        }
        .quiz-feedback.correct-fb {
            background: #E8F5E9;
            color: #2E7D32;
            border-left: 5px solid var(--success);
        }
        .quiz-feedback.incorrect-fb {
            background: #FFEBEE;
            color: #C62828;
            border-left: 5px solid var(--error);
        }
        /* Quiz Buttons */
        .quiz-btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        /* Results Screen */
        .results-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 60px 50px;
            box-shadow: var(--shadow-hard);
            text-align: center;
        }
        .results-icon {
            font-size: 100px;
            margin-bottom: 24px;
            animation: scaleIn 0.6s ease;
        }
        @keyframes scaleIn {
            from { transform: scale(0) rotate(-180deg); }
            to { transform: scale(1) rotate(0); }
        }
        .results-score {
            font-family: var(--font-heading);
            font-size: 72px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        .results-title {
            font-family: var(--font-heading);
            font-size: 42px;
            font-weight: 900;
            color: var(--text-dark);
            margin-bottom: 16px;
        }
        .results-message {
            font-size: 19px;
            color: var(--text-medium);
            margin-bottom: 36px;
            line-height: 1.7;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .results-katie {
            background: linear-gradient(135deg, #FFFDE7 0%, #FFF9C4 100%);
            border-left: 5px solid var(--primary);
            padding: 20px 24px;
            border-radius: var(--radius-md);
            font-size: 17px;
            font-style: italic;
            color: var(--text-dark);
            margin-bottom: 36px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .results-buttons {
            display: flex;
            justify-content: center;
            gap: 14px;
            flex-wrap: wrap;
        }
        /* ═══════════════════════════════════════════
           BUTTONS
           ═══════════════════════════════════════════ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-heading);
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            box-shadow: var(--shadow-clay);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-gold {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--accent-black);
        }
        .btn-gold:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hard);
        }
        .btn-success {
            background: var(--success);
            color: var(--white);
        }
        .btn-success:hover:not(:disabled) {
            background: var(--success-dark);
            transform: translateY(-3px);
            box-shadow: var(--shadow-hard);
        }
        .btn-outline {
            background: var(--white);
            color: var(--text-dark);
            border: 2px solid var(--bg-clay-dark);
        }
        .btn-outline:hover:not(:disabled) {
            background: var(--bg-clay-light);
            border-color: var(--primary);
        }
        /* ═══════════════════════════════════════════
           NAVIGATION
           ═══════════════════════════════════════════ */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(26,26,26,0.97) 0%, rgba(0,0,0,0.98) 100%);
            border-top: 3px solid var(--primary);
            padding: 16px 24px;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        .nav-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: var(--radius-sm);
            font-family: var(--font-heading);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255,255,255,0.08);
            color: var(--white);
            text-decoration: none;
        }
        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.15);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .nav-btn.nav-next {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--accent-black);
            border-color: transparent;
        }
        .nav-btn.nav-next:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,215,0,0.4);
        }
        .slide-indicator {
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-weight: 600;
        }
        /* ═══════════════════════════════════════════
           RESPONSIVE
           ═══════════════════════════════════════════ */
        @media (max-width: 768px) {
            .container { padding: 30px 20px 100px; }
            .content-card { padding: 32px 24px; }
            .intro-card { padding: 40px 30px; }
            .intro-title { font-size: 36px; }
            .slide-title { font-size: 28px; }
            .principle-grid { grid-template-columns: 1fr; }
            .body-grid { grid-template-columns: 1fr; }
            .leap-grid { grid-template-columns: 1fr; }
            .warning-grid { grid-template-columns: 1fr; }
            .after-grid { grid-template-columns: 1fr; }
            .nav-inner { flex-direction: column; gap: 12px; }
            .nav-btn { width: 100%; justify-content: center; }
        }
        @media (max-width: 480px) {
            .intro-meta { flex-direction: column; gap: 16px; }
            .katie-message { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <!-- Header injected by shared/header.js -->
    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-bar-inner">
            <span class="progress-label" id="progressLabel">Slide 1 of 16</span>
            <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span class="progress-pct" id="progressPct">0%</span>
        </div>
    </div>
    <!-- Main Content -->
    <div class="content-wrapper">
        <div class="container">
            <!-- Slide 1: Intro -->
            <div class="slide active" data-slide="1">
                <div class="intro-card">
                    <div class="intro-icon">&#x1F6E1;</div>
                    <h1 class="intro-title">De-Escalation Techniques</h1>
                    <p class="intro-subtitle">Stay Calm. Stay Safe. Stay in Control.</p>
                    <div class="intro-meta">
                        <div class="intro-meta-item">
                            <span>&#x23F1;</span>
                            <span>20 minutes</span>
                        </div>
                        <div class="intro-meta-item">
                            <span>&#x1F4DA;</span>
                            <span>Security &amp; Threat Response Path</span>
                        </div>
                        <div class="intro-meta-item">
                            <span>&#x2713;</span>
                            <span>OSHA/Workplace Safety</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 2: Katie Intro + Learning Objectives -->
            <div class="slide" data-slide="2">
                <div class="content-card">
                    <div class="katie-message">
                        <img src="katie.png" alt="Katie" class="katie-avatar">
                        <div class="katie-bubble">
                            <div class="katie-name">Katie, Your Safety Guide</div>
                            <div class="katie-text">
                                Welcome! De-escalation is arguably the most important skill for anyone working in security, healthcare, customer service, or any role where you interact with the public. Studies show that skilled verbal intervention prevents over 80% of potentially violent encounters from ever becoming physical. The ability to calm a tense situation protects you, the agitated individual, and everyone nearby. Let's learn how to take control of conflict before it controls you!
                            </div>
                        </div>
                    </div>
                    <div class="slide-header">
                        <div class="slide-number">Slide 2 of 12</div>
                        <h2 class="slide-title">Why De-Escalation Matters</h2>
                    </div>
                    <div class="slide-content">
                        <p><strong>De-escalation is the use of verbal and non-verbal communication strategies to reduce the intensity of a potentially dangerous situation before it becomes physical.</strong></p>

                        <div class="info-box danger">
                            <div class="info-box-title">&#x1F6A8; The Stakes Are Real</div>
                            <div class="info-box-content">
                                According to OSHA and workplace safety research:
                                <ul>
                                    <li><strong>Nearly 2 million U.S. workers</strong> experience workplace violence each year</li>
                                    <li><strong>Over 80% of violent incidents</strong> can be prevented through effective verbal intervention</li>
                                    <li><strong>Healthcare workers</strong> are 5 times more likely to experience assault than workers in other industries</li>
                                    <li><strong>Security personnel, retail staff, and social workers</strong> face elevated risk daily</li>
                                    <li><strong>Most situations escalate gradually</strong>&mdash;there is almost always a window to intervene verbally</li>
                                </ul>
                            </div>
                        </div>

                        <div class="info-box">
                            <div class="info-box-title">&#x1F4A1; What You Will Learn</div>
                            <div class="info-box-content">
                                <strong>By the end of this module, you will be able to:</strong>
                                <ul>
                                    <li>Understand the psychology of escalation and why people become agitated</li>
                                    <li>Master proven verbal de-escalation techniques used by professionals</li>
                                    <li>Read body language cues and use your own nonverbal signals effectively</li>
                                    <li>Apply the LEAP method to resolve conflicts collaboratively</li>
                                    <li>Recognize when de-escalation is no longer working and when to disengage safely</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 3: The Psychology of Escalation -->
            <div class="slide" data-slide="3">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 3 of 12</div>
                        <h2 class="slide-title">The Psychology of Escalation</h2>
                        <p class="slide-subtitle">Understanding why people lose control</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>Before you can de-escalate someone, you need to understand what is happening inside their brain.</strong> When a person feels threatened, frustrated, or cornered, their body activates the fight-or-flight response&mdash;a survival mechanism that overrides rational thinking.</p>

                        <div class="info-box warning">
                            <div class="info-box-title">&#x1F9E0; Fight-or-Flight Response</div>
                            <div class="info-box-content">
                                When adrenaline kicks in, the brain shifts resources away from the prefrontal cortex (rational thinking) toward the amygdala (emotional reactions). This means:
                                <ul>
                                    <li><strong>Hearing narrows</strong>&mdash;they may not process everything you say</li>
                                    <li><strong>Vision tunnels</strong>&mdash;they focus on perceived threats</li>
                                    <li><strong>Heart rate spikes</strong>&mdash;physical agitation increases</li>
                                    <li><strong>Rational thought decreases</strong>&mdash;logic and reasoning become less effective</li>
                                    <li><strong>Pain tolerance increases</strong>&mdash;physical intervention becomes riskier</li>
                                </ul>
                            </div>
                        </div>

                        <div class="steps-grid">
                            <div class="step-card">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>Trigger</h5>
                                    <p>Something sets the person off&mdash;a perceived insult, unmet need, frustration, fear, or feeling disrespected. The trigger may seem minor to you but feel major to them.</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>Escalation</h5>
                                    <p>Emotional intensity rises. Voice gets louder, body language becomes aggressive, rational thinking decreases. This is the critical window for de-escalation&mdash;intervention here is most effective.</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>Crisis</h5>
                                    <p>Peak emotional and physical agitation. The person is at their most irrational and potentially dangerous. Verbal de-escalation is extremely difficult at this stage.</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>Recovery</h5>
                                    <p>Intensity begins to decrease. The person may start to calm down, but remains emotionally volatile. Handle carefully&mdash;a wrong word can re-escalate them.</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">5</div>
                                <div class="step-content">
                                    <h5>Post-Crisis</h5>
                                    <p>The person returns to baseline. They may feel embarrassment, exhaustion, or remorse. This is the time for follow-up, documentation, and support.</p>
                                </div>
                            </div>
                        </div>

                        <div class="info-box danger">
                            <div class="info-box-title">&#x1F6A8; Critical Insight</div>
                            <div class="info-box-content">
                                <strong>The earlier you intervene in the escalation cycle, the more likely you are to succeed.</strong> Once a person reaches the crisis stage, verbal de-escalation becomes extremely difficult. Your goal is to recognize escalation early and act during the escalation phase&mdash;before crisis hits.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 4: Core De-Escalation Principles -->
            <div class="slide" data-slide="4">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 4 of 12</div>
                        <h2 class="slide-title">Core De-Escalation Principles</h2>
                        <p class="slide-subtitle">The four pillars of calming a crisis</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>Every successful de-escalation is built on four foundational principles.</strong> Master these and you have the framework to handle nearly any volatile encounter.</p>

                        <div class="principle-grid">
                            <div class="principle-card">
                                <div class="principle-icon">&#x1F9D8;</div>
                                <div class="principle-title">Stay Calm</div>
                                <div class="principle-desc">
                                    Control YOUR emotions first. You cannot calm someone else if you are agitated. Take slow breaths, lower your heart rate, and project calm confidence. Your composure is contagious&mdash;if you stay steady, they are more likely to follow.
                                </div>
                            </div>
                            <div class="principle-card">
                                <div class="principle-icon">&#x1F442;</div>
                                <div class="principle-title">Listen Actively</div>
                                <div class="principle-desc">
                                    Hear what they are really saying. Most agitated people feel unheard or disrespected. Give them your full attention, nod, and paraphrase what they say. When someone feels heard, their emotional temperature drops significantly.
                                </div>
                            </div>
                            <div class="principle-card">
                                <div class="principle-icon">&#x1F49B;</div>
                                <div class="principle-title">Show Empathy</div>
                                <div class="principle-desc">
                                    Acknowledge their feelings without judgment. Say "I can see you're frustrated" or "That sounds really difficult." You do not have to agree with their position to validate their emotions. Empathy builds trust and lowers defenses.
                                </div>
                            </div>
                            <div class="principle-card">
                                <div class="principle-icon">&#x1F6D1;</div>
                                <div class="principle-title">Set Boundaries</div>
                                <div class="principle-desc">
                                    Be firm but respectful. De-escalation is not about giving in to every demand. Set clear limits: "I want to help you, but I need you to lower your voice so we can talk." Boundaries show you are in control without being threatening.
                                </div>
                            </div>
                        </div>

                        <div class="info-box success">
                            <div class="info-box-title">&#x2713; Remember This Formula</div>
                            <div class="info-box-content">
                                <strong>Calm + Listening + Empathy + Boundaries = De-Escalation Success</strong><br><br>
                                These four principles work together. If you stay calm but do not listen, they will feel dismissed. If you listen but set no boundaries, the behavior may continue. Use all four together for maximum effectiveness.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 5: Verbal De-Escalation Techniques -->
            <div class="slide" data-slide="5">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 5 of 12</div>
                        <h2 class="slide-title">Verbal De-Escalation Techniques</h2>
                        <p class="slide-subtitle">What to say and how to say it</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>Your voice is your most powerful de-escalation tool.</strong> How you speak matters just as much as what you say.</p>

                        <div class="steps-grid">
                            <div class="step-card">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>Tone of Voice: Low, Slow, and Steady</h5>
                                    <p>Keep your voice low-pitched and speak slowly. A calm, measured tone signals safety and authority. If they raise their volume, lower yours. People subconsciously mirror the emotional tone around them.</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>Avoid Trigger Words</h5>
                                    <p>Never say "calm down," "relax," "you need to," or "you're overreacting." These phrases feel dismissive and condescending. Instead, say: "Help me understand what happened" or "I can see this is important to you."</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>Ask Open-Ended Questions</h5>
                                    <p>Questions like "What happened?" or "What can I do to help?" invite dialogue and redirect the person from raw emotion toward problem-solving. Avoid "why" questions ("Why are you upset?")&mdash;they can sound accusatory.</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>Paraphrasing</h5>
                                    <p>Repeat back what you heard in your own words: "So what I'm hearing is that you've been waiting for two hours and nobody has helped you. Is that right?" This proves you are listening and helps clarify the real issue.</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">5</div>
                                <div class="step-content">
                                    <h5>The "Broken Record" Technique</h5>
                                    <p>When someone is making unreasonable demands, calmly and respectfully repeat your position without escalating: "I understand you're frustrated. What I can do is [specific action]." Repeat as needed without raising your voice or changing your message.</p>
                                </div>
                            </div>
                            <div class="step-card">
                                <div class="step-number">6</div>
                                <div class="step-content">
                                    <h5>Offer Choices Instead of Demands</h5>
                                    <p>Giving options restores a person's sense of control: "Would you like to step outside to talk, or would you prefer we sit down here?" Choice feels empowering; demands feel threatening.</p>
                                </div>
                            </div>
                        </div>

                        <div class="info-box warning">
                            <div class="info-box-title">&#x26A0; Words That Escalate vs. Words That De-Escalate</div>
                            <div class="info-box-content">
                                <strong>AVOID:</strong> "Calm down" / "You need to stop" / "That's not my problem" / "There's nothing I can do" / "You're being unreasonable"<br><br>
                                <strong>USE INSTEAD:</strong> "I hear you" / "Help me understand" / "Let's figure this out together" / "Here's what I can do" / "I can see this matters to you"
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 6: Body Language & Nonverbal Communication -->
            <div class="slide" data-slide="6">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 6 of 12</div>
                        <h2 class="slide-title">Body Language &amp; Nonverbal Communication</h2>
                        <p class="slide-subtitle">Your body speaks louder than your words</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>Research shows that over 55% of communication is nonverbal.</strong> During a de-escalation encounter, your body language can either calm or inflame the situation&mdash;often more powerfully than anything you say.</p>

                        <div class="body-grid">
                            <div class="body-card">
                                <div class="body-icon">&#x1F4CF;</div>
                                <div class="body-title">Reactive Gap</div>
                                <div class="body-desc">
                                    Maintain at least arm's length distance (3&ndash;6 feet). This protects your safety and gives the person space. Closing distance feels threatening; keeping distance shows respect and keeps you safe.
                                </div>
                            </div>
                            <div class="body-card">
                                <div class="body-icon">&#x1F9CD;</div>
                                <div class="body-title">Open Stance</div>
                                <div class="body-desc">
                                    Keep your arms uncrossed and at your sides or slightly in front with palms visible. Crossed arms signal defensiveness or aggression. An open posture communicates "I'm not a threat."
                                </div>
                            </div>
                            <div class="body-card">
                                <div class="body-icon">&#x1F440;</div>
                                <div class="body-title">Appropriate Eye Contact</div>
                                <div class="body-desc">
                                    Maintain natural eye contact without staring. Steady eye contact shows you are engaged and listening. Prolonged staring can feel confrontational and aggressive.
                                </div>
                            </div>
                            <div class="body-card">
                                <div class="body-icon">&#x270B;</div>
                                <div class="body-title">Hands Visible &amp; Open</div>
                                <div class="body-desc">
                                    Keep your hands where they can be seen at all times, palms open and facing outward. Hidden hands create suspicion. Open palms are a universal signal of non-aggression.
                                </div>
                            </div>
                            <div class="body-card">
                                <div class="body-icon">&#x1F4D0;</div>
                                <div class="body-title">45-Degree Angle</div>
                                <div class="body-desc">
                                    Position yourself at an angle rather than directly face-to-face. Standing squarely in front of someone feels confrontational. An angled stance is less threatening and gives you a quicker exit route.
                                </div>
                            </div>
                            <div class="body-card">
                                <div class="body-icon">&#x1F6AB;</div>
                                <div class="body-title">No Pointing or Finger-Wagging</div>
                                <div class="body-desc">
                                    Never point your finger at an agitated person. Pointing is perceived as aggressive and condescending. Use open-hand gestures instead if you need to direct attention.
                                </div>
                            </div>
                        </div>

                        <div class="info-box danger">
                            <div class="info-box-title">&#x1F6A8; Reading Their Body Language</div>
                            <div class="info-box-content">
                                <strong>Watch for these escalation warning signs:</strong><br>
                                &bull; Clenched fists or jaw<br>
                                &bull; Pacing or inability to stand still<br>
                                &bull; Invading your personal space<br>
                                &bull; Rapid breathing or flushed face<br>
                                &bull; "Target glance"&mdash;looking at a potential weapon or your vulnerable areas<br>
                                &bull; Removing jacket or accessories (preparing for physical confrontation)<br>
                                &bull; Thousand-yard stare (emotional shutdown before potential explosion)<br><br>
                                <strong>If you see multiple warning signs, increase your distance immediately and prepare to disengage.</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 7: The LEAP Method -->
            <div class="slide" data-slide="7">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 7 of 12</div>
                        <h2 class="slide-title">The LEAP Method</h2>
                        <p class="slide-subtitle">A proven framework for conflict resolution</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>The LEAP method provides a step-by-step framework for guiding someone from agitation to cooperation.</strong> Each step builds on the previous one to create trust and move toward resolution.</p>

                        <div class="leap-grid">
                            <div class="leap-card">
                                <div class="leap-letter">L</div>
                                <div class="leap-title">Listen</div>
                                <div class="leap-desc">
                                    Hear them out fully without interrupting. Let them express their frustration, anger, or fear. Resist the urge to jump in with solutions. Sometimes people just need to feel heard before they can calm down.
                                </div>
                                <div class="leap-example">
                                    Example: "Take your time. I'm listening. Tell me what happened."
                                </div>
                            </div>
                            <div class="leap-card">
                                <div class="leap-letter">E</div>
                                <div class="leap-title">Empathize</div>
                                <div class="leap-desc">
                                    Acknowledge their feelings without judgment. Show that you understand why they feel the way they do, even if you do not agree with their actions. Empathy is not agreement&mdash;it is understanding.
                                </div>
                                <div class="leap-example">
                                    Example: "I can see you're really frustrated. If I were in your situation, I'd probably feel the same way."
                                </div>
                            </div>
                            <div class="leap-card">
                                <div class="leap-letter">A</div>
                                <div class="leap-title">Agree</div>
                                <div class="leap-desc">
                                    Find common ground&mdash;any point where your goals align. This does not mean giving in to unreasonable demands. It means finding something you can both agree on to build a bridge.
                                </div>
                                <div class="leap-example">
                                    Example: "We both want this resolved. I agree that you deserve to be treated fairly. Let's work on that."
                                </div>
                            </div>
                            <div class="leap-card">
                                <div class="leap-letter">P</div>
                                <div class="leap-title">Partner</div>
                                <div class="leap-desc">
                                    Work together toward a solution. Shift from adversarial ("me vs. you") to collaborative ("us vs. the problem"). Offer options, involve them in the decision, and focus on what can be done.
                                </div>
                                <div class="leap-example">
                                    Example: "Let's figure out together what the best next step is. Would you prefer option A or option B?"
                                </div>
                            </div>
                        </div>

                        <div class="info-box success">
                            <div class="info-box-title">&#x2713; Why LEAP Works</div>
                            <div class="info-box-content">
                                The LEAP method works because it addresses the psychological needs of an agitated person in sequence:<br>
                                &bull; <strong>Listen</strong> = "I am heard"<br>
                                &bull; <strong>Empathize</strong> = "I am understood"<br>
                                &bull; <strong>Agree</strong> = "We are on the same side"<br>
                                &bull; <strong>Partner</strong> = "We can solve this together"<br><br>
                                Each step reduces emotional intensity and moves the person closer to rational thinking and resolution.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 8: Scenario Responses -->
            <div class="slide" data-slide="8">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 8 of 12</div>
                        <h2 class="slide-title">Scenario Responses</h2>
                        <p class="slide-subtitle">Applying techniques to real situations</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>Different situations require adapted approaches.</strong> Here are three common scenarios and how to handle each one effectively.</p>

                        <div class="scenario-grid">
                            <div class="scenario-card">
                                <div class="scenario-title">&#x1F621; Scenario 1: Angry / Aggressive Individual</div>
                                <div class="scenario-desc">
                                    <strong>Situation:</strong> A person is yelling, making threats, and displaying aggressive body language.<br><br>
                                    <strong>Your Approach:</strong><br>
                                    &bull; Approach calmly and from an angle, not head-on. Maintain reactive gap.<br>
                                    &bull; Use their name if you know it&mdash;personalization reduces aggression.<br>
                                    &bull; Validate their frustration: "I can see you're upset, and I want to help."<br>
                                    &bull; Avoid arguing, correcting, or challenging them.<br>
                                    &bull; Offer concrete solutions: "Here's what I can do right now to address this."<br>
                                    &bull; Set limits if needed: "I want to help, but I need you to lower your voice so we can talk."
                                </div>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-title">&#x1F974; Scenario 2: Intoxicated / Impaired Person</div>
                                <div class="scenario-desc">
                                    <strong>Situation:</strong> A person under the influence of alcohol or drugs is behaving erratically and will not follow directions.<br><br>
                                    <strong>Your Approach:</strong><br>
                                    &bull; Use simple, short sentences&mdash;impaired individuals cannot process complex language.<br>
                                    &bull; Give clear, direct instructions one at a time: "Please sit down here."<br>
                                    &bull; Be patient and prepared to repeat yourself multiple times without frustration.<br>
                                    &bull; Do not argue, lecture, or try to reason with them logically.<br>
                                    &bull; Avoid sudden movements or loud noises that may startle them.<br>
                                    &bull; Keep extra distance&mdash;impaired individuals are more unpredictable.<br>
                                    &bull; Call for backup early rather than trying to manage alone.
                                </div>
                            </div>
                            <div class="scenario-card">
                                <div class="scenario-title">&#x1F615; Scenario 3: Person in Mental Health Crisis</div>
                                <div class="scenario-desc">
                                    <strong>Situation:</strong> A person is experiencing a mental health episode&mdash;they may be disoriented, paranoid, hearing voices, or disconnected from reality.<br><br>
                                    <strong>Your Approach:</strong><br>
                                    &bull; No sudden moves&mdash;approach slowly and announce your presence.<br>
                                    &bull; Speak gently, slowly, and in short sentences.<br>
                                    &bull; Do NOT argue with delusions or try to convince them their perceptions are wrong.<br>
                                    &bull; Focus on their feelings, not the content: "You seem scared. I'm here to help you feel safe."<br>
                                    &bull; Reduce environmental stimulation (noise, crowds, bright lights) if possible.<br>
                                    &bull; Call for specialized backup&mdash;crisis intervention team, mental health professional, or EMS.<br>
                                    &bull; Be prepared for the situation to take time. Patience is essential.
                                </div>
                            </div>
                        </div>

                        <div class="info-box">
                            <div class="info-box-title">&#x1F4A1; Universal Rule</div>
                            <div class="info-box-content">
                                <strong>In every scenario, your safety comes first.</strong> If at any point you feel physically threatened or the situation is beyond your ability to manage, disengage and call for help. There is no shame in requesting backup&mdash;it is the professional and smart response.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 9: What NOT to Do -->
            <div class="slide" data-slide="9">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 9 of 12</div>
                        <h2 class="slide-title">What NOT to Do</h2>
                        <p class="slide-subtitle">Common mistakes that make things worse</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>Knowing what NOT to do is just as important as knowing what to do.</strong> These common mistakes can rapidly escalate a situation from tense to dangerous.</p>

                        <div class="warning-grid">
                            <div class="warning-card">
                                <div class="warning-title">&#x274C; Arguing Back</div>
                                <div class="warning-desc">
                                    Never engage in a back-and-forth argument. You will not "win" a debate with someone in an emotional state. Every counter-point you make fuels their agitation.
                                </div>
                            </div>
                            <div class="warning-card">
                                <div class="warning-title">&#x274C; Saying "Calm Down"</div>
                                <div class="warning-desc">
                                    These two words have never calmed anyone in the history of human conflict. It feels dismissive and condescending. It tells the person their emotions are not valid.
                                </div>
                            </div>
                            <div class="warning-card">
                                <div class="warning-title">&#x274C; Invading Personal Space</div>
                                <div class="warning-desc">
                                    Getting too close triggers the fight-or-flight response. An agitated person will perceive you as a physical threat. Always maintain the reactive gap.
                                </div>
                            </div>
                            <div class="warning-card">
                                <div class="warning-title">&#x274C; Making Threats</div>
                                <div class="warning-desc">
                                    "If you don't stop, I'll call the police" or "You're going to get yourself in trouble." Threats create desperation and cornered feelings, which dramatically increase the chance of violence.
                                </div>
                            </div>
                            <div class="warning-card">
                                <div class="warning-title">&#x274C; Showing Fear or Anxiety</div>
                                <div class="warning-desc">
                                    If you visibly panic, the person may perceive weakness and become emboldened, or their own anxiety may spike. Project calm confidence even when you do not feel it inside.
                                </div>
                            </div>
                            <div class="warning-card">
                                <div class="warning-title">&#x274C; Ignoring Warning Signs</div>
                                <div class="warning-desc">
                                    Clenched fists, pacing, red face, target glances&mdash;these are telling you the person is approaching crisis. Do not dismiss these signals. Adjust your approach or disengage.
                                </div>
                            </div>
                            <div class="warning-card">
                                <div class="warning-title">&#x274C; Trying to Be a Hero Alone</div>
                                <div class="warning-desc">
                                    You do not have to handle every situation by yourself. Calling for backup is smart, not weak. Two calm people are more effective than one overwhelmed person.
                                </div>
                            </div>
                            <div class="warning-card">
                                <div class="warning-title">&#x274C; Taking It Personally</div>
                                <div class="warning-desc">
                                    The person's anger is usually not about you. They are reacting to a situation, a need, or a perception. Do not let their words hook your ego. Stay professional and detached.
                                </div>
                            </div>
                        </div>

                        <div class="info-box danger">
                            <div class="info-box-title">&#x1F6A8; The Golden Rule of De-Escalation</div>
                            <div class="info-box-content">
                                <strong>If your actions or words are making the situation WORSE, stop immediately and change your approach.</strong> De-escalation is not a rigid script&mdash;it requires reading the person and adapting in real time. If what you are doing is not working, try something different.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 10: When De-Escalation Fails -->
            <div class="slide" data-slide="10">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 10 of 12</div>
                        <h2 class="slide-title">When De-Escalation Fails</h2>
                        <p class="slide-subtitle">Recognizing the point of no return</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>De-escalation is not always possible.</strong> Recognizing when verbal intervention has failed&mdash;and knowing what to do next&mdash;can save your life.</p>

                        <div class="info-box danger">
                            <div class="info-box-title">&#x1F6A8; Signs De-Escalation Has Failed</div>
                            <div class="info-box-content">
                                <strong>Disengage immediately if any of the following occur:</strong>
                                <ul>
                                    <li><strong>A weapon is produced</strong>&mdash;knife, gun, improvised weapon, or anything used as a threat</li>
                                    <li><strong>Physical attack is imminent</strong>&mdash;person squares up, raises fists, charges toward you</li>
                                    <li><strong>Person becomes unresponsive to verbal techniques</strong>&mdash;they are no longer hearing you at all</li>
                                    <li><strong>Person makes specific and credible threats</strong>&mdash;"I'm going to kill you right now"</li>
                                    <li><strong>You feel genuine fear for your safety</strong>&mdash;trust your instincts</li>
                                </ul>
                            </div>
                        </div>

                        <div class="info-box warning">
                            <div class="info-box-title">&#x26A0; Tactical Disengagement</div>
                            <div class="info-box-content">
                                <strong>How to disengage safely:</strong><br>
                                &bull; Back away slowly&mdash;never turn your back on the person<br>
                                &bull; Keep your hands up and visible as you move back<br>
                                &bull; Do not make sudden movements<br>
                                &bull; Continue speaking calmly as you disengage: "I'm going to give you some space"<br>
                                &bull; Put physical barriers between you (desk, car, door, wall)<br>
                                &bull; Move toward other people, exits, or safe areas<br>
                                &bull; Call for backup, security, or 911 as soon as safely possible
                            </div>
                        </div>

                        <div class="info-box">
                            <div class="info-box-title">&#x1F4A1; When to Call for Backup</div>
                            <div class="info-box-content">
                                <strong>Call for help BEFORE the situation reaches crisis:</strong><br>
                                &bull; When you first feel uncomfortable or uncertain<br>
                                &bull; When the person's behavior is escalating despite your efforts<br>
                                &bull; When the person mentions weapons, violence, or harming themselves<br>
                                &bull; When you are alone and the situation is unpredictable<br>
                                &bull; When the person is physically larger or more capable than you<br><br>
                                <strong>Getting help early is always the right call. Waiting too long is dangerous.</strong>
                            </div>
                        </div>

                        <div class="info-box danger">
                            <div class="info-box-title">&#x270A; Run-Hide-Fight as Last Resort</div>
                            <div class="info-box-content">
                                If the situation becomes an active threat to life:<br>
                                &bull; <strong>RUN:</strong> Evacuate if you have a safe path. Leave belongings. Help others if possible.<br>
                                &bull; <strong>HIDE:</strong> If you cannot escape, lock/barricade yourself in a room. Silence your phone. Stay quiet.<br>
                                &bull; <strong>FIGHT:</strong> Only as an absolute last resort when your life is in imminent danger. Commit fully. Use improvised weapons. Act with aggression.<br><br>
                                <strong>Your survival is the priority. Do whatever you need to do to stay alive.</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 11: After the Incident -->
            <div class="slide" data-slide="11">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 11 of 12</div>
                        <h2 class="slide-title">After the Incident</h2>
                        <p class="slide-subtitle">Recovery, reporting, and self-care</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>What you do after a de-escalation encounter matters as much as how you handled it.</strong> Proper follow-up protects you, helps your organization learn, and supports your mental health.</p>

                        <div class="after-grid">
                            <div class="after-card">
                                <div class="after-icon">&#x1F4CB;</div>
                                <div class="after-title">Report the Incident</div>
                                <div class="after-desc">Notify your supervisor, security, or HR immediately. File a formal incident report. Even "minor" encounters should be documented to establish patterns.</div>
                            </div>
                            <div class="after-card">
                                <div class="after-icon">&#x1F4DD;</div>
                                <div class="after-title">Document Details</div>
                                <div class="after-desc">Write down everything while it is fresh: what happened, what was said, who was involved, timeline, and witnesses. Details fade quickly&mdash;document within the hour if possible.</div>
                            </div>
                            <div class="after-card">
                                <div class="after-icon">&#x1F465;</div>
                                <div class="after-title">Debrief with Supervisor</div>
                                <div class="after-desc">Walk through the incident with your supervisor or team lead. Discuss what happened, what worked, what could be improved. This is a learning opportunity, not a blame session.</div>
                            </div>
                            <div class="after-card">
                                <div class="after-icon">&#x1F49A;</div>
                                <div class="after-title">Seek Support</div>
                                <div class="after-desc">Use your Employee Assistance Program (EAP), peer support, or professional counseling. Experiencing a threatening encounter is stressful. Talking about it is not weakness&mdash;it is essential.</div>
                            </div>
                            <div class="after-card">
                                <div class="after-icon">&#x1F50D;</div>
                                <div class="after-title">Review &amp; Learn</div>
                                <div class="after-desc">What worked? What did you wish you had done differently? Could the encounter have been prevented? Every incident is a chance to sharpen your skills for next time.</div>
                            </div>
                            <div class="after-card">
                                <div class="after-icon">&#x1F3E5;</div>
                                <div class="after-title">Self-Care</div>
                                <div class="after-desc">Watch for signs of stress: difficulty sleeping, replaying the event, anxiety, irritability, or hypervigilance. These are normal reactions. Take care of yourself physically and mentally in the days following.</div>
                            </div>
                        </div>

                        <div class="info-box success">
                            <div class="info-box-title">&#x2713; Remember</div>
                            <div class="info-box-content">
                                <strong>You are not expected to be perfect.</strong> De-escalation is a skill that improves with practice. Every encounter teaches you something new. The fact that you intervened verbally instead of letting a situation escalate into violence is a success, even if it was not textbook-perfect.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 12: Key Takeaways -->
            <div class="slide" data-slide="12">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Slide 12 of 12</div>
                        <h2 class="slide-title">Key Takeaways</h2>
                        <p class="slide-subtitle">Your de-escalation quick reference</p>
                    </div>
                    <div class="slide-content">
                        <p><strong>Essential de-escalation knowledge to carry with you every day:</strong></p>
                        <ul class="content-list">
                            <li><strong>Intervene early:</strong> The escalation cycle has stages&mdash;trigger, escalation, crisis, recovery, post-crisis. Verbal intervention is most effective during the escalation phase, before crisis hits.</li>
                            <li><strong>Four core principles:</strong> Stay Calm (control your emotions first), Listen Actively (hear them out), Show Empathy (acknowledge feelings), Set Boundaries (firm but respectful limits).</li>
                            <li><strong>Verbal techniques:</strong> Low/slow/steady voice, avoid trigger words like "calm down," use open-ended questions, paraphrase, offer choices instead of demands.</li>
                            <li><strong>Body language matters:</strong> Reactive gap (arm's length+), open stance, 45-degree angle, hands visible, no pointing. Your body communicates more than your words.</li>
                            <li><strong>Use the LEAP method:</strong> Listen, Empathize, Agree (find common ground), Partner (work together toward a solution).</li>
                            <li><strong>Adapt to the scenario:</strong> Angry individuals need validation, intoxicated persons need simple language, mental health crises require patience and specialized backup.</li>
                            <li><strong>Avoid common mistakes:</strong> Never argue back, say "calm down," invade space, make threats, show fear, ignore warning signs, or try to be a hero alone.</li>
                            <li><strong>Know when to disengage:</strong> If a weapon appears, physical attack is imminent, or the person is no longer responsive to verbal techniques&mdash;disengage, create distance, call for help.</li>
                            <li><strong>After every incident:</strong> Report, document, debrief, seek support, review what you learned, and take care of yourself.</li>
                        </ul>

                        <div class="info-box success">
                            <div class="info-box-title">&#x2713; DO's and DON'Ts Quick Reference</div>
                            <div class="info-box-content">
                                <strong>DO:</strong> Stay calm, listen, empathize, offer choices, maintain distance, keep hands open, call for backup when needed.<br><br>
                                <strong>DON'T:</strong> Argue, say "calm down," invade space, make threats, point fingers, match their volume, try to handle everything alone.
                            </div>
                        </div>

                        <div class="katie-message">
                            <img src="katie.png" alt="Katie" class="katie-avatar">
                            <div class="katie-bubble">
                                <div class="katie-name">Katie, Your Safety Guide</div>
                                <div class="katie-text">
                                    Great work making it through this module! De-escalation is a skill that gets better with practice. Remember: your calm is your superpower. When everyone else is losing control, your ability to stay steady and communicate effectively can prevent violence and save lives. Stay safe, stay calm, and stay in control. Now let's check your knowledge!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Quiz Question 1 -->
            <div class="slide" data-slide="13">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Quiz Question 1 of 3</div>
                        <h2 class="slide-title">Knowledge Check</h2>
                    </div>
                    <div class="slide-content">
                        <div class="quiz-question">
                            A visibly agitated person is raising their voice and making verbal threats. What is your FIRST priority?
                        </div>
                        <div class="quiz-options" id="q1-options">
                            <div class="quiz-option" data-q="1" data-val="A">Match their volume to show authority</div>
                            <div class="quiz-option" data-q="1" data-val="B">Maintain a calm tone, create distance, and actively listen to their concerns</div>
                            <div class="quiz-option" data-q="1" data-val="C">Immediately call law enforcement</div>
                            <div class="quiz-option" data-q="1" data-val="D">Tell them to calm down or they'll be removed</div>
                        </div>
                        <div class="quiz-feedback" id="fb-1"></div>
                        <div class="quiz-btn-group">
                            <button class="btn btn-gold" id="submit-1" onclick="submitQuiz(1)" disabled>Submit Answer</button>
                            <button class="btn btn-outline" id="next-q-1" onclick="nextSlide()" style="display: none;">Next Question &#x2192;</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Quiz Question 2 -->
            <div class="slide" data-slide="14">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Quiz Question 2 of 3</div>
                        <h2 class="slide-title">Knowledge Check</h2>
                    </div>
                    <div class="slide-content">
                        <div class="quiz-question">
                            Which body language technique is MOST important during a de-escalation encounter?
                        </div>
                        <div class="quiz-options" id="q2-options">
                            <div class="quiz-option" data-q="2" data-val="A">Crossing your arms to show you won't back down</div>
                            <div class="quiz-option" data-q="2" data-val="B">Standing directly face-to-face to show engagement</div>
                            <div class="quiz-option" data-q="2" data-val="C">Maintaining a reactive gap and positioning at a 45-degree angle with open hands</div>
                            <div class="quiz-option" data-q="2" data-val="D">Avoiding all eye contact to appear non-threatening</div>
                        </div>
                        <div class="quiz-feedback" id="fb-2"></div>
                        <div class="quiz-btn-group">
                            <button class="btn btn-gold" id="submit-2" onclick="submitQuiz(2)" disabled>Submit Answer</button>
                            <button class="btn btn-outline" id="next-q-2" onclick="nextSlide()" style="display: none;">Next Question &#x2192;</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Quiz Question 3 -->
            <div class="slide" data-slide="15">
                <div class="content-card">
                    <div class="slide-header">
                        <div class="slide-number">Quiz Question 3 of 3</div>
                        <h2 class="slide-title">Knowledge Check</h2>
                    </div>
                    <div class="slide-content">
                        <div class="quiz-question">
                            During a de-escalation attempt, the individual suddenly produces a weapon. What should you do?
                        </div>
                        <div class="quiz-options" id="q3-options">
                            <div class="quiz-option" data-q="3" data-val="A">Continue attempting to talk them down &mdash; never abandon de-escalation</div>
                            <div class="quiz-option" data-q="3" data-val="B">Try to take the weapon away quickly before they can use it</div>
                            <div class="quiz-option" data-q="3" data-val="C">Immediately disengage, create distance, and follow your emergency response protocol</div>
                            <div class="quiz-option" data-q="3" data-val="D">Stand your ground and call for backup while maintaining visual contact</div>
                        </div>
                        <div class="quiz-feedback" id="fb-3"></div>
                        <div class="quiz-btn-group">
                            <button class="btn btn-gold" id="submit-3" onclick="submitQuiz(3)" disabled>Submit Answer</button>
                            <button class="btn btn-outline" id="next-q-3" onclick="nextSlide()" style="display: none;">View Results &#x2192;</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Slide 16: Results -->
            <div class="slide" data-slide="16">
                <div class="results-card">
                    <div class="results-icon" id="rIcon">&#x1F3AF;</div>
                    <div class="results-score" id="rScore">0 / 3</div>
                    <h2 class="results-title" id="rTitle">Quiz Complete</h2>
                    <p class="results-message" id="rMsg">Calculating your results...</p>
                    <div class="results-katie" id="rKatie">"Let's see how you did!"</div>
                    <div class="results-buttons" id="rBtns">
                        <button class="btn btn-gold">Loading...</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-inner">
            <button class="nav-btn" id="prevBtn" onclick="prevSlide()">
                &#x2190; Previous
            </button>
            <span class="slide-indicator" id="slideIndicator">Slide 1 of 12</span>
            <button class="nav-btn nav-next" id="nextBtn" onclick="nextSlide()">
                Next &#x2192;
            </button>
        </div>
    </nav>
    <script>
    (function() {
        'use strict';
        // ═══ CONFIG ═══
        var TOTAL_SLIDES = 16;
        var TOTAL_CONTENT = 12;
        var MODULE_KEY = 'de-escalation';
        // ═══ STATE ═══
        var currentSlide = 1;
        var quizAnswers = { 1: null, 2: null, 3: null };
        var quizSubmitted = { 1: false, 2: false, 3: false };
        var quizScore = 0;
        // Quiz correct answers
        var quizCorrectAnswers = {
            1: 'B',  // Maintain calm tone, create distance, actively listen
            2: 'C',  // Reactive gap, 45-degree angle, open hands
            3: 'C'   // Immediately disengage, create distance, follow emergency protocol
        };
        // Feedback messages
        var feedbackMessages = {
            1: {
                correct: '\u2713 Correct! Your first priority is to stay calm yourself, maintain a safe distance, and actively listen to their concerns. Matching their volume or telling them to "calm down" will only escalate the situation.',
                incorrect: '\u2717 Incorrect. Your first priority is to maintain a calm tone, create distance for safety, and actively listen to their concerns. Matching volume, demanding they calm down, or immediately calling police can all escalate the situation further.'
            },
            2: {
                correct: '\u2713 Correct! Maintaining a reactive gap (arm\'s length or more) and positioning at a 45-degree angle with open, visible hands is the most important body language technique. It keeps you safe while appearing non-threatening.',
                incorrect: '\u2717 Incorrect. The most important body language technique is maintaining a reactive gap and positioning at a 45-degree angle with open hands. Crossed arms appear defensive, face-to-face is confrontational, and avoiding all eye contact can seem dismissive.'
            },
            3: {
                correct: '\u2713 Correct! When a weapon appears, de-escalation is over. Immediately disengage, create as much distance as possible, and follow your emergency response protocol (Run-Hide-Fight). Your survival is the priority.',
                incorrect: '\u2717 Incorrect. When a weapon is produced, you must immediately disengage and create distance. Continuing to talk, attempting to take the weapon, or standing your ground all put your life at extreme risk. Follow your emergency response protocol.'
            }
        };
        // ═══ NAVIGATION ═══
        function goToSlide(n) {
            if (n < 1 || n > TOTAL_SLIDES) return;
            currentSlide = n;
            updateUI();
            saveSlideProgress();
        }
        window.nextSlide = function() {
            goToSlide(currentSlide + 1);
        };
        window.prevSlide = function() {
            goToSlide(currentSlide - 1);
        };
        // ═══ UI UPDATE ═══
        function updateUI() {
            document.querySelectorAll('.slide').forEach(function(s) {
                s.classList.remove('active');
            });
            var activeSlide = document.querySelector('[data-slide="' + currentSlide + '"]');
            if (activeSlide) {
                activeSlide.classList.add('active');
            }
            var progressPct = ((currentSlide - 1) / (TOTAL_CONTENT - 1)) * 100;
            document.getElementById('progressFill').style.width = Math.min(100, progressPct) + '%';
            document.getElementById('progressPct').textContent = Math.round(Math.min(100, progressPct)) + '%';

            if (currentSlide <= TOTAL_CONTENT) {
                document.getElementById('progressLabel').textContent = 'Slide ' + currentSlide + ' of ' + TOTAL_CONTENT;
                document.getElementById('slideIndicator').textContent = 'Slide ' + currentSlide + ' of ' + TOTAL_CONTENT;
            } else {
                document.getElementById('progressLabel').textContent = 'Results';
                document.getElementById('slideIndicator').textContent = 'Results';
            }
            var prevBtn = document.getElementById('prevBtn');
            var nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentSlide === 1;
            nextBtn.disabled = currentSlide === TOTAL_SLIDES;
            if (currentSlide === 16) {
                buildResults();
            }
            document.querySelector('.content-wrapper').scrollTop = 0;
        }
        // ═══ KEYBOARD NAV ═══
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.key === 'ArrowRight' || e.key === 'Right') {
                e.preventDefault();
                nextSlide();
            } else if (e.key === 'ArrowLeft' || e.key === 'Left') {
                e.preventDefault();
                prevSlide();
            }
        });
        // ═══ QUIZ HANDLING ═══
        document.querySelectorAll('.quiz-option').forEach(function(opt) {
            opt.addEventListener('click', function() {
                var qNum = parseInt(this.getAttribute('data-q'));
                if (quizSubmitted[qNum]) return;
                var container = document.getElementById('q' + qNum + '-options');
                container.querySelectorAll('.quiz-option').forEach(function(o) {
                    o.classList.remove('selected');
                });
                this.classList.add('selected');
                quizAnswers[qNum] = this.getAttribute('data-val');
                document.getElementById('submit-' + qNum).disabled = false;
            });
        });
        window.submitQuiz = function(qNum) {
            if (quizSubmitted[qNum]) return;
            quizSubmitted[qNum] = true;
            var userAnswer = quizAnswers[qNum];
            var correctAnswer = quizCorrectAnswers[qNum];
            var isCorrect = (userAnswer === correctAnswer);
            var container = document.getElementById('q' + qNum + '-options');
            container.querySelectorAll('.quiz-option').forEach(function(opt) {
                opt.classList.add('disabled');
                var val = opt.getAttribute('data-val');
                if (val === correctAnswer) {
                    opt.classList.add('correct');
                } else if (opt.classList.contains('selected') && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });
            var fb = document.getElementById('fb-' + qNum);
            if (isCorrect) {
                fb.textContent = feedbackMessages[qNum].correct;
                fb.className = 'quiz-feedback show correct-fb';
                quizScore++;
            } else {
                fb.textContent = feedbackMessages[qNum].incorrect;
                fb.className = 'quiz-feedback show incorrect-fb';
            }
            document.getElementById('submit-' + qNum).style.display = 'none';
            document.getElementById('next-q-' + qNum).style.display = '';
        };
        // ═══ BUILD RESULTS ═══
        function buildResults() {
            var icon = document.getElementById('rIcon');
            var score = document.getElementById('rScore');
            var title = document.getElementById('rTitle');
            var msg = document.getElementById('rMsg');
            var btns = document.getElementById('rBtns');
            var katie = document.getElementById('rKatie');
            score.textContent = quizScore + ' / 3';
            if (quizScore === 3) {
                icon.textContent = '\uD83C\uDF89';
                title.textContent = 'Perfect Score!';
                msg.textContent = 'Outstanding! You have mastered the core principles of de-escalation, verbal techniques, body language, and knowing when to disengage. You are ready to keep people safe!';
                btns.innerHTML = '<button class="btn btn-success" onclick="completeModule()">\u2713 Complete Module & Return to Dashboard</button>';
                katie.textContent = '"Incredible work! Remember: Stay calm, listen actively, use LEAP, and always trust your instincts when it\'s time to disengage."';
            } else if (quizScore >= 2) {
                icon.textContent = '\u2705';
                title.textContent = 'You Passed!';
                msg.textContent = 'Great job! You demonstrated solid understanding of de-escalation techniques and emergency response principles.';
                btns.innerHTML = '<button class="btn btn-success" onclick="completeModule()">\u2713 Complete Module & Return to Dashboard</button>';
                katie.textContent = '"Well done! Keep practicing your verbal techniques, maintain that reactive gap, and remember\u2014your calm is your superpower!"';
            } else {
                icon.textContent = '\uD83D\uDCDA';
                title.textContent = 'Not Quite Yet';
                msg.textContent = 'You need 2 out of 3 correct to pass this module. Review the lesson and try again!';
                btns.innerHTML = '<button class="btn btn-gold" onclick="retakeQuiz()">\u21BB Retake Quiz</button>' +
                    '<button class="btn btn-outline" onclick="goToSlide(3)">\u2191 Review Lesson</button>';
                katie.textContent = '"Don\'t worry! De-escalation takes practice. Review the LEAP method, body language techniques, and when to disengage, then try again!"';
            }
            saveQuizProgress();
        }
        // ═══ RETAKE QUIZ ═══
        window.retakeQuiz = function() {
            quizAnswers = { 1: null, 2: null, 3: null };
            quizSubmitted = { 1: false, 2: false, 3: false };
            quizScore = 0;
            for (var q = 1; q <= 3; q++) {
                var container = document.getElementById('q' + q + '-options');
                container.querySelectorAll('.quiz-option').forEach(function(opt) {
                    opt.classList.remove('selected', 'correct', 'incorrect', 'disabled');
                });
                document.getElementById('fb-' + q).className = 'quiz-feedback';
                document.getElementById('fb-' + q).textContent = '';
                document.getElementById('submit-' + q).style.display = '';
                document.getElementById('submit-' + q).disabled = true;
                document.getElementById('next-q-' + q).style.display = 'none';
            }
            goToSlide(13);
        };
        // ═══ LOCAL STORAGE ═══
        function getProgress() {
            try {
                var d = localStorage.getItem('safetyverse-progress');
                return d ? JSON.parse(d) : {};
            } catch(e) { return {}; }
        }

        // ─── SUPABASE SYNC ───
        var MODULE_NAME = 'De-Escalation Techniques';
        function getSB() { return getSafetyVerseSupabase(); }
        function syncProgressToSupabase(completed, score, attempts) {
            try {
                var sb = getSB();
                if (!sb) return;
                var empName = (window.__svUser && window.__svUser.fullName) || 'Unknown';
                var dept = (window.__svUser && window.__svUser.department) || 'Unassigned';
                var moduleSlug = 'de-escalation';
                var row = {
                    user_id: (window.__svUser && window.__svUser.id) || null,
                    employee_name: empName,
                    department: dept,
                    module_slug: moduleSlug,
                    module_name: MODULE_NAME,
                    completed: !!completed,
                    quiz_score: score || 0,
                    attempts: attempts || 0,
                    last_activity: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                if (completed) row.completed_at = new Date().toISOString();
                sb.from('module_progress')
                    .upsert(row, { onConflict: 'employee_name,module_slug' })
                    .then(function(res) {
                        if (res.error) console.warn('Supabase sync error:', res.error.message);
                    });
            } catch(e) { console.warn('Supabase sync failed:', e); }
        }
        function saveSlideProgress() {
            try {
                var p = getProgress();
                if (!p.modules) p.modules = {};
                if (!p.modules[MODULE_KEY]) {
                    p.modules[MODULE_KEY] = { completed: false, quizScore: 0, attempts: 0, lastAttempt: null };
                }
                p.modules[MODULE_KEY].currentSlide = currentSlide;
                p.modules[MODULE_KEY].totalSlides = TOTAL_SLIDES;
                localStorage.setItem('safetyverse-progress', JSON.stringify(p));
            } catch(e) {}
        }
        function saveQuizProgress() {
            try {
                var p = getProgress();
                if (!p.modules) p.modules = {};
                if (!p.modules[MODULE_KEY]) {
                    p.modules[MODULE_KEY] = { completed: false, quizScore: 0, attempts: 0 };
                }
                var mod = p.modules[MODULE_KEY];
                mod.quizScore = quizScore;
                mod.attempts = (mod.attempts || 0) + 1;
                mod.lastAttempt = new Date().toISOString();
                if (quizScore >= 2) mod.completed = true;
                localStorage.setItem('safetyverse-progress', JSON.stringify(p));
                syncProgressToSupabase(quizScore >= 2, quizScore, mod.attempts);
            } catch(e) {}
        }
        window.completeModule = function() {
            try {
                var p = getProgress();
                if (!p.modules) p.modules = {};
                if (!p.modules[MODULE_KEY]) {
                    p.modules[MODULE_KEY] = { quizScore: 0, attempts: 0 };
                }
                p.modules[MODULE_KEY].completed = true;
                p.modules[MODULE_KEY].completedAt = new Date().toISOString();
                p.modules[MODULE_KEY].quizScore = quizScore;
                localStorage.setItem('safetyverse-progress', JSON.stringify(p));
                syncProgressToSupabase(true, quizScore, (p.modules[MODULE_KEY] && p.modules[MODULE_KEY].attempts) || 1);
            } catch(e) {}
            window.location.href = '../../user-dashboard/index.html';
        };
        // ═══ RESTORE PROGRESS ON LOAD ═══
        function restoreProgress() {
            try {
                var p = getProgress();
                if (p.modules && p.modules[MODULE_KEY]) {
                    var mod = p.modules[MODULE_KEY];
                    if (mod.completed) {
                        var introCard = document.querySelector('.intro-card');
                        if (introCard) {
                            var badge = document.createElement('div');
                            badge.style.cssText = 'position:absolute;top:20px;right:20px;background:var(--success);color:white;font-size:12px;font-weight:700;padding:5px 16px;border-radius:20px;z-index:5;';
                            badge.textContent = '\u2713 Completed';
                            introCard.appendChild(badge);
                        }
                    }
                }
            } catch(e) {}
        }
        // ═══ INIT ═══
        restoreProgress();
        updateUI();
    })();
    </script>
</body>
</html>
